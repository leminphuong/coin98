<?php
/**
 * Plugin Name: My API Plugin
 * Description: REST API cho t·∫°o b√†i vi·∫øt, danh s√°ch danh m·ª•c, b√†i vi·∫øt theo danh m·ª•c, tag, chi ti·∫øt b√†i vi·∫øt, ACF Options, v√† c√°c danh s√°ch theo tag c·ª• th·ªÉ.
 * Version: 2.3
 * Author: Your Name
 */
// T·ª∑ gi√° quy ƒë·ªïi (c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh)
define('USD_TO_VND', 20000); // 1 USD = 25,000 VND
define('USD_TO_IDR', 15000); // 1 USD = 15,500 IDR

if (!defined('ABSPATH')) exit;
function format_money($amount, $currency) {
    switch ($currency) {
        case 'VND':
            return number_format($amount, 0, ',', '.') . ' ‚Ç´';
        case 'IDR':
            return 'Rp ' . number_format($amount, 0, ',', '.');
        default:
            return '$' . number_format($amount, 2);
    }
}

add_action('init', function () {
    // ƒêƒÉng k√Ω CPT: game-mobile
    register_post_type('game-mobile', [
        'labels' => [
            'name'          => 'Game Mobile',
            'singular_name' => 'Game Mobile',
            'menu_name'     => 'Game Mobile',
            'add_new_item'  => 'Th√™m game m·ªõi',
            'edit_item'     => 'S·ª≠a game',
            'all_items'     => 'T·∫•t c·∫£ game',
        ],
        'public'      => true,
        'show_ui'     => true,
        'show_in_menu'=> true,
        'menu_icon'   => 'dashicons-smartphone',
        'supports'    => ['title','editor','thumbnail','excerpt','revisions'],
        'has_archive' => true,
        'rewrite'     => ['slug'=>'game-mobile'],
        'show_in_rest'=> true, // h·ªó tr·ª£ Gutenberg & API
    ]);

    // ƒêƒÉng k√Ω taxonomy: game_genre
    register_taxonomy('game_genre',['game-mobile'],[
        'labels'=>[
            'name'=>'Game Genres',
            'singular_name'=>'Game Genre'
        ],
        'hierarchical'=>true,
        'show_ui'=>true,
        'show_in_rest'=>true,
        'rewrite'=>['slug'=>'game-genre']
    ]);
});

// 1Ô∏è‚É£ ƒêƒÉng k√Ω post type Embed
function register_embed_post_type() {
    $labels = array(
        'name'               => __('Embeds', 'embed-post-type'),
        'singular_name'      => __('Embed', 'embed-post-type'),
        'menu_name'          => __('Embeds', 'embed-post-type'),
        'add_new'            => __('Add New', 'embed-post-type'),
        'add_new_item'       => __('Add New Embed', 'embed-post-type'),
        'edit_item'          => __('Edit Embed', 'embed-post-type'),
        'new_item'           => __('New Embed', 'embed-post-type'),
        'view_item'          => __('View Embed', 'embed-post-type'),
        'search_items'       => __('Search Embeds', 'embed-post-type'),
        'not_found'          => __('No embeds found', 'embed-post-type'),
        'not_found_in_trash' => __('No embeds found in trash', 'embed-post-type'),
    );
    $args = array(
        'label'               => __('Embeds', 'embed-post-type'),
        'labels'              => $labels,
        'public'              => false, // kh√¥ng public ra ngo√†i
        'show_ui'             => true,  // v·∫´n hi·ªán trong admin
        'show_in_menu'        => true,
        'exclude_from_search' => true,
        'publicly_queryable'  => false, // t·∫Øt truy c·∫≠p single
        'has_archive'         => false,
        'rewrite'             => false, // kh√¥ng t·∫°o slug URL
        'supports'            => array('title', 'excerpt', 'thumbnail'),
        'show_in_rest'        => true,
        'menu_icon'           => 'dashicons-media-code',
		 'taxonomies'          => array('category') 
    );

    register_post_type('embed_post', $args);
}
add_action('init', 'register_embed_post_type');

// 2Ô∏è‚É£ T√πy ch·ªânh permalink ƒë·ªÉ kh√¥ng c√≥ slug v√† k·∫øt th√∫c b·∫±ng `.embed`
function embed_post_permalink($post_link, $post) {
    if ($post->post_type === 'embed_post') {
        return home_url($post->post_name . '.embed');
    }
    return $post_link;
}
add_filter('post_type_link', 'embed_post_permalink', 10, 2);

// 3Ô∏è‚É£ Th√™m rewrite rule ƒë·ªÉ h·ªó tr·ª£ `.embed`
function embed_post_rewrite_rules($rules) {
    $new_rules = array(
        '([^/]+)\.embed/?$' => 'index.php?embed_post=$matches[1]',
    );
    return $new_rules + $rules;
}
add_filter('rewrite_rules_array', 'embed_post_rewrite_rules');

// 4Ô∏è‚É£ Flush rewrite rules khi plugin k√≠ch ho·∫°t
function flush_embed_post_rewrite_rules() {
    register_embed_post_type();
    flush_rewrite_rules();
}
register_activation_hook(__FILE__, 'flush_embed_post_rewrite_rules');

// 5Ô∏è‚É£ Flush rewrite rules khi plugin b·ªã deactivate
function deactivate_embed_post_plugin() {
    flush_rewrite_rules();
}
register_deactivation_hook(__FILE__, 'deactivate_embed_post_plugin');


function game_item($post_id) {
    // L·∫•y field screenshots (ACF gallery)
    $screenshots = get_field('screenshots', $post_id);
    $first_image = '';
    if (is_array($screenshots) && !empty($screenshots)) {
        $first_image = $screenshots[0]['url'] ?? '';
    }

    // L·∫•y description t·ª´ content
    $descripcion_raw   = get_the_content(null, false, $post_id);
    $descripcion_clean = wp_strip_all_tags($descripcion_raw);
    $descripcion_clean = preg_replace("/\n{2,}/", "\n", $descripcion_clean);
    $descripcion_clean = preg_replace("/(\s*\n\s*){2,}/", "\n", $descripcion_clean);

    // Chu·∫©n ho√° slug name (b·ªè ch·ªØ "mod" n·∫øu c√≥)
    $name = get_post_field('post_name', $post_id);
    $name = preg_replace('/\bmod\b/i', '', $name);
    $name = trim(str_replace('--', '-', $name), '-');

    // === Generate tags t·ª´ ti√™u ƒë·ªÅ ===
    $post_title = get_the_title($post_id);

    // Xo√° ch·ªØ Download v√† free on android
    $post_title = preg_replace('/^download\s+/i', '', $post_title);
    $post_title = preg_replace('/free on android/i', '', $post_title);

$tags_array = [];

if ( preg_match('/\((.*?)\)/', $post_title, $matches) ) {
    // L·∫•y n·ªôi dung trong ngo·∫∑c
    $inside = preg_replace('/\bmod\b/i', '', $matches[1]); // b·ªè ch·ªØ MOD
    $tags_array = preg_split('/[\s,]+/', $inside, -1, PREG_SPLIT_NO_EMPTY);
} else {
    // Kh√¥ng c√≥ ngo·∫∑c th√¨ l·∫•y t·ª´ ti√™u ƒë·ªÅ
    $clean_title = preg_replace('/\bmod\b/i', '', $post_title);
    $tags_array  = preg_split('/\s+/', $clean_title, -1, PREG_SPLIT_NO_EMPTY);
}

// Gh√©p tags b·∫±ng kho·∫£ng tr·∫Øng, vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
$tags = implode(' ', array_map('ucwords', $tags_array));



    return [
        'id'    => $post_id,
        'name'  => $name,
        'title' => trim(
            preg_replace(
                [
                    '/^download\s+/i',          // b·ªè "Download" ƒë·∫ßu d√≤ng
                    '/\s*\(.*?\)\s*/',          // b·ªè ƒëo·∫°n trong ngo·∫∑c (...)
                    '/\s*free on android\s*/i', // b·ªè "free on android"
                    '/\d+(\.\d+)*/',            // b·ªè s·ªë version / nƒÉm
                ],
                '',
                get_the_title($post_id)
            )
        ),

        'link'  => get_permalink($post_id),
        'image' => get_the_post_thumbnail_url($post_id, 'thumbnail'),

        'rank'  => get_field('rating', $post_id) ?: '4.5',
        'views' => get_field('votes', $post_id) ?: '0',

        'tags'  => $tags,
        'date'  => get_the_date('Y-m-d', $post_id),

        'image_thumb' => $first_image,
        'desc'        => $descripcion_clean,
        'first_image' => $first_image,
        'image_full'  => $first_image,
    ];
}



add_action('rest_api_init', function () {

    
// H√†m l√†m s·∫°ch ti√™u ƒë·ªÅ
function clean_post_title($title) {
    return trim(
        preg_replace(
            [
                '/^download\s+/i',          // b·ªè "Download" ·ªü ƒë·∫ßu
                '/\s*free on android\s*/i', // b·ªè c·ª•m "free on android"
            ],
            '',
            $title
        )
    );
}

/**
 * API Search
 */
register_rest_route('custom-api/v1', '/search', [
    'methods' => 'GET',
    'callback' => function ($request) {
        global $wpdb;

        $query = trim(mb_strtolower(sanitize_text_field($request->get_param('query'))));
        $lang  = sanitize_text_field($request->get_param('lang')) ?: '';
        $posts = [];

        if ($query === '') {
            return new WP_REST_Response([
                'query'   => '',
                'lang'    => $lang,
                'results' => []
            ], 200);
        }

        // ƒêa ng√¥n ng·ªØ WPML
        if ($lang !== '' && function_exists('icl_object_id')) {
            do_action('wpml_switch_language', $lang);
        }

        // SQL: ch·ªâ t√¨m trong post_title
        $like = '%' . $wpdb->esc_like($query) . '%';
        $sql  = $wpdb->prepare("
            SELECT ID, post_title, post_name, post_type, post_date
            FROM {$wpdb->posts}
            WHERE post_status = 'publish'
              AND post_type IN ('game-mobile','embed_post')
              AND post_title LIKE %s
            ORDER BY post_date DESC
            LIMIT 50
        ", $like);

        $results = $wpdb->get_results($sql);

        foreach ($results as $post) {
            $id    = $post->ID;
            $slug  = $post->post_name;

            // Title clean
            $title_clean = clean_post_title($post->post_title);

            // Rating
            if ($post->post_type === 'game-mobile') {
                $rank = get_field('rating', $id);
            } else {
                $rank = get_post_meta($id, 'rating', true) / 2;
            }
            $rank = $rank ? (string) $rank : '';

            // Views
            $views = (string) get_post_meta($id, 'views', true);

            // Tags
            $tags = '';
            if ($post->post_type === 'game-mobile') {
                if (preg_match('/\((.*?)\)/', $post->post_title, $m)) {
                    $tags = trim($m[1]);
                }
            } else {
                $tags = "Game online";
            }

            // Date
            $date = date('Y-m-d', strtotime($post->post_date));

            // Image thumb + full
            $thumb = get_the_post_thumbnail_url($id, 'thumbnail') ?: '';
            $full  = get_the_post_thumbnail_url($id, 'full') ?: '';

            // First image trong content
            $content = get_post_field('post_content', $id);
            if (preg_match('/<img[^>]+src="([^">]+)"/i', $content, $img_match)) {
                $first_image = $img_match[1];
            } else {
                $first_image = $full;
            }

            $posts[] = [
                'id'          => $id,
                'name'        => $slug,
                'title'       => $title_clean,
                'link'        => get_permalink($id),
                'image'       => $thumb,
                'image_full'  => $full,
                'rank'        => $rank,
                'tags'        => $tags,
                'date'        => $date,
                'first_image' => $first_image,
                'url'         => get_field('iframe', $id),
                'direction'   => get_field('direction', $id) ?: 'Horizontal',
            ];
        }

        return new WP_REST_Response([
            'query'   => $query,
            'lang'    => $lang,
            'results' => $posts
        ], 200);
    },
    'permission_callback' => '__return_true'
]);

/**
 * API Suggest
 */
register_rest_route('custom-api/v1', '/suggest', [
    'methods' => 'GET',
    'callback' => function ($request) {
        global $wpdb;

        $query = trim(mb_strtolower(sanitize_text_field($request->get_param('query'))));
        $lang  = sanitize_text_field($request->get_param('lang')) ?: '';
        $suggestions = [];

        if ($query === '') {
            return new WP_REST_Response([
                'query'       => '',
                'lang'        => $lang,
                'suggestions' => []
            ], 200);
        }

        // WPML ƒëa ng√¥n ng·ªØ
        if ($lang !== '' && function_exists('icl_object_id')) {
            do_action('wpml_switch_language', $lang);
        }

        // SQL: clean lu√¥n post_title
        $like = '%' . $wpdb->esc_like($query) . '%';
        $sql  = $wpdb->prepare("
            SELECT DISTINCT
                TRIM(
                    REPLACE(
                        REGEXP_REPLACE(post_title, '^download[[:space:]]+', ''),
                        'free on android', ''
                    )
                ) AS post_title_clean
            FROM {$wpdb->posts}
            WHERE post_status = 'publish'
              AND post_type IN ('game-mobile','embed_post')
              AND (
                    post_title LIKE %s
                 OR REPLACE(
                        REGEXP_REPLACE(post_title, '^download[[:space:]]+', ''),
                        'free on android', ''
                    ) LIKE %s
              )
            ORDER BY post_date DESC
            LIMIT 50
        ", $like, $like);

        $results = $wpdb->get_results($sql);

        foreach ($results as $row) {
            $title_clean = trim(preg_split('/\(/', $row->post_title_clean)[0]);

            if ($title_clean !== '' && !in_array($title_clean, $suggestions, true)) {
                $suggestions[] = $title_clean;
            }
        }

        return new WP_REST_Response([
            'query'       => $query,
            'lang'        => $lang,
            'suggestions' => $suggestions
        ], 200);
    },
    'permission_callback' => '__return_true',
]);


register_rest_route('custom-api/v1', '/suggest-debug', [
    'methods' => 'GET',
    'callback' => function ($request) {
        global $wpdb;

        $query = trim(mb_strtolower(sanitize_text_field($request->get_param('query'))));
        $lang  = sanitize_text_field($request->get_param('lang')) ?: '';
        $suggestions = [];
        $debug = [];

        $debug['input'] = [
            'query' => $query,
            'lang'  => $lang,
        ];

        if ($query === '') {
            return new WP_REST_Response([
                'status'       => 'empty_query',
                'debug'        => $debug,
                'suggestions'  => []
            ], 200);
        }

        // WPML ƒëa ng√¥n ng·ªØ
        if ($lang !== '' && function_exists('icl_object_id')) {
            do_action('wpml_switch_language', $lang);
            $debug['wpml'] = "Switched to lang: {$lang}";
        } else {
            $debug['wpml'] = "No WPML switch";
        }

        // SQL: b·ªè ƒëi·ªÅu ki·ªán post_status = 'publish' => l·∫•y t·∫•t c·∫£ tr·∫°ng th√°i
        $like = '%' . $wpdb->esc_like($query) . '%';
        $sql  = $wpdb->prepare("
            SELECT DISTINCT
                TRIM(
                    REPLACE(
                        REGEXP_REPLACE(post_title, '^download[[:space:]]+', ''),
                        'free on android', ''
                    )
                ) AS post_title_clean,
                post_status
            FROM {$wpdb->posts}
            WHERE post_type IN ('game-mobile','embed_post')
              AND (
                    post_title LIKE %s
                 OR REPLACE(
                        REGEXP_REPLACE(post_title, '^download[[:space:]]+', ''),
                        'free on android', ''
                    ) LIKE %s
              )
            ORDER BY post_date DESC
            LIMIT 50
        ", $like, $like);

        $debug['sql'] = $sql;

        $results = $wpdb->get_results($sql);
        $debug['row_count'] = count($results);

        foreach ($results as $row) {
            $title_clean = trim(preg_split('/\(/', $row->post_title_clean)[0]);

            if ($title_clean !== '' && !in_array($title_clean, $suggestions, true)) {
                $suggestions[] = $title_clean . " [status: {$row->post_status}]";
            }
        }

        return new WP_REST_Response([
            'status'       => 'ok',
            'suggestions'  => $suggestions
        ], 200);
    },
    'permission_callback' => '__return_true',
]);
register_rest_route('custom-api/v1', '/search-debug', [
    'methods' => 'GET',
    'callback' => function ($request) {
        global $wpdb;

        $query = trim(mb_strtolower(sanitize_text_field($request->get_param('query'))));
        $lang  = sanitize_text_field($request->get_param('lang')) ?: '';
        $debug = [];

        // Input params
        $debug['input'] = [
            'query' => $query,
            'lang'  => $lang,
        ];

        if ($query === '') {
            return new WP_REST_Response([
                'status'  => 'empty_query',
                'debug'   => $debug,
                'results' => []
            ], 200);
        }

        // WPML switch
        if ($lang !== '' && function_exists('icl_object_id')) {
            do_action('wpml_switch_language', $lang);
            $debug['wpml'] = "Switched to lang: {$lang}";
        } else {
            $debug['wpml'] = "No WPML switch";
        }

        // SQL: l·∫•y t·∫•t c·∫£ post_status
        $like = '%' . $wpdb->esc_like($query) . '%';
        $sql  = $wpdb->prepare("
            SELECT ID, post_title, post_name, post_type, post_status, post_date
            FROM {$wpdb->posts}
            WHERE post_type IN ('game-mobile','embed_post')
              AND post_title LIKE %s
            ORDER BY post_date DESC
            LIMIT 50
        ", $like);

        $debug['sql'] = $sql;

        $results = $wpdb->get_results($sql);
        $debug['row_count'] = count($results);

        $posts = [];
        foreach ($results as $post) {
            $posts[] = [
                'id'     => $post->ID,
                'title'  => $post->post_title,
                'type'   => $post->post_type,
                'status' => $post->post_status, // ‚úÖ hi·ªÉn th·ªã tr·∫°ng th√°i th·∫≠t
                'date'   => $post->post_date,
                'link'   => get_permalink($post->ID),
            ];
        }

        return new WP_REST_Response([
            'status'  => 'ok',
            'results' => $posts
        ], 200);
    },
    'permission_callback' => '__return_true'
]);




    register_rest_route('custom-api/v1', '/highlight-search', [
        'methods'  => 'GET',
        'callback' => function () {
            $items = get_field('highlight_search', 'option') ?: [];
            $titles = [];
    
            foreach ($items as $item) {
                if (!empty($item['title'])) {
                    $titles[] = $item['title'];
                }
            }
    
            return new WP_REST_Response($titles, 200);
        },
        'permission_callback' => '__return_true'
    ]);
    
        

});

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/update-language', [
        'methods' => 'GET',
        'callback' => 'custom_update_language_user_device',
        'permission_callback' => '__return_true',
    ]);
});

function custom_update_language_user_device($request) {
    $user_id = sanitize_text_field($request->get_param('user_id')); // ACF user_id (text)
    $lang    = sanitize_text_field($request->get_param('lang'));

    if (empty($user_id) || empty($lang)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing user_id or lang'
        ], 400);
    }

    // üîé T√¨m post type user-mobile theo ACF field "user_id"
    $query = new WP_Query([
        'post_type'  => 'user-mobile',
        'meta_query' => [
            [
                'key'   => 'id',
                'value' => $user_id,
                'compare' => '='
            ]
        ],
        'posts_per_page' => 1
    ]);

    if (!$query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $post = $query->posts[0];

    // üìù C·∫≠p nh·∫≠t meta language
    update_post_meta($post->ID, 'language', $lang);

    return new WP_REST_Response([
        'success'  => true,
        'message'  => 'Language updated successfully',
        'user_id'  => $user_id, // gi·ªØ nguy√™n text user_id b·∫°n truy·ªÅn
        'language' => $lang
    ], 200);
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/checkin', [
        'methods' => 'GET',
        'callback' => 'custom_user_checkin',
        'permission_callback' => '__return_true',
    ]);
});
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/list-language', [
        'methods' => 'GET',
        'callback' => 'custom_list_languages_fixed',
        'permission_callback' => '__return_true',
    ]);
});

function custom_list_languages_fixed($request) {
    // Danh s√°ch ng√¥n ng·ªØ fix c·ª©ng
    $langs = ['en', 'vi', 'id', 'es', 'pt'];

    return new WP_REST_Response([
        'success' => true,
        'lang'    => $langs
    ], 200);
}

function custom_user_checkin($request) {
    $user_id = intval($request->get_param('user_id'));
    $today   = date('d/m/Y'); // Format gi·ªëng ACF field_checkin_date

    if (empty($user_id)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Missing user_id'], 400);
    }

    $post = get_post($user_id);
    if (!$post || $post->post_type !== 'user-device-mobile') {
        return new WP_REST_Response(['success' => false, 'message' => 'User not found or invalid type'], 404);
    }

    $history = get_field('checkin_history', $user_id);
    if (!is_array($history)) {
        $history = [];
    }

    // Ki·ªÉm tra n·∫øu h√¥m nay ƒë√£ t·ªìn t·∫°i trong l·ªãch s·ª≠
    foreach ($history as $row) {
        if (!empty($row['date']) && $row['date'] === $today) {
            return new WP_REST_Response([
                'success' => false,
                'message' => 'B·∫°n ƒë√£ ƒëi·ªÉm danh h√¥m nay',
                'checkin_history' => $history
            ], 200);
        }
    }

    // Th√™m ƒëi·ªÉm danh m·ªõi
    $history[] = ['date' => $today];
    update_field('checkin_history', $history, $user_id);

    return new WP_REST_Response([
        'success' => true,
        'message' => 'ƒêi·ªÉm danh th√†nh c√¥ng',
        'today'   => $today,
        'checkin_history' => $history
    ], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/add-payment', [
        'methods' => 'GET',
        'callback' => 'custom_add_payment_info',
        'permission_callback' => '__return_true',
    ]);
});

function custom_add_payment_info($request) {
    $user_id         = intval($request->get_param('user_id'));
    $email_pay       = sanitize_email($request->get_param('email_pay'));
    $bank_name       = sanitize_text_field($request->get_param('bank_name'));
    $account_number  = sanitize_text_field($request->get_param('account_number'));
    $account_holder  = sanitize_text_field($request->get_param('account_holder'));
    $branch          = sanitize_text_field($request->get_param('branch')) ?: '';
    $note            = sanitize_textarea_field($request->get_param('note')) ?: '';

    // ===== 1. Ki·ªÉm tra b·∫Øt bu·ªôc =====
    if (!$user_id || !$email_pay || !$bank_name || !$account_number || !$account_holder) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing required fields'
        ], 400);
    }

    // ===== 2. Ki·ªÉm tra post_type =====
    $post = get_post($user_id);
    if (!$post || $post->post_type !== 'user-device-mobile') {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found or invalid type'
        ], 404);
    }

    // ===== 3. D·ªØ li·ªáu l∆∞u v√†o ACF =====
    $payment_info = [
        'email_pay'      => $email_pay,
        'bank_name'      => $bank_name,
        'account_number' => $account_number,
        'account_holder' => $account_holder,
        'branch'         => $branch,
        'note'           => $note
    ];

    // ===== 4. L∆∞u v√†o ACF group =====
    update_field('payment_info', $payment_info, $user_id);

    return new WP_REST_Response([
        'success'       => true,
        'message'       => 'Payment info updated successfully',
        'user_id'       => $user_id,
        'payment_info'  => $payment_info
    ], 200);
}


// ===== ƒêƒÇNG K√ù =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/register', [
        'methods' => 'GET',
        'callback' => 'custom_api_register_user',
        'permission_callback' => '__return_true',
    ]);
});

function custom_api_register_user($request) {
    $username = sanitize_user($request->get_param('username'));
    $email    = sanitize_email($request->get_param('email'));
    $password = $request->get_param('password');
    $lang     = sanitize_text_field($request->get_param('lang')) ?: 'en';

    if (empty($username) || empty($email) || empty($password)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Missing fields', 'lang' => $lang], 400);
    }

    // Ki·ªÉm tra t·ªìn t·∫°i
    $exists = get_posts([
        'post_type'  => 'user-device-mobile',
        'meta_query' => [
            'relation' => 'OR',
            ['key' => 'username', 'value' => $username],
            ['key' => 'email', 'value' => $email]
        ]
    ]);
    if (!empty($exists)) {
        return new WP_REST_Response(['success' => false, 'message' => 'User already exists', 'lang' => $lang], 409);
    }

    // T·∫°o user m·ªõi
    $post_id = wp_insert_post([
        'post_type'   => 'user-device-mobile',
        'post_status' => 'publish',
        'post_title'  => $username
    ]);

    if (is_wp_error($post_id)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Register failed', 'lang' => $lang], 500);
    }

    update_field('username', $username, $post_id);
    update_field('email', $email, $post_id);
    update_field('password_hash', wp_hash_password($password), $post_id);
    update_field('lang', $lang, $post_id);
    update_field('register_date', date('Y-m-d H:i:s'), $post_id);

    return new WP_REST_Response(['success' => true, 'message' => 'User registered', 'user_id' => $post_id, 'lang' => $lang], 200);
}

// ===== ƒêƒÇNG NH·∫¨P =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/login', [
        'methods' => 'GET',
        'callback' => 'custom_api_login_user',
        'permission_callback' => '__return_true',
    ]);
});

function custom_api_login_user($request) {
    $username_or_email = sanitize_text_field($request->get_param('username'));
    $password          = $request->get_param('password');
    $lang              = sanitize_text_field($request->get_param('lang')) ?: 'en';

    if (empty($username_or_email) || empty($password)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Missing credentials', 'lang' => $lang], 400);
    }

    // T√¨m user
    $users = get_posts([
        'post_type'  => 'user-device-mobile',
        'meta_query' => [
            'relation' => 'OR',
            ['key' => 'username', 'value' => $username_or_email],
            ['key' => 'email', 'value' => $username_or_email]
        ],
        'posts_per_page' => 1
    ]);

    if (empty($users)) {
        return new WP_REST_Response(['success' => false, 'message' => 'User not found', 'lang' => $lang], 404);
    }

    $user_post = $users[0];
    $stored_hash = get_field('password_hash', $user_post->ID);

    if (!wp_check_password($password, $stored_hash)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Invalid credentials', 'lang' => $lang], 401);
    }

    update_field('last_login_ip', $_SERVER['REMOTE_ADDR'] ?? '', $user_post->ID);
    update_field('last_login_date', date('Y-m-d H:i:s'), $user_post->ID);

    return new WP_REST_Response([
        'success' => true,
        'message' => 'Login successful',
        'lang'    => $lang,
        'user'    => [
            'id'       => $user_post->ID,
            'username' => get_field('username', $user_post->ID),
            'email'    => get_field('email', $user_post->ID),
            'lang'     => get_field('lang', $user_post->ID)
        ]
    ], 200);
}

// ===== G·ª¨I M√É X√ÅC NH·∫¨N EMAIL =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/send-code', [
        'methods' => 'GET',
        'callback' => 'custom_send_email_code',
        'permission_callback' => '__return_true',
    ]);
});

function custom_send_email_code($request) {
    $email = sanitize_email($request->get_param('email'));
    $lang  = sanitize_text_field($request->get_param('lang')) ?: 'en';

    if (!$email || !is_email($email)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Invalid email address', 'lang' => $lang], 400);
    }

    $users = get_posts([
        'post_type'  => 'user-device-mobile',
        'meta_query' => [['key' => 'email', 'value' => $email]],
        'posts_per_page' => 1
    ]);
    if (empty($users)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Email is not registered', 'lang' => $lang], 404);
    }

    $user_post = $users[0];
    $code = rand(100000, 999999);
    update_field('reset_verification_code', $code, $user_post->ID);

    if (wp_mail($email, 'Your verification code', "Your code is: $code")) {
        return new WP_REST_Response(['success' => true, 'message' => 'Verification code sent', 'code' => $code, 'lang' => $lang], 200);
    }
    return new WP_REST_Response(['success' => false, 'message' => 'Failed to send email', 'lang' => $lang], 500);
}

// ===== RESET PASSWORD =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/reset-password', [
        'methods' => 'GET',
        'callback' => 'custom_reset_password',
        'permission_callback' => '__return_true',
    ]);
});

function custom_reset_password($request) {
    $email    = sanitize_email($request->get_param('email'));
    $password = $request->get_param('password');
    $captcha  = sanitize_text_field($request->get_param('captcha'));
    $lang     = sanitize_text_field($request->get_param('lang')) ?: 'en';

    if (empty($email) || empty($password) || empty($captcha)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Missing fields', 'lang' => $lang], 400);
    }

    $users = get_posts([
        'post_type'  => 'user-device-mobile',
        'meta_query' => [['key' => 'email', 'value' => $email]],
        'posts_per_page' => 1
    ]);
    if (empty($users)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Email not found', 'lang' => $lang], 404);
    }

    $user_post = $users[0];
    $stored_code = get_field('reset_verification_code', $user_post->ID);
    if ($captcha != $stored_code) {
        return new WP_REST_Response(['success' => false, 'message' => 'Invalid verification code', 'lang' => $lang], 403);
    }

    update_field('password_hash', wp_hash_password($password), $user_post->ID);
    delete_field('reset_verification_code', $user_post->ID);

    return new WP_REST_Response(['success' => true, 'message' => 'Password reset successfully', 'lang' => $lang], 200);
}
// ===== CHECK NAME =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/check-name', [
        'methods' => 'GET',
        'callback' => 'custom_send_check_name',
        'permission_callback' => '__return_true',
    ]);
});

function custom_send_check_name($request) {
    $name = sanitize_text_field($request->get_param('name'));
    $lang = sanitize_text_field($request->get_param('lang')) ?: 'en';

    if (empty($name)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Invalid name parameter', 'lang' => $lang], 400);
    }

    // T√¨m user theo username ho·∫∑c display_name
    $users = get_posts([
        'post_type'  => 'user-device-mobile',
        'meta_query' => [
            'relation' => 'OR',
            ['key' => 'username', 'value' => $name],
            ['key' => 'display_name', 'value' => $name]
        ],
        'posts_per_page' => 1
    ]);

    if (!empty($users)) {
        return new WP_REST_Response(['success' => true, 'message' => 'Name exists in the system', 'lang' => $lang], 200);
    } else {
        return new WP_REST_Response(['success' => false, 'message' => 'Name is not registered', 'lang' => $lang], 404);
    }
}


add_action('rest_api_init', function () {
    
   
register_rest_route('custom-api/v1', '/comments', [
    'methods' => 'GET',
    'callback' => 'custom_get_comments',
    'permission_callback' => '__return_true',
]);

function custom_get_comments(WP_REST_Request $request) {
    $post_id  = intval($request->get_param('post_id'));
    $parent   = $request->get_param('parent');
    $parent   = is_numeric($parent) ? intval($parent) : null;
    $per_page = intval($request->get_param('per_page')) ?: 20;
    $page     = intval($request->get_param('page')) ?: 1;
    $orderby  = sanitize_text_field($request->get_param('orderby')) ?: 'date';

    $args = [
        'status'  => 'approve',
        'number'  => $per_page,
        'offset'  => ($page - 1) * $per_page,
        'orderby' => $orderby === 'like' ? 'meta_value_num' : 'comment_date_gmt',
        'order'   => 'DESC',
    ];

    if ($orderby === 'like') {
        $args['meta_key'] = 'like';
    }

    if ($post_id) {
        $args['post_id'] = $post_id;
    }

    if (!is_null($parent)) {
        $parent_comment = get_comment($parent);
        if (!$parent_comment) {
            return new WP_REST_Response(['success' => false, 'message' => 'Parent comment not found'], 400);
        }
        $args['parent'] = $parent;
    }

    $comments = get_comments($args);
    $total = get_comments(array_merge($args, ['count' => true, 'offset' => 0, 'number' => 0]));

    $result = [];
    foreach ($comments as $comment) {
        $user_id = $comment->user_id;
        $user    = $user_id ? get_userdata($user_id) : null;

        $image_urls = get_comment_meta($comment->comment_ID, 'image_urls', true);
        if (!is_array($image_urls)) {
            $image_urls = [];
        }

        $like = intval(get_comment_meta($comment->comment_ID, 'like', true));

        $post = get_post($comment->comment_post_ID);
        $post_title = $post ? get_the_title($post) : '';
        $post_title = trim(
            preg_replace(
                [
                    '/^download\s+/i',          // b·ªè "Download" ·ªü ƒë·∫ßu
                    '/\s*\(.*?\)\s*/',          // b·ªè ƒëo·∫°n trong ngo·∫∑c (...)
                    '/\s*free on android\s*/i', // b·ªè "free on android"
                    '/\d+(\.\d+)*/',            // b·ªè s·ªë version (nƒÉm, 1.2.3...)
                ],
                '',
                $post_title
            )
        );

        // Gom kho·∫£ng tr·∫Øng th·ª´a
        $post_title = preg_replace('/\s{2,}/', ' ', $post_title);


        $post_slug = $post ? $post->post_name : '';
        $post_thumbnail = $post ? get_the_post_thumbnail_url($post->ID, 'medium') : '';

        $result[] = [
            'id'             => $comment->comment_ID,
            'author'         => $user ? $user->display_name : $comment->comment_author,
            'avatar_url'     => $user ? get_avatar_url($user_id) :  "https://secure.gravatar.com/avatar/?s=96&d=mm&r=g",
            'content'        => $comment->comment_content,
            'parent'         => $comment->comment_parent,
            'date'           => $comment->comment_date,
            'image_urls'     => $image_urls,
            'like'           => $like,
            'url_video'      => get_comment_meta($comment->comment_ID, 'url_video', true),
            'post_id'        => $post ? $post->ID : null,
            'post_title'     => $post_title,
            'post_slug'      => $post_slug,
            'post_thumbnail' => $post_thumbnail,
        ];
    }

    return new WP_REST_Response([
        'success' => true,
        'comments' => $result,
        'pagination' => [
            'total'     => intval($total),
            'per_page'  => $per_page,
            'current'   => $page,
            'total_pages' => ceil($total / $per_page)
        ]
    ]);
}

    
        register_rest_route('custom-api/v1', '/comments/add', [
            'methods' => 'GET',
            'callback' => 'custom_add_comment',
            'permission_callback' => '__return_true',
        ]);

        function custom_add_comment($request) {
            $post_id     = intval($request->get_param('post_id'));
            $content     = sanitize_text_field($request->get_param('content'));
            $parent      = intval($request->get_param('parent'));
            $image_urls_raw = $request->get_param('image_urls'); // nhi·ªÅu ·∫£nh, ph√¢n c√°ch |
            $url_video   = esc_url_raw($request->get_param('url_video'));
            $user_id     = intval($request->get_param('user_id'));
            $author_name = sanitize_text_field($request->get_param('author_name'));

            if (!$post_id || empty($content)) {
                return new WP_REST_Response(['success' => false, 'message' => 'Missing post_id or content'], 400);
            }

            $user = $user_id ? get_userdata($user_id) : null;

$comment_data = [
    'comment_post_ID'      => $post_id,
    'comment_content'      => $content,
    'comment_parent'       => $parent,
    'comment_approved'     => 1,
    'user_id'              => $user_id,
    'comment_author'       => $user ? $user->display_name : ($author_name ?: 'Guest'),
    'comment_author_email' => $user ? $user->user_email : '',
];

$comment_id = wp_insert_comment($comment_data);

if (!$comment_id) {
    return new WP_REST_Response(['success' => false, 'message' => 'Failed to add comment'], 500);
}

// X·ª≠ l√Ω ·∫£nh
$image_urls = [];
if (!empty($image_urls_raw)) {
    $image_urls = array_filter(array_map('esc_url_raw', explode('|', $image_urls_raw)));
    update_comment_meta($comment_id, 'image_urls', $image_urls);
}

// X·ª≠ l√Ω video
if (!empty($url_video)) {
    update_comment_meta($comment_id, 'url_video', $url_video);
}

// ========== L·∫•y d·ªØ li·ªáu post cha ==========
$post       = get_post($post_id);
$post_title = get_the_title($post_id);
$post_slug  = $post->post_name;
$post_thumb = get_the_post_thumbnail_url($post_id, 'thumbnail') ?: '';

// ========== Chu·∫©n b·ªã d·ªØ li·ªáu tr·∫£ v·ªÅ ==========
return new WP_REST_Response([
    'success'       => true,
    'id'            => (string) $comment_id,
    'author'        => $user ? $user->display_name : $author_name,
    'avatar_url'    => get_avatar_url($user_id ?: $comment_data['comment_author_email']),
    'content'       => $content,
    'parent'        => (string) $parent,
    'date'          => get_comment_date('Y-m-d H:i:s', $comment_id),
    'image_urls'    => $image_urls,
    'like'          => 0, // m·∫∑c ƒë·ªãnh 0, b·∫°n c√≥ th·ªÉ l∆∞u meta n·∫øu mu·ªën tƒÉng like
    'url_video'     => $url_video ?: '',
    'post_id'       => $post_id,
    'post_title'    => $post_title,
    'post_slug'     => $post_slug,
    'post_thumbnail'=> $post_thumb,
], 200);

        }





    register_rest_route('custom-api/v1', '/comments/like', [
    'methods' => 'GET',
    'callback' => 'custom_like_comment',
    'permission_callback' => '__return_true',
]);

function custom_like_comment(WP_REST_Request $request) {
    $comment_id = intval($request->get_param('comment_id'));
    if (!$comment_id || !get_comment($comment_id)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Invalid comment_id'], 400);
    }

    $current_like = intval(get_comment_meta($comment_id, 'like', true));
    $new_like = $current_like + 1;
    update_comment_meta($comment_id, 'like', $new_like);

    return new WP_REST_Response([
        'success' => true, 
        'comment_id' => $comment_id, 
        'like' => $new_like,
    ], 200);
}
register_rest_route('custom-api/v1', '/comments/dislike', [
    'methods' => 'GET',
    'callback' => 'custom_dislike_comment',
    'permission_callback' => '__return_true',
]);

function custom_dislike_comment(WP_REST_Request $request) {
    $comment_id = intval($request->get_param('comment_id'));
    if (!$comment_id || !get_comment($comment_id)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Invalid comment_id'], 400);
    }

    $current_like = intval(get_comment_meta($comment_id, 'like', true));
    $new_like = $current_like > 0 ? $current_like - 1 : 0;
    update_comment_meta($comment_id, 'like', $new_like);

    return new WP_REST_Response([
        'success' => true, 
        'comment_id' => $comment_id, 
        'like' => $new_like,
    ], 200);
}
    
});
add_action( 'init', function () {
	$upload_dir = wp_upload_dir( null, false );
	define( 'PD_CACHE_DIR', trailingslashit( $upload_dir['basedir'] ) . 'api-cache/post-detail' );

	if ( ! is_dir( PD_CACHE_DIR ) ) {
		wp_mkdir_p( PD_CACHE_DIR );
	}
} );

/* --------------------------------------------------------------------------
 * 2. Helpers
 * ----------------------------------------------------------------------- */
function pd_cache_path( $post_id ) {
	return PD_CACHE_DIR . "/{$post_id}.json";          // KH√îNG c√≤n h·∫≠u t·ªë ng√¥n ng·ªØ
}

function pd_get_recent_comments( $post_id ) {
    $comments = get_comments( [
        'post_id' => $post_id,
        'number'  => 3,
        'status'  => 'approve',
        'orderby' => 'comment_date_gmt',
        'order'   => 'DESC',
        'parent'  => 0,
    ] );

    $post        = get_post( $post_id );
    $post_title  = get_the_title( $post_id );
    $post_slug   = $post->post_name;
    $post_thumb  = get_the_post_thumbnail_url( $post_id, 'thumbnail' ) ?: '';

    return array_map( function ( $c ) use ( $post_id, $post_title, $post_slug, $post_thumb ) {
        $user = $c->user_id ? get_userdata( $c->user_id ) : null;

        // Meta d·ªØ li·ªáu
        $image_urls = get_comment_meta( $c->comment_ID, 'image_urls', true ) ?: [];
        $url_video  = get_comment_meta( $c->comment_ID, 'url_video', true ) ?: '';
        $like       = (int) get_comment_meta( $c->comment_ID, 'like', true );

        return [
            'id'            => (string) $c->comment_ID,
            'author'        => $user ? $user->display_name : $c->comment_author,
            'avatar_url'    => get_avatar_url( $c->user_id ?: $c->comment_author_email ),
            'content'       => $c->comment_content,
            'parent'        => (string) $c->comment_parent,
            'date'          => get_comment_date( 'Y-m-d H:i:s', $c ),
            'image_urls'    => is_array( $image_urls ) ? $image_urls : [],
            'like'          => $like,
            'url_video'     => $url_video,
            'post_id'       => (int) $post_id,
            'post_title'    => $post_title,
            'post_slug'     => $post_slug,
            'post_thumbnail'=> $post_thumb,
        ];
    }, $comments );
}


function pd_build_data( $post_id ) {
    $post = get_post( $post_id );
    if ( ! $post || $post->post_status !== 'publish' ) {
        return false;
    }

    /* --- N·ªôi dung ƒë·∫ßy ƒë·ªß (content ƒë√£ filter) --- */
    $content = apply_filters( 'the_content', get_the_content( null, false, $post ), $post_id );

    /* --- ACF fields --- */
    $version      = get_field( 'version', $post_id )      ?: 'N/A';
    $tamano       = get_field( 'size', $post_id )         ?: '';
    $requirements = get_field( 'os', $post_id )           ?: '';
    $descripcion  = get_field( 'description', $post_id )  ?: '';
    $rating       = floatval( get_field( 'rating', $post_id ) ) ?: 4.3;
    $rating_user  = intval( get_field( 'votes',  $post_id ) )   ?: 100;
    $votes        = intval(get_field('votes', $post_id)) ?: 0;
    $downloads = $votes > 0 ? $votes * 8 : '';

    if ($downloads !== '') {
        $downloads = number_format($downloads, 0, '', '.');
    }


    $consiguelo   = get_field( 'play_link', $post_id )    ?: '';

    $last_update = get_field( 'last_update', $post_id );
    if ( empty( $last_update ) ) {
        $days_ago   = rand( 0, 9 );
        $timestamp  = strtotime( "-{$days_ago} days" );
        $last_update = date( 'Y-m-d', $timestamp );
    }

    $dev_name     = get_field( 'developer', $post_id )    ?: '';
    $download_url = get_field( 'download_link', $post_id );
    $source_url   = get_field( 'source_url', $post_id )   ?: '';

    /* --- L√†m ph·∫≥ng m√¥ t·∫£ --- */
    $descripcion = preg_replace( '/<\/?(ul|li|ol)[^>]*>/', '', $descripcion );
    $descripcion = preg_replace_callback( '/- /', function ( $m ) {
        static $first = false;
        if ( ! $first ) { $first = true; return '- '; }
        return '<br>- ';
    }, $descripcion );

    /* --- Screenshots (gallery) --- */
    $datos_imagenes = [];
    $screenshots    = get_field( 'screenshots', $post_id );
    if ( is_array( $screenshots ) ) {
        foreach ( $screenshots as $img ) {
            if ( ! empty( $img['url'] ) ) {
                $datos_imagenes[] = $img['url'];
            }
        }
    }

    /* --- Featured image --- */
    $featured_image_url = get_the_post_thumbnail_url( $post_id, 'full' );

    /* --- Category con thu·ªôc apps / games --- */
    $category_name = '';
    $categories    = wp_get_post_terms( $post_id, 'game_genre' );
    if ( ! empty( $categories ) && ! is_wp_error( $categories ) ) {
        foreach ( $categories as $cat ) {
            if ( get_post_type( $post_id ) === 'game-mobile' ) {
                $category_name = $cat->name;
                break;
            }
        }
    }

    /* --- Related posts grouped by taxonomy game_genre --- */
    $related_posts = [];
    $terms = wp_get_post_terms( $post_id, 'game_genre' );
    if ( ! empty( $terms ) && ! is_wp_error( $terms ) ) {
        foreach ( $terms as $term ) {
            $posts = get_posts( [
                'post_type'      => 'game-mobile',
                'posts_per_page' => 6,
                'orderby'        => 'rand',
                'post_status'    => 'publish',
                'tax_query'      => [
                    [
                        'taxonomy' => 'game_genre',
                        'field'    => 'term_id',
                        'terms'    => $term->term_id,
                    ],
                ],
                'post__not_in'   => [ $post_id ],
            ] );

            $posts_arr = [];
            foreach ( $posts as $rp ) {
                $posts_arr[] = game_item($rp->ID);
            }

            $related_posts[] = [
                'id'    => $term->term_id,
                'name'  => $term->name,
                'slug'  => $term->slug,
                'posts' => $posts_arr,
            ];
        }
    }

    if ( empty($related_posts) ) {
        $posts = get_posts([
            'post_type'      => 'game-mobile',
            'posts_per_page' => 6,
            'orderby'        => 'rand',
            'post_status'    => 'publish',
            'post__not_in'   => [ $post_id ],
        ]);

                 $posts_arr = [];
            foreach ( $posts as $rp ) {
                $posts_arr[] = game_item($rp->ID);
            }

            $related_posts[] = [
                'id'    => $term->term_id,
                'name'  => $term->name,
                'slug'  => $term->slug,
                'posts' => $posts_arr,
            ];
    }

    /* --- Rating breakdown --- */
    $max_attempts = 1000;
    [ $rating_1,$rating_2,$rating_3,$rating_4,$rating_5 ] = [0,0,0,0,0];
    $found = false;

    for ( $i = 0; $i < $max_attempts; $i++ ) {
        $p1 = rand(0,10); $p2 = rand(0,15); $p3 = rand(10,25); $p4 = rand(20,35);
        $p5 = 100 - ($p1+$p2+$p3+$p4);
        if ( $p5 < 0 || $p5 > 100 ) continue;

        $r1 = round($rating_user*$p1/100);
        $r2 = round($rating_user*$p2/100);
        $r3 = round($rating_user*$p3/100);
        $r4 = round($rating_user*$p4/100);
        $r5 = $rating_user-($r1+$r2+$r3+$r4);

        $avg = ($r1*1 + $r2*2 + $r3*3 + $r4*4 + $r5*5) / $rating_user;
        if ( abs($avg - $rating) < 0.01 ) {
            [ $rating_1,$rating_2,$rating_3,$rating_4,$rating_5 ] = [$p1,$p2,$p3,$p4,$p5];
            $found = true;
            break;
        }
    }
    if ( ! $found ) {
        [ $rating_5,$rating_4,$rating_3,$rating_2,$rating_1 ] = [60,25,10,3,2];
    }

    /* --- X·ª≠ l√Ω title ƒë·ªÉ show ƒë·∫πp --- */
    $name = get_the_title( $post_id );
    $name = preg_replace(
        [
            '/^download\s+/i',      // b·ªè "Download" ƒë·∫ßu d√≤ng
            '/\s*\(.*?\)\s*/',      // b·ªè ƒëo·∫°n trong ngo·∫∑c (...)
            '/\s*free on android\s*/i', // b·ªè "free on android"
            '/\d+(\.\d+)*/',        // b·ªè s·ªë version / nƒÉm
        ],
        '',
        $name
    );
    $name = trim(preg_replace('/\s{2,}/', ' ', $name)); // gom space th·ª´a


    /* --- Build tags t·ª´ title + WP tags --- */
    $tags_array = [];
    $post_title = get_the_title($post_id);

    if ( preg_match('/\((.*?)\)/', $post_title, $matches) ) {
        // L·∫•y n·ªôi dung trong ngo·∫∑c
        $inside = preg_replace('/\bmod\b/i', '', $matches[1]); // b·ªè ch·ªØ MOD
        $tags_array = preg_split('/[\s,]+/', $inside, -1, PREG_SPLIT_NO_EMPTY);
    } else {
        // Kh√¥ng c√≥ ngo·∫∑c th√¨ l·∫•y t·ª´ ti√™u ƒë·ªÅ
        $clean_title = preg_replace('/\bmod\b/i', '', $post_title);
        $tags_array  = preg_split('/\s+/', $clean_title, -1, PREG_SPLIT_NO_EMPTY);
    }

    // Gh√©p tags b·∫±ng kho·∫£ng tr·∫Øng, vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
    $tags = implode(' ', array_map('ucwords', $tags_array));



    /* --- Tr·∫£ v·ªÅ JSON --- */
    return [
        'ID'                  => $post_id,
        'title'               => $name,
        'content'             => $content,
        'descripcion_mod'     => $descripcion,
        'name_game'               => $name,
        // Ratings
        'rating'              => $rating,
        'rating_user'         => $rating_user,
        'rating_5'            => $rating_5,
        'rating_4'            => $rating_4,
        'rating_3'            => $rating_3,
        'rating_2'            => $rating_2,
        'rating_1'            => $rating_1,

        // Info
        'downloads'           => $downloads,
        'version'             => $version,
        'size'                => $tamano,
        'requirements'        => $requirements,
        'link_gg_play'        => $consiguelo,
        'last_update'         => $last_update,
        'dev_name'            => $dev_name,

        // Media
        'featured_image'      => $featured_image_url,
        'datos_imagenes'      => $datos_imagenes,
        'tags'                => $tags,

        // Category & Related
        'category_name'       => $category_name,
        'related_posts'       => $related_posts,

        // Download
        'download_items_text' => 'Download',
        'download_items_link' => $source_url,

        // Permalink
        'post_link_full'      => get_permalink($post_id),
    ];
}



/* --------------------------------------------------------------------------
 * 3. Ghi ‚Äì xo√° cache theo s·ª± ki·ªán post
 * ----------------------------------------------------------------------- */
add_action( 'save_post', function ( $post_id, $post, $update ) {
	if ( 'post' !== $post->post_type || 'publish' !== $post->post_status ) {
		return;
	}
	$data = pd_build_data( $post_id );
	if ( $data ) {
		file_put_contents( pd_cache_path( $post_id ), wp_json_encode( $data ) );
	}
}, 10, 3 );

add_action( 'before_delete_post', 'pd_delete_pd_cache' );
add_action( 'trash_post',         'pd_delete_pd_cache' );
function pd_delete_pd_cache( $post_id ) {
	$path = pd_cache_path( $post_id );
	if ( is_file( $path ) ) {
		unlink( $path );
	}
}

/* --------------------------------------------------------------------------
 * 4. Cron rebuild h·∫±ng ng√†y
 * ----------------------------------------------------------------------- */
register_activation_hook( __FILE__, 'pd_activate_plugin' );
function pd_activate_plugin() {
	// g·ªçi callback rebuild (vi·∫øt l·∫°i t√™n h√†m theo file c·ªßa b·∫°n)
	if ( function_exists( 'pd_rebuild_cache_all_posts' ) ) {
		pd_rebuild_cache_all_posts();           // ch·∫°y 1 l·∫ßn duy nh·∫•t
	}
}

/* ------------------------------------------------------------------
 *  V√¥ hi·ªáu plugin: d·ªçn l·ªãch (ph√≤ng khi tr∆∞·ªõc ƒë√¢y c√≥ schedule)
 * ----------------------------------------------------------------*/
register_deactivation_hook( __FILE__, 'pd_deactivate_plugin' );
function pd_deactivate_plugin() {
	wp_clear_scheduled_hook( 'pd_daily_rebuild_cache' );
}

add_action( 'pd_daily_rebuild_cache', function () {
	$ids = get_posts( [
		'post_type'      => 'post',
		'post_status'    => 'publish',
		'fields'         => 'ids',
		'posts_per_page' => -1,
	] );
	foreach ( $ids as $id ) {
		$data = pd_build_data( $id );
		if ( $data ) {
			file_put_contents( pd_cache_path( $id ), wp_json_encode( $data ) );
		}
	}
} );

/* --------------------------------------------------------------------------
 * 5. REST API: l·∫•y cache v√† ‚Äúgh√©p‚Äù recent_comments
 * ----------------------------------------------------------------------- */
add_action( 'rest_api_init', function () {
	register_rest_route( 'custom-api/v1', '/post-detail', [
		'methods'             => 'GET',
		'permission_callback' => '__return_true',
		'callback'            => function ( $request ) {

			$post_id = (int) $request['id'];
			if ( ! $post_id || 'publish' !== get_post_status( $post_id ) ) {
				return new WP_REST_Response( [ 'error' => 'Post not found' ], 404 );
			}

			$path = pd_cache_path( $post_id );

			if ( is_file( $path ) ) {
				$data = json_decode( file_get_contents( $path ), true );
			} else {
				$data = pd_build_data( $post_id );
				if ( $data ) {
					file_put_contents( $path, wp_json_encode( $data ) );
				}
			}

			if ( empty( $data ) ) {
				return new WP_REST_Response( [ 'error' => 'Unable to build data' ], 500 );
			}

			$data['recent_comments'] = pd_get_recent_comments( $post_id );

			return new WP_REST_Response( $data, 200 );
		},
	] );
} );




add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/upload', [
        'methods' => 'POST',
        'callback' => 'custom_api_file_upload',
        'permission_callback' => '__return_true', // C√≥ th·ªÉ ƒë·ªïi th√†nh ki·ªÉm tra user n·∫øu c·∫ßn
    ]);
});
function custom_api_file_upload(WP_REST_Request $request) {
    if (empty($_FILES['files'])) {
        return new WP_REST_Response(['success' => false, 'message' => 'No files uploaded'], 400);
    }

    require_once(ABSPATH . 'wp-admin/includes/file.php');
    require_once(ABSPATH . 'wp-admin/includes/media.php');
    require_once(ABSPATH . 'wp-admin/includes/image.php');

    $files = $_FILES['files'];
    $uploaded_files = [];

    // Normalize array structure
    $file_count = count($files['name']);
    for ($i = 0; $i < $file_count; $i++) {
        $file = [
            'name'     => $files['name'][$i],
            'type'     => $files['type'][$i],
            'tmp_name' => $files['tmp_name'][$i],
            'error'    => $files['error'][$i],
            'size'     => $files['size'][$i],
        ];

        if ($file['error'] !== UPLOAD_ERR_OK) {
            continue;
        }

        $overrides = ['test_form' => false];
        $upload = wp_handle_upload($file, $overrides);

        if (isset($upload['error'])) {
            continue;
        }

        // Create attachment
        $file_type = wp_check_filetype($upload['file'], null);
        $attachment = [
            'post_mime_type' => $file_type['type'],
            'post_title'     => sanitize_file_name($file['name']),
            'post_content'   => '',
            'post_status'    => 'inherit'
        ];

        $attachment_id = wp_insert_attachment($attachment, $upload['file']);

        if (!is_wp_error($attachment_id)) {
            $attach_data = wp_generate_attachment_metadata($attachment_id, $upload['file']);
            wp_update_attachment_metadata($attachment_id, $attach_data);

            $uploaded_files[] = [
                'attachment_id' => $attachment_id,
                'url'           => wp_get_attachment_url($attachment_id),
                'name'          => $file['name']
            ];
        }
    }

    if (empty($uploaded_files)) {
        return new WP_REST_Response(['success' => false, 'message' => 'No files uploaded successfully'], 500);
    }

    return new WP_REST_Response([
        'success' => true,
        'files'   => $uploaded_files
    ], 200);
}



add_filter('acf/settings/load_json', function ($paths) {
    // H·ªó tr·ª£ ACF cho b√¨nh lu·∫≠n n·∫øu b·∫°n d√πng JSON save
    return $paths;
});

add_filter('acf/get_post_types', function ($post_types) {
    $post_types[] = 'comment'; // Cho ph√©p ACF hi·ªÉn th·ªã v·ªõi b√¨nh lu·∫≠n
    return $post_types;
});

add_filter('acf/location/rule_values/comment', function ($choices) {
    // Cho t·∫•t c·∫£ b√¨nh lu·∫≠n
    $choices['all'] = 'All Comments';
    return $choices;
});



add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/replies-to-user', [
        'methods' => 'GET',
        'callback' => 'api_get_replies_to_user',
        'permission_callback' => function () {
            return true; // B·∫°n c√≥ th·ªÉ th√™m ki·ªÉm tra quy·ªÅn ·ªü ƒë√¢y
        },
        'args' => [
            'user_id' => [
                'required' => true,
                'validate_callback' => function($param) {
                    return is_numeric($param) && $param > 0;
                }
            ],
            'page' => [
                'required' => false,
                'default' => 1,
                'validate_callback' => function($param) {
                    return is_numeric($param) && $param > 0;
                }
            ],
            'per_page' => [
                'required' => false,
                'default' => 10,
                'validate_callback' => function($param) {
                    return is_numeric($param) && $param > 0 && $param <= 100;
                }
            ],
            'orderby' => [
                'required' => false,
                'default' => 'comment_date',
                'validate_callback' => function($param) {
                    $allowed = ['comment_date', 'comment_date_gmt', 'comment_author', 'comment_post_ID'];
                    return in_array($param, $allowed);
                }
            ],
            'order' => [
                'required' => false,
                'default' => 'DESC',
                'validate_callback' => function($param) {
                    return in_array(strtoupper($param), ['ASC', 'DESC']);
                }
            ],
        ],
    ]);
});

function api_get_replies_to_user($request) {
    $user_id = (int) $request->get_param('user_id');
    $page = (int) $request->get_param('page') ?: 1;
    $per_page = (int) $request->get_param('per_page') ?: 10;
    $orderby = $request->get_param('orderby') ?: 'comment_date';
    $order = strtoupper($request->get_param('order') ?: 'DESC');

    // Retrieve all approved comments made by the user
    $user_comment_ids = get_comments([
        'user_id' => $user_id,
        'status' => 'approve',
        'fields' => 'ids',
        'number' => 1000,
    ]);

    if (empty($user_comment_ids)) {
        return rest_ensure_response([
            'total' => 0,
            'per_page' => $per_page,
            'page' => $page,
            'data' => [],
        ]);
    }

    // Calculate offset for pagination
    $offset = ($page - 1) * $per_page;

    // Retrieve approved reply comments whose parent is one of the user's comments
    $reply_comments = get_comments([
        'status' => 'approve',
        'parent__in' => $user_comment_ids,
        'number' => $per_page,
        'offset' => $offset,
        'orderby' => $orderby,
        'order' => $order,
    ]);

    // Count total number of reply comments
    $total_replies = get_comments([
        'status' => 'approve',
        'parent__in' => $user_comment_ids,
        'count' => true,
    ]);

    // Format the response data
    $data = array_map(function($comment) {
        $parent_comment = get_comment($comment->comment_parent);
        return [
            'comment_ID' => $comment->comment_ID,
            'comment_post_ID' => $comment->comment_post_ID,
            'comment_author' => $comment->comment_author,
            'comment_author_email' => $comment->comment_author_email,
            'comment_date' => $comment->comment_date,
            'comment_content' => $comment->comment_content,
            'comment_parent' => $comment->comment_parent,
            'parent_comment_content' => $parent_comment ? $parent_comment->comment_content : '',
        ];
    }, $reply_comments);

    return rest_ensure_response([
        'total' => $total_replies,
        'per_page' => $per_page,
        'page' => $page,
        'data' => $data,
    ]);
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/app-options', array(
        'methods'  => 'GET',
        'callback' => 'get_app_options',
        'permission_callback' => '__return_true'
    ));
});

function get_app_options() {
    $data = [
        'version'                => get_field('version', 'option'),
        'link_download'          => get_field('link_download', 'option'),
        'link_tele'              => get_field('link_tele', 'option'),
        'link_home'              => get_field('link_home', 'option'),
        'link_upload'            => get_field('link_upload', 'option'),
        'link_request'           => get_field('link_request', 'option'),
        'link_feedback'          => get_field('link_feedback', 'option'),
        'link_dcma'              => get_field('link_dcma', 'option'),
        'link_share'             => get_field('link_share', 'option'),
        'link_check_for_updates' => get_field('link_check_for_updates', 'option'),
        'link_privacy_policy'    => get_field('link_privacy_policy', 'option'),
        'admob_banner'                => get_field('banner_ad_unit_id', 'option'),
        'admob_interstitial'          => get_field('interstitial_ad_unit_id', 'option'),
        'admob_rewarded_interstitial' => get_field('rewarded_interstitial_ad_unit_id', 'option'),
        'admob_rewarded'              => get_field('rewarded_ad_unit_id', 'option'),
        'admob_native'                => get_field('native_ad_unit_id', 'option'),
        'admob_app_open'              => get_field('app_open_ad_unit_id', 'option'),
    ];

    return new WP_REST_Response([
        'success' => true,
        'data'    => $data
    ], 200);
}



// ===== ƒêƒÉng k√Ω API =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/homepage', [
        'methods'  => 'GET',
        'callback' => 'custom_api_get_homepage_all',
        'permission_callback' => '__return_true'
    ]);
});

function custom_api_get_homepage_all(WP_REST_Request $request) {
    // üì• Nh·∫≠n tham s·ªë
    $user_id = sanitize_text_field($request->get_param('user_id')) ?: '';
    $lang    = sanitize_text_field($request->get_param('lang')) ?: 'en';
    $default_lang = function_exists('wpml_get_default_language') ? wpml_get_default_language() : 'en';

    // =========================================
    // üåç 1Ô∏è‚É£ L·∫§Y NG√îN NG·ªÆ THEO USER_ID (n·∫øu c√≥)
    // =========================================
    if (!empty($user_id)) {
        $user_query = new WP_Query([
            'post_type'      => 'user-mobile',
            'posts_per_page' => 1,
            'meta_query'     => [
                [
                    'key'     => 'id',
                    'value'   => $user_id,
                    'compare' => '='
                ]
            ]
        ]);

        if ($user_query->have_posts()) {
            $user_post = $user_query->posts[0];
            $lang_meta = get_post_meta($user_post->ID, 'language', true) ?: get_post_meta($user_post->ID, 'lang', true);
            if (!empty($lang_meta)) {
                $lang = strtolower($lang_meta);
            }
        }
        wp_reset_postdata();
    }

    // =========================================
    // üïí 2Ô∏è‚É£ T√çNH NG√ÄY B·∫ÆT ƒê·∫¶U / K·∫æT TH√öC TU·∫¶N & TH√ÅNG
    // =========================================
    date_default_timezone_set('Asia/Ho_Chi_Minh');

    $week_start = date('d/m/Y', strtotime('monday this week'));
    $week_end   = date('d/m/Y', strtotime('sunday this week'));
    $current = current_time('timestamp');
    $month   = date('m', $current);
    $year    = date('Y', $current);

    if ($month == 11 && $year == 2025) {
        $month_start = date('d/m/Y', strtotime('first day of last month', $current));
        $month_end   = date('d/m/Y', strtotime('last day of this month', $current));
    } else {
        $month_start = date('d/m/Y', strtotime('first day of this month', $current));
        $month_end   = date('d/m/Y', strtotime('last day of this month', $current));
    }

    // =========================================
    // üéØ 3Ô∏è‚É£ CACHE KEY C√ÅC PH·∫¶N
    // =========================================
    $cache_embed_key    = "homepage_embed_{$lang}";
    $cache_homepage_key = "homepage_posts_{$lang}";
    $cache_forum_key    = "homepage_forum_{$lang}";

    $sections = [];

    // ======================================================
    // üß© 4Ô∏è‚É£ L·∫§Y EMBED POSTS (cache 12h)
    // ======================================================
    $embed_section = get_transient($cache_embed_key);
    if ($embed_section === false) {
        $embed_section = get_embed_posts_section($default_lang);
        if ($embed_section) {
            set_transient($cache_embed_key, $embed_section, 12 * HOUR_IN_SECONDS);
        }
    }
    if (!empty($embed_section)) {
        $sections[] = $embed_section;
    }

    // ======================================================
    // üß© 5Ô∏è‚É£ L·∫§Y HOMEPAGE POSTS (cache 6h)
    // ======================================================
    $homepage_section = get_transient($cache_homepage_key);
    if ($homepage_section === false) {
        $homepage_section = get_homepage_posts_section($lang, $default_lang);
        if ($homepage_section) {
            set_transient($cache_homepage_key, $homepage_section, 6 * HOUR_IN_SECONDS);
        }
    }
    if (!empty($homepage_section)) {
        $sections[] = $homepage_section;
    }

    // ======================================================
    // üß© 6Ô∏è‚É£ EVENT SECTION (Week + Month)
    // ======================================================
    $week_texts = [
        'en' => "üéâ Week Events - Play and Win Gifts ($week_start ‚Üí $week_end)",
        'vi' => "üéâ S·ª± Ki·ªán Tu·∫ßn - Ch∆°i v√† nh·∫≠n Qu√† t·∫∑ng ($week_start ‚Üí $week_end)",
        'es' => "üéâ Eventos de la semana: juega y gana regalos ($week_start ‚Üí $week_end)",
        'pt' => "üéâ Eventos da Semana - Brinque e Ganhe Presentes ($week_start ‚Üí $week_end)",
        'id' => "üéâ Acara Mingguan - Mainkan dan Menangkan Hadiah ($week_start ‚Üí $week_end)",
    ];
$month_texts = [
    'en' => "üéâ Click here to play and complete today's attendance mission",
    'vi' => "üéâ Nh·∫•p v√†o ƒë√¢y ƒë·ªÉ ch∆°i v√† ho√†n th√†nh nhi·ªám v·ª• chuy√™n c·∫ßn c·ªßa ng√†y",
    'es' => "üéâ Haz clic aqu√≠ para jugar y completar la misi√≥n de asistencia de hoy",
    'pt' => "üéâ Clique aqui para jogar e completar a miss√£o de assiduidade de hoje",
    'id' => "üéâ Klik di sini untuk bermain dan menyelesaikan misi kehadiran hari ini",
];




    $banners = [
        'week' => [
            'img'       => 'https://apkmodjoy.com/wp-content/uploads/2025/11/nguoi-sang-tao-flappy-bird-phu-nhan-viec-da-ban-ban-quyen-20241022094150-6162-0.jpg',
            'url'       => 'https://apkmodjoy.com/game-online/flappy-bird/demo',
            'direction' => 'Vertical',
        ],
        'month' => [
            'img'       => 'https://apkmodjoy.com/wp-content/uploads/2025/10/Dinosaur-Games-page-banners-desktop-1920x700-1.webp',
            'url'       => 'https://apkmodjoy.com/game-online/dinosaur-game/demo',
            'direction' => 'Horizontal',
        ],
    ];

    $event_section = [
        'type'  => 'event_options',
        'title' => 'Events',
        'week'  => [
            'text'      => $week_texts[$lang] ?? $week_texts['en'],
            'img'       => $banners['week']['img'],
            'url'       => $banners['week']['url'],
            'direction' => $banners['week']['direction'],
        ],
        'month' => [
            'text'      => $month_texts[$lang] ?? $month_texts['en'],
            'img'       => $banners['month']['img'],
            'url'       => $banners['month']['url'],
            'direction' => $banners['month']['direction'],
        ],
    ];
    $sections[] = $event_section;

    // ======================================================
    // üß© 7Ô∏è‚É£ FORUM POSTS (cache 10 ph√∫t)
    // ======================================================
    $forum_section = get_forum_posts_section($default_lang);
    if (!empty($forum_section)) {
        $sections[] = $forum_section;
    }

    // ======================================================
    // üí∞ 8Ô∏è‚É£ L·∫§Y TI·ªÄN NG∆Ø·ªúI D√ôNG & NG√îN NG·ªÆ USER
    // ======================================================
    $top_text_label = 'Bonus';
    $title_texts = [
        'en' => 'üèÜ Top Game Rewards',
        'vi' => 'üèÜ Ph·∫ßn th∆∞·ªüng x·∫øp h·∫°ng',
        'es' => 'üèÜ Recompensas de juegos principales',
        'pt' => 'üèÜ Recompensas dos melhores jogos',
        'id' => 'üèÜ Hadiah Game Teratas',
    ];
    $item_titles = [
        'week' => [
            'en' => 'Weekly Ranking',
            'vi' => 'X·∫øp h·∫°ng Tu·∫ßn',
            'es' => 'Clasificaci√≥n semanal',
            'pt' => 'Classifica√ß√£o semanal',
            'id' => 'Peringkat Mingguan',
        ],
        'month' => [
            'en' => 'Monthly Ranking',
            'vi' => 'X·∫øp h·∫°ng Th√°ng',
            'es' => 'Clasificaci√≥n mensual',
            'pt' => 'Classifica√ß√£o mensal',
            'id' => 'Peringkat Bulanan',
        ],
    ];

    // üîç L·∫•y ng√¥n ng·ªØ & ti·ªÅn t·ª´ user-mobile
// ======================================================
// üí∞ 8Ô∏è‚É£ L·∫§Y TI·ªÄN NG∆Ø·ªúI D√ôNG & NG√îN NG·ªÆ USER
// ======================================================
$user_lang  = $lang;
$user_money = 0;
$top_text   = null;

if (!empty($user_id)) {
    $query = new WP_Query([
        'post_type'  => 'user-mobile',
        'meta_query' => [[
            'key'     => 'id',
            'value'   => $user_id,
            'compare' => '='
        ]],
        'posts_per_page' => 1
    ]);

    if ($query->have_posts()) {
        $post = $query->posts[0];

        // L·∫•y meta language
        $lang_meta = get_post_meta($post->ID, 'language', true);
        $user_lang = !empty($lang_meta) ? $lang_meta : 'en';

        // L·∫•y ti·ªÅn (USD g·ªëc)
        $money_diem_danh = get_post_meta($post->ID, 'money_diem_danh', true);
        $user_money_diem_danh = is_array($money_diem_danh) ? 0 : (float) ($money_diem_danh ?: 0);

        // ===== T·ª∂ GI√Å =====
        $USD_TO_VND = 20000;
        $USD_TO_IDR = 15000;

        // ===== GI·ªÆ NGUY√äN LOGIC: user_money =====
        if ($user_lang === 'vi') {
            $user_money = $user_money_diem_danh * $USD_TO_VND;
        } elseif ($user_lang === 'id') {
            $user_money = $user_money_diem_danh * $USD_TO_IDR;
        } else {
            // en ‚Üí gi·ªØ USD
            $user_money = $user_money_diem_danh;
        }
    }

    wp_reset_postdata();
}


// üí∞ N·∫øu c√≥ ti·ªÅn th∆∞·ªüng th√¨ th√™m v√†o section "forum"
if ($user_money > 0) {
    // üåç D·ªãch theo ng√¥n ng·ªØ
$translations = [
    'en' => 'You have an important notification, click to see details',
    'id' => 'Anda memiliki pemberitahuan penting, klik untuk melihat detail',
    'vi' => 'B·∫°n c√≥ th√¥ng b√°o quan tr·ªçng, click ƒë·ªÉ xem chi ti·∫øt',
    'es' => 'Tienes una notificaci√≥n importante, haz clic para ver los detalles',
    'pt' => 'Voc√™ tem uma notifica√ß√£o importante, clique para ver os detalhes',
];


    // üî§ L·∫•y text theo ng√¥n ng·ªØ ng∆∞·ªùi d√πng, m·∫∑c ƒë·ªãnh l√† ti·∫øng Anh
    $top_text = $translations[$user_lang] ?? $translations['en'];

    $reward_section = [
        'type'  => 'bonus',
        'list_post' => [
            [
                'top_text'   => $top_text,
                'money'      => $user_money,
                'user_id'    => $user_id,
                'language'   => $user_lang
            ]
        ]
    ];

    $sections[] = $reward_section;
}


    // ======================================================
    // üé≤ 9Ô∏è‚É£ SHUFFLE & GI·ªöI H·∫†N EMBED POSTS
    // ======================================================
    foreach ($sections as &$section) {
        if (!empty($section['type']) && $section['type'] === 'embed_posts' && !empty($section['list_post'])) {
            shuffle($section['list_post']);
            $section['list_post'] = array_slice($section['list_post'], 0, 80);
        }
    }

    // ======================================================
    // üì¶ üîü TR·∫¢ K·∫æT QU·∫¢
    // ======================================================
    return new WP_REST_Response([
        'lang'    => $lang,
        'user_id' => $user_id,
        'data'    => $sections,
    ], 200);
}




/**
 * Section 1: Homepage Posts (ACF Post Object) ‚Äî h·ªó tr·ª£ WPML
 */
function get_homepage_posts_section($lang, $default_lang) {
    if (function_exists('do_action')) {
        do_action('wpml_switch_language', $lang);
    }

    // L·∫•y t·∫•t c·∫£ b√†i c·ªßa post_type = game-mobile
    $query = new WP_Query([
        'post_type'      => 'game-mobile',
        'post_status'    => 'publish',
        'posts_per_page' => -1,  // l·∫•y t·∫•t c·∫£
        'orderby'        => 'date',
        'order'          => 'DESC'
    ]);

    if (!$query->have_posts()) return null;

    $list_post = [];
    while ($query->have_posts()) {
        $query->the_post();
        $post_id = get_the_ID();

        // N·∫øu c√≥ WPML th√¨ d·ªãch sang ng√¥n ng·ªØ hi·ªán t·∫°i
        if (function_exists('wpml_object_id_filter')) {
            $translated_id = wpml_object_id_filter($post_id, 'game-mobile', true, $lang);
            if ($translated_id) $post_id = $translated_id;
        }

        $list_post[] = game_item($post_id);
    }
    wp_reset_postdata();

    return [
        'type'      => 'homepage_posts',
        'list_post' => $list_post
    ];
}


/**
 * Section 2: Embed Posts ‚Äî ng√¥n ng·ªØ m·∫∑c ƒë·ªãnh
 */
function get_embed_posts_section($default_lang) {
    if (function_exists('do_action')) {
        do_action('wpml_switch_language', $default_lang);
    }
    $embed_posts = get_embed_posts();
    return [
        'type'      => 'embed_posts',
        'list_post' => $embed_posts['data'][0]['list_post'] ?? []
    ];
}

function get_embed_posts() {
    $args = [
        'post_type'      => 'embed_post',
        'posts_per_page' => 100,
        'post_status'    => 'publish',
        'orderby'        => 'rand',
    ];
    $query = new WP_Query($args);
    $list_post = [];

    foreach ($query->posts as $post) {

        $categories = wp_get_post_terms($post->ID, 'category', ['fields' => 'names']);

        $filtered_categories = array_filter($categories, function($cat) {
            return !in_array(strtolower($cat), ['games', 'apps']);
        });

        $list_post[] = [
            'id'         => $post->ID,
            'name'       => get_the_title($post->ID),
            'slug'       => $post->post_name,
            'url'        => get_field('iframe', $post->ID),
            'direction' => get_field('direction', $post->ID) ?: 'Horizontal',
            'thumbnail'  => get_the_post_thumbnail_url($post->ID, 'medium'),
            'background' => get_field('background', $post->ID),
            'genre'      => array_values($filtered_categories),
            'rating'     => get_field('rating', $post->ID) ?: round(rand(70, 95) / 10, 1),
            'type'       => 'game_online',
        ];
    }
    return [
        'data' => [
            [
                'list_post' => $list_post
            ]
        ]
    ];
}
function get_embed_post_by_id($post_id) {
    $post = get_post($post_id);

    if (!$post || $post->post_type !== 'embed_post' || $post->post_status !== 'publish') {
        return null;
    }

    // L·∫•y category (b·ªè qua games, apps)
    $categories = wp_get_post_terms($post->ID, 'category', ['fields' => 'names']);
    $filtered_categories = array_filter($categories, function($cat) {
        return !in_array(strtolower($cat), ['games', 'apps']);
    });

    return [
        'id'          => $post->ID,
        'title'        => get_the_title($post->ID),
        'slug'        => $post->post_name,
        'url'         => get_field('iframe', $post->ID),
        'direction'   => get_field('direction', $post->ID) ?: 'Horizontal',
        'image'   => get_the_post_thumbnail_url($post->ID, 'medium'),
        'background'  => get_field('background', $post->ID),
        'genre'       => array_values($filtered_categories),
        'rating'      => get_field('rating', $post->ID) ?: round(rand(70, 95) / 10, 1),
        'type'        => 'game_online',

        // üîπ C√°c field m·ªõi
        'rank'        => get_field('rank', $post->ID) ?: "9.2",
        'views'       => get_field('views', $post->ID) ?: "0",
        'tags'        => get_field('tags', $post->ID) ?: get_the_tags($post->ID)[0]->name ?? "",
        'date'        => get_the_date('Y-m-d', $post->ID),
        'image_thumb' => get_field('image_thumb', $post->ID) ?: "",
        'desc'        => get_the_excerpt($post->ID),
        'first_image' => get_field('first_image', $post->ID) ?: "",
        'image_full'  => get_field('image_full', $post->ID) ?: get_the_post_thumbnail_url($post->ID, 'full'),
    ];
}


/**
 * Section 3: Forum Posts ‚Äî ng√¥n ng·ªØ m·∫∑c ƒë·ªãnh
 */
function get_forum_posts_section($default_lang) {
    if (function_exists('do_action')) {
        do_action('wpml_switch_language', $default_lang);
    }

        $forum_query = new WP_Query([
            'post_type'      => 'forum',
            'posts_per_page' => 20,
            'post_status'    => 'publish',
            'meta_query'     => [
                [
                    'key'     => 'parent_forum_id',
                    'compare' => 'NOT EXISTS' // ch·ªâ l·∫•y post kh√¥ng c√≥ parent_id
                ]
            ]
        ]);


    $forum_list = [];
    foreach ($forum_query->posts as $post) {
        // L·∫•y post user-mobile t·ª´ ACF
        $acf_user_id = get_field('user_id', $post->ID);
        

        // M·∫∑c ƒë·ªãnh
        $user_id    = 'guest';
        $user_name  = 'Anonymous';
        $user_image = 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';

        if (!empty($acf_user_id)) {
            // T√¨m post user-mobile theo ACF field "id"
            $user_query = new WP_Query([
                'post_type'  => 'user-mobile',
                'meta_query' => [
                    [
                        'key'   => 'id',   // ACF field trong user-mobile
                        'value' => $acf_user_id,
                        'compare' => '='
                    ]
                ],
                'posts_per_page' => 1
            ]);

            if ($user_query->have_posts()) {
                $user_post  = $user_query->posts[0];
                $user_id    = $acf_user_id; // gi·ªØ nguy√™n chu·ªói ID
                $user_name  = get_field('name', $user_post->ID) ?: $acf_user_id;

                $user_image_field = get_field('user_image', $user_post->ID);
                if (!empty($user_image_field)) {
                    $user_image = $user_image_field;
                } else {
                    // N·∫øu ch∆∞a c√≥, auto random avatar + l∆∞u l·∫°i
                    $new_avatar = 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';
                    update_field('user_image', $new_avatar, $user_post->ID);
                    $user_image = $new_avatar;
                }
            }
            wp_reset_postdata();
        }

    $mentioned_posts = [];
    $mentioned_field = get_field('name_game', $post->ID); // v√≠ d·ª• ["Dino", "Minecraft"]

    if (!empty($mentioned_field)) {
        foreach ((array) $mentioned_field as $name_game) {
            // Truy v·∫•n post embed_post theo title
            $embed_query = new WP_Query([
                'post_type'      => 'embed_post',
                'title'          => $name_game,
                'posts_per_page' => 1,
            ]);

            if ($embed_query->have_posts()) {
                $embed_query->the_post();
                $mentioned_posts[] = get_embed_post_by_id(get_the_ID());
                wp_reset_postdata();
            }
        }
    }
        $forum_list[] = [
            'id'         => $post->ID,
            'name'       => get_the_title($post->ID),
            'name_game'       => get_field('name_game', $post->ID) ?: "Dino",
            'slug'       => get_post_field('post_name', $post->ID),
            'type'       => get_post_type($post->ID),
            'user_id'    => $user_id,   // gi·ªù l√† ch·ªØ
            'user_name'  => $user_name,
            'user_image' => $user_image,
            'date'       => human_time_diff(get_the_time('U', $post->ID), current_time('timestamp')) . ' ago',
            'thumbnail'  => get_the_post_thumbnail_url($post->ID, 'thumbnail'),
            'like'       => intval(get_field('like_count_post', $post->ID)),
            'gallery'    => get_field('gallery', $post->ID),
            
        'mentioned'              => $mentioned_posts,
            'view'   => intval(get_field('view', $post->ID)),
            'title'  => get_the_title($post->ID),
                'content' => apply_filters('the_content', get_the_content(null, false, $post->ID)) // ‚úÖ th√™m n·ªôi dung

        ];
    }

    return [
        'type'      => 'forum',
        'list_post' => $forum_list
    ];
}


/**
 * Hook clear cache khi save trang mobile-setting
 */
add_action('acf/save_post', function($post_id) {
    if ($post_id !== 'options') return;
    if (empty($_GET['page']) || $_GET['page'] !== 'mobile-setting') return;

    // L·∫•y danh s√°ch ng√¥n ng·ªØ
    $langs = ['en'];
    if (function_exists('wpml_get_active_languages')) {
        $langs = array_keys(wpml_get_active_languages());
    }

    // Xo√° cache cho t·∫•t c·∫£ ng√¥n ng·ªØ
    foreach ($langs as $lang) {
        delete_transient("homepage_cache_{$lang}");
    }
});


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/forum-detail', [
        'methods'  => 'GET',
        'callback' => 'custom_api_forum_detail',
        'permission_callback' => '__return_true'
    ]);
});

// üß† H√†m ƒë·ªá quy l·∫•y t·∫•t c·∫£ comment con (kh√¥ng gi·ªõi h·∫°n c·∫•p)
function get_forum_children_recursive($parent_id) {
    $children = [];

    $child_query = new WP_Query([
        'post_type'      => 'forum',
        'post_status'    => 'publish',
        'meta_query'     => [
            [
                'key'     => 'parent_forum_id',
                'value'   => $parent_id,
                'compare' => '='
            ]
        ],
        'orderby'        => 'date',
        'order'          => 'ASC',
        'posts_per_page' => -1,
    ]);

    if ($child_query->have_posts()) {
        foreach ($child_query->posts as $child) {
            $child_user_id   = get_field('user_id', $child->ID);
            $child_user_info = function_exists('get_forum_user') ? get_forum_user($child_user_id) : [
                'id'    => $child_user_id ?: 'guest',
                'name'  => 'Anonymous',
                'image' => 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg',
            ];

            $ch_gmt   = get_post_time('Y-m-d H:i:s', true, $child->ID);
            $ch_time  = get_date_from_gmt($ch_gmt, 'Y-m-d H:i:s');
            $ch_at    = strtotime($ch_time);
            $ch_human = human_time_diff($ch_at, current_time('timestamp')) . ' ago';

            $like_count_child = intval(get_field('like_count_post', $child->ID));

            // üîÅ G·ªçi l·∫°i ch√≠nh h√†m n√†y ƒë·ªÉ l·∫•y comment con s√¢u h∆°n
            $sub_children = get_forum_children_recursive($child->ID);

            $children[] = [
                'id'             => $child->ID,
                'parent_id'      => $parent_id,
                'title'          => get_the_title($child->ID),
                'user_id'        => $child_user_info['id'],
                'user_name'      => $child_user_info['name'],
                'user_image'     => $child_user_info['image'],
                'created_time'   => $ch_time,
                'timestamp'      => $ch_at,
                'date'           => $ch_human,
                'like'           => $like_count_child,
                'child_comments' => $sub_children, // üëà ch·ª©a con ch√°u l·ªìng nhau
            ];
        }
        wp_reset_postdata();
    }

    return $children;
}

function custom_api_forum_detail(WP_REST_Request $request) {
    $post_id = intval($request->get_param('id'));
    if (!$post_id || get_post_type($post_id) !== 'forum' || get_post_status($post_id) !== 'publish') {
        return wp_send_json(['success' => false, 'message' => 'Forum not found'], 404, JSON_UNESCAPED_UNICODE);
    }

    $post = get_post($post_id);

    // üìå Mentioned posts
    $mentioned_posts = [];
    $mentioned_field = get_field('name_game', $post_id);

    if (!empty($mentioned_field)) {
        foreach ((array) $mentioned_field as $name_game) {
            $embed_query = new WP_Query([
                'post_type'      => 'embed_post',
                'title'          => $name_game,
                'posts_per_page' => 1,
            ]);

            if ($embed_query->have_posts()) {
                $embed_query->the_post();
                $mentioned_posts[] = get_embed_post_by_id(get_the_ID());
                wp_reset_postdata();
            }
        }
    }

    // üì© L·∫•y c√°c b√¨nh lu·∫≠n c·∫•p 1 + t·∫•t c·∫£ con ch√°u c·ªßa ch√∫ng
    $recent_comments = [];
    $comment_query = new WP_Query([
        'post_type'      => 'forum',
        'posts_per_page' => 10,
        'post_status'    => 'publish',
        'meta_query'     => [
            [
                'key'     => 'parent_forum_id',
                'value'   => $post_id,
                'compare' => '='
            ]
        ],
        'orderby'        => 'date',
        'order'          => 'DESC',
    ]);

    if ($comment_query->have_posts()) {
        foreach ($comment_query->posts as $cpost) {
            $c_user_id   = get_field('user_id', $cpost->ID);
            $c_user_info = function_exists('get_forum_user') ? get_forum_user($c_user_id) : [
                'id'    => $c_user_id ?: 'guest',
                'name'  => 'Anonymous',
                'image' => 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg',
            ];

            $created_gmt   = get_post_time('Y-m-d H:i:s', true, $cpost->ID); 
            $created_time  = get_date_from_gmt($created_gmt, 'Y-m-d H:i:s');
            $created_at    = strtotime($created_time);
            $human_time    = human_time_diff($created_at, current_time('timestamp')) . ' ago';

            $like_count_parent = intval(get_field('like_count_post', $cpost->ID));

            // üîÅ L·∫•y t·∫•t c·∫£ comment con l·ªìng nhau
            $child_comments = get_forum_children_recursive($cpost->ID);

            $recent_comments[] = [
                'id'             => $cpost->ID,
                'parent_id'      => $post_id,
                'title'          => get_the_title($cpost->ID),
                'user_id'        => $c_user_info['id'],
                'user_name'      => $c_user_info['name'],
                'user_image'     => $c_user_info['image'],
                'created_time'   => $created_time,
                'timestamp'      => $created_at,
                'date'           => $human_time,
                'like'           => $like_count_parent,
                'child_comments' => $child_comments,
            ];
        }
        wp_reset_postdata();
    }

    // üì∑ Gallery
    $gallery = get_field('gallery', $post_id);
    if (!is_array($gallery)) $gallery = [];

    // üë§ Th√¥ng tin ng∆∞·ªùi ƒëƒÉng
    $acf_user_id = get_field('user_id', $post->ID);
    $user_id    = 'guest';
    $user_name  = 'Anonymous';
    $user_image = 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';

    if (!empty($acf_user_id)) {
        $user_query = new WP_Query([
            'post_type'      => 'user-mobile',
            'meta_query'     => [[ 'key' => 'id', 'value' => $acf_user_id, 'compare' => '=' ]],
            'posts_per_page' => 1
        ]);

        if ($user_query->have_posts()) {
            $user_post   = $user_query->posts[0];
            $user_id     = $acf_user_id;
            $user_name   = get_field('name', $user_post->ID) ?: $acf_user_id;
            $user_image  = get_field('user_image', $user_post->ID) ?: $user_image;
        }
        wp_reset_postdata();
    }

    // üì¶ D·ªØ li·ªáu tr·∫£ v·ªÅ
    $data = [
        'id'              => $post_id,
        'title'           => get_field('title', $post_id) ?: get_the_title($post_id),
        'user_id'         => $user_id,
        'user_name'       => $user_name,
        'user_image'      => $user_image,
        'gallery'         => $gallery,
        'mentioned'       => $mentioned_posts,
        'view'            => get_field('view', $post_id) ?: 0,
        'like'            => get_field('like_count_post', $post_id) ?: 0,
        'content'         => apply_filters('the_content', $post->post_content),
        'date'            => get_the_date('Y-m-d ‚Ä¢ H:i:s', $post_id),
        'recent_comments' => $recent_comments
    ];

    return wp_send_json(['success' => true, 'data' => $data], 200, JSON_UNESCAPED_UNICODE);
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v2', '/register', [
        'methods' => 'GET',
        'callback' => 'custom_api_register_user_v2',
        'permission_callback' => '__return_true',
    ]);
});

function custom_api_register_user_v2($request) {
    $username = sanitize_user($request->get_param('username'));
    $email    = sanitize_email($request->get_param('email'));
    $password = $request->get_param('password');

    if (empty($username) || empty($email) || empty($password)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Missing fields'], 400);
    }

    if (username_exists($username) || email_exists($email)) {
        return new WP_REST_Response(['success' => false, 'message' => 'User already exists'], 409);
    }

    $user_id = wp_create_user($username, $password, $email);
    if (is_wp_error($user_id)) {
        return new WP_REST_Response(['success' => false, 'message' => $user_id->get_error_message()], 500);
    }

    return new WP_REST_Response(['success' => true, 'message' => 'User registered', 'user_id' => $user_id], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v2', '/login', [
        'methods' => 'GET',
        'callback' => 'custom_api_login_user_v2',
        'permission_callback' => '__return_true',
    ]);
});

function custom_api_login_user_v2($request) {
    $username = sanitize_user($request->get_param('username'));
    $password = $request->get_param('password');

    if (empty($username) || empty($password)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Missing credentials'], 400);
    }

    $user = wp_authenticate($username, $password);
    if (is_wp_error($user)) {
        return new WP_REST_Response(['success' => false, 'message' => 'Invalid login'], 401);
    }

    return new WP_REST_Response([
        'success' => true,
        'message' => 'Login successful',
        'user_id' => $user->ID,
        'username' => $user->user_login,
        'email' => $user->user_email
    ], 200);
}

// ===== G·ª¨I M√É X√ÅC NH·∫¨N EMAIL =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v2', '/send-code', [
        'methods' => 'GET',
        'callback' => 'custom_send_email_code_v2',
        'permission_callback' => '__return_true',
    ]);
});

    function custom_send_email_code_v2($request) {
        $msg_invalid_email = 'Invalid email address.';
        $msg_not_found     = 'Email is not registered.';
        $msg_sent          = 'A verification code has been sent to your email.';
        $msg_error         = 'An error occurred while sending the email.';
    
        $email = sanitize_email($request->get_param('email'));
        if (!$email || !is_email($email)) {
            return new WP_REST_Response(['success' => false, 'message' => $msg_invalid_email], 400);
        }
    
        $user = get_user_by('email', $email);
        if (!$user) {
            return new WP_REST_Response(['success' => false, 'message' => $msg_not_found], 404);
        }
    
        $code = rand(100000, 999999);
        update_user_meta($user->ID, 'reset_verification_code', $code);
    
        $subject = "Your verification code";
        $message = "Your verification code is: <strong>$code</strong>";
        $headers = ['Content-Type: text/html; charset=UTF-8'];
    
        if (wp_mail($email, $subject, $message, $headers)) {
            return new WP_REST_Response(['success' => true,'code' => $code,'email' => $email, 'message' => $msg_sent]);
        } else {
            return new WP_REST_Response(['success' => false, 'message' => $msg_error], 500);
        }
    }
// ===== RESET PASSWORD =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v2', '/reset-password', [
        'methods' => 'GET',
        'callback' => 'custom_reset_password_v2',
        'permission_callback' => '__return_true',
    ]);
});

  function custom_reset_password_v2($request) {
        $msg_invalid_input   = 'Invalid input.';
        $msg_short_pass      = 'Password must be at least 12 characters.';
        $msg_email_not_exist = 'Email does not exist.';
        $msg_wrong_code      = 'The verification code is incorrect.';
        $msg_success         = 'Password has been updated successfully.';
    
        $email    = sanitize_email($request->get_param('email'));
        $password = sanitize_text_field($request->get_param('password'));
        $captcha  = sanitize_text_field($request->get_param('captcha'));
    
        if (!$email || !$password || !$captcha) {
            return new WP_REST_Response(['success' => false, 'message' => $msg_invalid_input], 400);
        }
    
        if (strlen($password) < 12) {
            return new WP_REST_Response(['success' => false, 'message' => $msg_short_pass], 400);
        }
    
        $user = get_user_by('email', $email);
        if (!$user) {
            return new WP_REST_Response(['success' => false, 'message' => $msg_email_not_exist], 404);
        }
    
        $stored_code = get_user_meta($user->ID, 'reset_verification_code', true);
        if ($captcha !== $stored_code) {
            return new WP_REST_Response(['success' => false, 'message' => $msg_wrong_code], 403);
        }
    
        wp_set_password($password, $user->ID);
        wp_set_current_user($user->ID);
        wp_set_auth_cookie($user->ID, true);
        delete_user_meta($user->ID, 'reset_verification_code');
    
        return new WP_REST_Response([
            'success' => true,
            'message' => $msg_success,
            'email' => $email,
            'password' => $password,
            'code' => $captcha,
            'redirect' => home_url('/')
        ]);
    }
// ===== CHECK NAME =====
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v2', '/check-name', [
        'methods' => 'GET',
        'callback' => 'custom_send_check_name_v2',
        'permission_callback' => '__return_true',
    ]);
});

    function custom_send_check_name_v2($request) {
        $msg_invalid_name = 'Invalid name parameter.';
        $msg_not_found    = 'Name is not registered.';
        $msg_found        = 'Name exists in the system.';

        $name = sanitize_text_field($request->get_param('name'));
        if (!$name) {
            return new WP_REST_Response(['success' => false, 'message' => $msg_invalid_name], 400);
        }

        // T√¨m user theo user_login ho·∫∑c user_nicename ho·∫∑c display_name
        $user_query = new WP_User_Query([
            'search'         => $name,
            'search_columns' => ['user_login', 'user_nicename', 'display_name'],
            'number'         => 1,
        ]);
        $users = $user_query->get_results();

        if (!empty($users)) {
            return new WP_REST_Response(['success' => true, 'message' => $msg_found]);
        } else {
            return new WP_REST_Response(['success' => false, 'message' => $msg_not_found], 404);
        }
    }





add_action('rest_api_init', function (){
    register_rest_route('custom-api/v1', '/search-game', [
        'methods' => 'GET',
        'callback' => function ($request) {
            global $wpdb;

            $query = trim(mb_strtolower(sanitize_text_field($request->get_param('query'))));
            $lang  = sanitize_text_field($request->get_param('lang')) ?: '';
            $posts = [];

            if ($query === '') {
                $args = [
                    'post_type'      => ['embed_post'], // tu·ª≥ b·∫°n mu·ªën search post_type n√†o
                    'post_status'    => 'publish',
                    'posts_per_page' => -1, // s·ªë l∆∞·ª£ng t·ªëi ƒëa
                ];
            }
            // ƒêa ng√¥n ng·ªØ WPML
            if ($lang !== '' && function_exists('icl_object_id')) {
                do_action('wpml_switch_language', $lang);
            }

            // SQL: ch·ªâ t√¨m trong post_title
            $like = '%' . $wpdb->esc_like($query) . '%';
            $sql  = $wpdb->prepare("
                SELECT ID, post_title, post_name, post_type, post_date
                FROM {$wpdb->posts}
                WHERE post_status = 'publish'
                AND post_type IN ('embed_post')
                AND post_title LIKE %s
                ORDER BY post_date DESC
                LIMIT 50
            ", $like);

            $results = $wpdb->get_results($sql);

            foreach ($results as $post) {
                $id    = $post->ID;
                $slug  = $post->post_name;

                // Title clean
                $title_clean = clean_post_title($post->post_title);

                // Rating
                if ($post->post_type === 'game-mobile') {
                    $rank = get_field('rating', $id);
                } else {
                    $rank = get_post_meta($id, 'rating', true) / 2;
                }
                $rank = $rank ? (string) $rank : '';

                // Views
                $views = (string) get_post_meta($id, 'views', true);

                // Tags
                $tags = '';
                if ($post->post_type === 'game-mobile') {
                    if (preg_match('/\((.*?)\)/', $post->post_title, $m)) {
                        $tags = trim($m[1]);
                    }
                } else {
                    $tags = "Game online";
                }

                // Date
                $date = date('Y-m-d', strtotime($post->post_date));

                // Image thumb + full
                $thumb = get_the_post_thumbnail_url($id, 'thumbnail') ?: '';
                $full  = get_the_post_thumbnail_url($id, 'full') ?: '';

                // First image trong content
                $content = get_post_field('post_content', $id);
                if (preg_match('/<img[^>]+src="([^">]+)"/i', $content, $img_match)) {
                    $first_image = $img_match[1];
                } else {
                    $first_image = $full;
                }

                $posts[] = [
                    'id'          => $id,
                    'name'        => $slug,
                    'title'       => $title_clean,
                    'link'        => get_permalink($id),
                    'image'       => $thumb,
                    'image_full'  => $full,
                    'rank'        => $rank,
                    'tags'        => $tags,
                    'date'        => $date,
                    'first_image' => $first_image,
                    'url'         => get_field('iframe', $id),
                    'direction'   => get_field('direction', $id) ?: 'Horizontal',
                ];
            }

            return new WP_REST_Response([
                'query'   => $query,
                'lang'    => $lang,
                'results' => $posts
            ], 200);
        },
        'permission_callback' => '__return_true'
    ]);
});
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/add-forum', [
        'methods'  => 'POST',
        'callback' => 'custom_add_forum_post',
        'permission_callback' => '__return_true',
    ]);

    register_rest_route('custom-api/v1', '/edit-forum', [
        'methods'  => 'POST',
        'callback' => 'custom_edit_forum_post',
        'permission_callback' => '__return_true',
    ]);

    register_rest_route('custom-api/v1', '/delete-forum', [
        'methods'  => 'POST',
        'callback' => 'custom_delete_forum_post',
        'permission_callback' => '__return_true',
    ]);

});
// ===== ADD =====
function custom_add_forum_post($request) {
    $params  = $request->get_params();
    $title   = sanitize_text_field($params['title'] ?? '');
    $content = sanitize_textarea_field($params['content'] ?? '');
    $author  = $params['user_id'] ?? 0;
    $name_game  = sanitize_text_field($params['name_game'] ?? ''); // üÜï name_game

    if (empty($title)) {
        return new WP_Error('invalid_input', 'Title is required', ['status' => 400]);
    }

    // T·∫°o post m·ªõi
    $post_id = wp_insert_post([
        'post_title'   => $title,
        'post_content' => $content,
        'post_status'  => 'draft',
        'post_type'    => 'forum',
        'post_author'  => 1, 
    ]);

    if (is_wp_error($post_id)) {
        return new WP_Error('insert_failed', 'Could not create post', ['status' => 500]);
    }

            update_field('user_id', $author, $post_id);
    update_field('name_game', $name_game, $post_id); // üÜï l∆∞u name_game

    // Upload ·∫£nh
    $uploaded_ids = [];
        if (!empty($_FILES['file'])) {
            $files = $_FILES['file'];
            $file_count = is_array($files['name']) ? count($files['name']) : 1;

            $uploaded_ids = [];
            $has_image = false;

            for ($i = 0; $i < $file_count; $i++) {
                if (empty($files['name'][$i])) continue;

                $file_array = [
                    'name'     => is_array($files['name']) ? $files['name'][$i] : $files['name'],
                    'type'     => is_array($files['type']) ? $files['type'][$i] : $files['type'],
                    'tmp_name' => is_array($files['tmp_name']) ? $files['tmp_name'][$i] : $files['tmp_name'],
                    'error'    => is_array($files['error']) ? $files['error'][$i] : $files['error'],
                    'size'     => is_array($files['size']) ? $files['size'][$i] : $files['size'],
                ];

                if (!function_exists('media_handle_upload')) {
                    require_once ABSPATH . 'wp-admin/includes/file.php';
                    require_once ABSPATH . 'wp-admin/includes/media.php';
                    require_once ABSPATH . 'wp-admin/includes/image.php';
                }

                $_FILES['upload_file'] = $file_array;
                $attach_id = media_handle_upload('upload_file', $post_id);

                if (!is_wp_error($attach_id)) {
                    $uploaded_ids[] = $attach_id;
                    $mime_type = get_post_mime_type($attach_id);

                    if (strpos($mime_type, 'image') !== false) {
                        $has_image = true;
                    }
                }
            }

            // N·∫øu c√≥ ·∫£nh th√¨ ch·ªâ l·∫•y 1 l·∫ßn (overwrite)
            if ($has_image && !empty($uploaded_ids)) {
                $acf_type = 'Gallery';

                // Update ACF gallery (ghi ƒë√®, kh√¥ng merge)
                update_field('gallery', $uploaded_ids, $post_id);

                // Set ·∫£nh ƒë·∫°i di·ªán = ·∫£nh ƒë·∫ßu ti√™n
                set_post_thumbnail($post_id, $uploaded_ids[0]);
            }
        }


    return [
        'success'  => true,
        'post_id'  => $post_id,
        'title'    => $title,
        'content'  => $content,
        'user_id'  => $author,
        'images'   => array_map('wp_get_attachment_url', $uploaded_ids),
                       'name_game' => $name_game,
        'link'     => get_permalink($post_id),
    ];
}



// ===== DELETE =====
function custom_delete_forum_post($request) {
    $params   = $request->get_params();
    $post_id  = intval($params['post_id'] ?? 0);
    $user_id  = sanitize_text_field($params['user_id'] ?? ''); // üÜï user_id b·∫Øt bu·ªôc

    if (!$post_id || empty($user_id)) {
        return new WP_Error('invalid_input', 'Thi·∫øu post_id ho·∫∑c user_id', ['status' => 400]);
    }

    $post = get_post($post_id);
    if (!$post) {
        return new WP_Error('invalid_post', 'Post not found', ['status' => 404]);
    }
    if ($post->post_type !== 'forum') {
        return new WP_Error('invalid_type', 'Only forum posts can be deleted', ['status' => 400]);
    }

    // üîë Check quy·ªÅn: user_id trong request ph·∫£i tr√πng v·ªõi ACF user_id c·ªßa post
    $post_user_id = get_field('user_id', $post_id);
    if ((string)$post_user_id !== (string)$user_id) {
        return new WP_Error('forbidden', 'B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a post n√†y', ['status' => 403]);
    }

    $deleted = wp_delete_post($post_id, true);

    if (!$deleted) {
        return new WP_Error('delete_failed', 'Could not delete post', ['status' => 500]);
    }

    return [
        'success' => true,
        'post_id' => $post_id,
        'user_id' => $user_id,
        'message' => 'Post deleted successfully',
    ];
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/add-forum-comment', [
        'methods'  => 'POST',
        'callback' => 'custom_add_forum_comment',
        'permission_callback' => '__return_true',
    ]);
});

function get_forum_user($acf_user_id) {
    // M·∫∑c ƒë·ªãnh
    $user = [
        'id'    => 'guest',
        'name'  => 'Anonymous',
        'image' => 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg',
    ];

    if (empty($acf_user_id)) {
        return $user;
    }

    // T√¨m post user-mobile theo ACF field "id"
    $user_query = new WP_Query([
        'post_type'      => 'user-mobile',
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $acf_user_id,
                'compare' => '='
            ]
        ],
        'posts_per_page' => 1
    ]);

    if ($user_query->have_posts()) {
        $user_post = $user_query->posts[0];

        $user['id']   = $acf_user_id;
        $user['name'] = get_field('name', $user_post->ID) ?: $acf_user_id;

        // Avatar
        $user_image_field = get_field('user_image', $user_post->ID);
        if (!empty($user_image_field)) {
            $user['image'] = $user_image_field;
        } else {
            $new_avatar = 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';
            update_field('user_image', $new_avatar, $user_post->ID);
            $user['image'] = $new_avatar;
        }
    }

    wp_reset_postdata();

    return $user;
}

/**
 * API Handler: Add forum comment
 */
function custom_add_forum_comment($request) {
    $params = $request->get_params();

    // === L·∫•y d·ªØ li·ªáu & sanitize ===
    $title     = sanitize_text_field($params['title'] ?? '');
    $author_id = sanitize_text_field($params['user_id'] ?? 'guest');
    $parent_id = intval($params['parent_id'] ?? 0);

    // === Validate input ===
    if (empty($title) || !$parent_id) {
        return new WP_Error('invalid_input', 'Thi·∫øu title ho·∫∑c parent_id', ['status' => 400]);
    }

    // === Ki·ªÉm tra post g·ªëc ===
    $parent_post = get_post($parent_id);
    if (!$parent_post || $parent_post->post_type !== 'forum') {
        return new WP_Error('invalid_parent', 'Parent forum post not found', ['status' => 404]);
    }

    // === T·∫°o forum comment (post con) ===
    $comment_id = wp_insert_post([
        'post_title'  => $title,
        'post_status' => 'draft',
        'post_type'   => 'forum',
        'post_author' => 1, // c√≥ th·ªÉ c·ªë ƒë·ªãnh admin
    ]);

    if (is_wp_error($comment_id) || !$comment_id) {
        return new WP_Error('insert_failed', 'Could not create forum comment', ['status' => 500]);
    }

    // === L∆∞u ACF fields ===
    update_field('user_id', $author_id, $comment_id);
    update_field('parent_forum_id', $parent_id, $comment_id);

    // === L·∫•y d·ªØ li·ªáu user qua helper ===
    $user_info = function_exists('get_forum_user') ? get_forum_user($author_id) : [
        'id'    => $author_id,
        'name'  => 'Anonymous',
        'image' => 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg',
    ];

    // L·∫•y th·ªùi gian GMT
    $created_gmt = get_post_time('Y-m-d H:i:s', true, $comment_id);

    // Convert sang gi·ªù local (timezone WP setting, v√≠ d·ª• Asia/Ho_Chi_Minh)
    $created_time = get_date_from_gmt($created_gmt, 'Y-m-d H:i:s');

    // UNIX timestamp local
    $created_at = strtotime($created_time);

    // Human readable
    $human_time = human_time_diff($created_at, current_time('timestamp')) . ' ago';


    // === Tr·∫£ v·ªÅ JSON ===
    return [
        'success'      => true,
        'comment_id'   => $comment_id,
        'parent_id'    => $parent_id,
        'title'        => $title,

        // User info
        'user_id'      => $user_info['id'],
        'user_name'    => $user_info['name'],
        'user_image'   => $user_info['image'],

        'date'         => $human_time,   // v√≠ d·ª• "2 minutes ago"

        'message'      => 'Comment forum created successfully',
        'link'         => get_permalink($comment_id),
    ];
}
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/toggle-like', [
        'methods'  => 'GET',
        'callback' => 'custom_toggle_like',
        'permission_callback' => '__return_true',
    ]);
});

function custom_toggle_like($request) {
    $user_id = sanitize_text_field($request->get_param('user_id') ?? '');
    $post_id = intval($request->get_param('post_id') ?? 0);

    if (empty($user_id) || !$post_id) {
        return new WP_Error('invalid_input', 'Thi·∫øu user_id ho·∫∑c post_id', ['status' => 400]);
    }

    // === L·∫•y danh s√°ch user_id ƒë√£ like t·ª´ ACF field ===
    $liked_users = get_field('liked_users', $post_id);
    if (!is_array($liked_users)) {
        $liked_users = [];
    }

    // === Ki·ªÉm tra user n√†y ƒë√£ like ch∆∞a ===
    $has_liked_before = in_array($user_id, $liked_users);

    if ($has_liked_before) {
        // N·∫øu ƒë√£ like => unlike
        $liked_users = array_diff($liked_users, [$user_id]);
        $action = 'unliked';
        $message = 'ƒê√£ b·ªè like b√†i vi·∫øt';
        $is_like = false;
    } else {
        // N·∫øu ch∆∞a like => like
        $liked_users[] = $user_id;
        $action = 'liked';
        $message = 'ƒê√£ like b√†i vi·∫øt';
        $is_like = true;
    }

    // C·∫≠p nh·∫≠t danh s√°ch user_id ƒë√£ like
    update_field('liked_users', array_values($liked_users), $post_id);

    // C·∫≠p nh·∫≠t t·ªïng s·ªë like
    $total_likes = count($liked_users);
    update_field('like_count_post', $total_likes, $post_id);

    return [
        'success'     => true,
        'action'      => $action,         // 'liked' ho·∫∑c 'unliked'
        'message'     => $message,
        'user_id'     => $user_id,
        'post_id'     => $post_id,
        'post_likes'  => $total_likes,    // t·ªïng s·ªë like m·ªõi nh·∫•t
        'is_like'     => $is_like         // ‚úÖ true n·∫øu user ƒëang like, false n·∫øu ƒë√£ b·ªè like
    ];
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/add-payment-info', [
        'methods'             => 'GET', // ‚úÖ ch·ªâ GET
        'callback'            => 'custom_add_payment',
        'permission_callback' => '__return_true',
    ]);
});

function custom_add_payment(WP_REST_Request $request) {
    // ‚úÖ Nh·∫≠n user_id t·ª´ app (meta field "id" trong post type user-mobile)
    $user_id        = sanitize_text_field($request->get_param('user_id'));
    $account_holder = sanitize_text_field($request->get_param('account_holder')); // ‚úÖ t√™n ng∆∞·ªùi d√πng
    $gmail          = sanitize_email($request->get_param('gmail')); // ‚úÖ ƒë·ªãa ch·ªâ Gmail m·ªõi

    // ‚úÖ 1. Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
    if (empty($user_id) || empty($account_holder) || empty($gmail)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => '‚ùå Missing required fields: user_id, account_holder, gmail'
        ], 400);
    }

    // ‚úÖ 2. T√¨m post `user-mobile` theo meta key "id"
    $user_query = new WP_Query([
        'post_type'      => 'user-mobile',
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]
        ],
        'posts_per_page' => 1
    ]);

    if (!$user_query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => '‚ùå User not found with given user_id'
        ], 404);
    }

    // ‚úÖ 3. L·∫•y ID th·∫≠t c·ªßa post user-mobile
    $user_post    = $user_query->posts[0];
    $real_post_id = $user_post->ID;

    // ‚úÖ 4. C·∫≠p nh·∫≠t th√¥ng tin thanh to√°n v√†o ACF
    update_field('payment_info_account_holder', $account_holder, $real_post_id);
    update_field('payment_info_gmail', $gmail, $real_post_id); // üëà ƒë·ªïi th√†nh gmail

    // ‚úÖ 5. L·∫•y s·ªë ti·ªÅn t·ª´ ACF (n·∫øu c√≥)

    // ‚úÖ 6. Tr·∫£ v·ªÅ k·∫øt qu·∫£ JSON
    return new WP_REST_Response([
        'success'        => true,
        'message'        => '‚úÖ Payment info updated successfully',
        'user_id'        => $user_id,
        'post_id'        => $real_post_id,
        'account_holder' => $account_holder,
        'gmail'          => $gmail,         // üëà tr·∫£ gmail thay v√¨ account_number
    ], 200);
}
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/edit-user-info', [
        'methods'             => 'POST',
        'callback'            => 'custom_edit_user_info',
        'permission_callback' => '__return_true',
    ]);
});
function custom_edit_user_info(WP_REST_Request $request) {
    $user_id = sanitize_text_field($request->get_param('user_id'));
    $name    = sanitize_text_field($request->get_param('name'));
    $image_url_param = esc_url_raw($request->get_param('user_image_url')); // üÜï URL ·∫£nh g·ª≠i tr·ª±c ti·∫øp

    if (empty($user_id)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => '‚ùå Missing user_id'
        ], 400);
    }

    // ‚úÖ L·∫•y post user t·ª´ ACF `id`
    $args = [
        'post_type'  => 'user-mobile',
        'meta_query' => [
            [
                'key'   => 'id',
                'value' => $user_id,
                'compare' => '='
            ]
        ],
        'posts_per_page' => 1
    ];

    $user_posts = get_posts($args);
    if (empty($user_posts)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => '‚ùå User not found'
        ], 404);
    }

    $user_post = $user_posts[0];
    $post_id   = $user_post->ID;

    // ‚úÖ C·∫≠p nh·∫≠t name n·∫øu c√≥
    if (!empty($name)) {
        update_field('name', $name, $post_id);
    }

    // ‚úÖ 1Ô∏è‚É£ N·∫øu c√≥ upload ·∫£nh file qua form-data
    if (!empty($_FILES['user_image'])) {
        $file = $_FILES['user_image'];

        require_once(ABSPATH . 'wp-admin/includes/file.php');
        require_once(ABSPATH . 'wp-admin/includes/media.php');
        require_once(ABSPATH . 'wp-admin/includes/image.php');

        $upload_overrides = ['test_form' => false];
        $movefile = wp_handle_upload($file, $upload_overrides);

        if ($movefile && !isset($movefile['error'])) {
            $image_url = $movefile['url'];
            update_field('user_image', $image_url, $post_id);
        } else {
            return new WP_REST_Response([
                'success' => false,
                'message' => '‚ùå Upload failed: ' . $movefile['error']
            ], 500);
        }
    }

    // ‚úÖ 2Ô∏è‚É£ N·∫øu c√≥ g·ª≠i URL ·∫£nh tr·ª±c ti·∫øp (∆∞u ti√™n n·∫øu kh√¥ng c√≥ file upload)
    if (!empty($image_url_param)) {
        update_field('user_image', $image_url_param, $post_id);
    }

    // ‚úÖ L·∫•y l·∫°i d·ªØ li·ªáu sau khi c·∫≠p nh·∫≠t
    $updated_name  = get_field('name', $post_id);
    $updated_image = get_field('user_image', $post_id);

    return new WP_REST_Response([
        'success' => true,
        'message' => '‚úÖ User info updated successfully',
        'data' => [
            'user_id'    => $user_id,
            'name'       => $updated_name,
            'user_image' => $updated_image
        ]
    ], 200);
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/get-user-info', [
        'methods'             => 'GET',
        'callback'            => 'custom_get_user_info',
        'permission_callback' => '__return_true',
    ]);
});

function custom_get_user_info(WP_REST_Request $request) {
    $user_id = sanitize_text_field($request->get_param('user_id'));

    if (empty($user_id)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => '‚ùå Missing user_id'
        ], 400);
    }

    // ‚úÖ T√¨m post user t·ª´ ACF field `id`
    $args = [
        'post_type'  => 'user-mobile',
        'meta_query' => [
            [
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]
        ],
        'posts_per_page' => 1
    ];

    $user_posts = get_posts($args);

    if (empty($user_posts)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => '‚ùå User not found'
        ], 404);
    }

    $user_post = $user_posts[0];
    $post_id   = $user_post->ID;

    // ‚úÖ L·∫•y name & avatar t·ª´ ACF
    $user_name  = get_field('name', $post_id);
    $user_image = get_field('user_image', $post_id);

    return new WP_REST_Response([
        'success' => true,
        'message' => '‚úÖ User info fetched successfully',
        'data'    => [
            'user_id'    => $user_id,
            'name'       => $user_name ?: '',
            'user_image' => $user_image ?: ''
        ]
    ], 200);
}

// ‚úÖ 1. ƒêƒÉng k√Ω post_type messenger
add_action('init', function () {
    register_post_type('messenger', [
        'labels' => [
            'name'          => 'Messenger',
            'singular_name' => 'Message',
            'add_new'       => 'T·∫°o h·ªôi tho·∫°i',
            'edit_item'     => 'Xem & Tr·∫£ l·ªùi',
        ],
        'public'              => false,
        'publicly_queryable'  => false,
        'exclude_from_search' => true,
        'show_ui'             => true,
        'show_in_menu'        => true,
        'menu_icon'           => 'dashicons-email',
        'supports'            => ['title'],
        'has_archive'         => false,
        'rewrite'             => false,
    ]);
});

// ‚úÖ 2. ·∫®n truy v·∫•n tr·ª±c ti·∫øp ngo√†i frontend
add_action('pre_get_posts', function ($query) {
    if (!is_admin() && $query->get('post_type') === 'messenger') {
        $query->set_404();
    }
});

// ‚úÖ 3. API g·ª≠i tin nh·∫Øn (ƒëa ·∫£nh, h·ªó tr·ª£ ti·∫øng Vi·ªát)
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/send-message', [
        'methods'             => 'POST',
        'callback'            => 'custom_send_message_json',
        'permission_callback' => '__return_true',
    ]);
});

function custom_send_message_json(WP_REST_Request $request) {
    $user_id = sanitize_text_field($request->get_param('user_id'));
    // ‚úÖ Cho ph√©p ti·∫øng Vi·ªát + emoji
    $content = wp_kses_post(wp_unslash($request->get_param('content')));

    // ‚úÖ X·ª≠ l√Ω nhi·ªÅu ·∫£nh
    $uploaded_images = [];
    if (!empty($_FILES['images'])) {
        require_once ABSPATH . 'wp-admin/includes/file.php';
        require_once ABSPATH . 'wp-admin/includes/media.php';
        require_once ABSPATH . 'wp-admin/includes/image.php';

        $files = $_FILES['images'];
        for ($i = 0; $i < count($files['name']); $i++) {
            if ($files['error'][$i] === 0) {
                $file = [
                    'name'     => $files['name'][$i],
                    'type'     => $files['type'][$i],
                    'tmp_name' => $files['tmp_name'][$i],
                    'error'    => $files['error'][$i],
                    'size'     => $files['size'][$i]
                ];
                $_FILES['single_image'] = $file;
                $attachment_id = media_handle_upload('single_image', 0);
                if (!is_wp_error($attachment_id)) {
                    $uploaded_images[] = wp_get_attachment_url($attachment_id);
                }
            }
        }
    }

    if (empty($user_id) && empty($content) && empty($uploaded_images)) {
        return wp_send_json(['success' => false, 'message' => 'üö´ Thi·∫øu n·ªôi dung ho·∫∑c ·∫£nh'], 400, JSON_UNESCAPED_UNICODE);
    }

    // ‚úÖ Ki·ªÉm tra h·ªôi tho·∫°i
    $existing = get_posts([
        'post_type'      => 'messenger',
        'meta_key'       => 'user_id',
        'meta_value'     => $user_id,
        'posts_per_page' => 1,
    ]);

    $post_id = $existing ? $existing[0]->ID : wp_insert_post([
        'post_type'   => 'messenger',
        'post_title'  => 'Messenger - ' . $user_id,
        'post_status' => 'publish',
    ]);

    update_post_meta($post_id, 'user_id', $user_id);

    $messages = get_post_meta($post_id, 'messages', true);
    $messages = $messages ? json_decode($messages, true) : [];

    $messages[] = [
        'sender'    => $user_id,
        'role'      => 'user',
        'content'   => $content,
        'images'    => $uploaded_images,
        'timestamp' => current_time('mysql'),
        'is_read'   => false
    ];

    update_post_meta($post_id, 'messages', wp_json_encode($messages, JSON_UNESCAPED_UNICODE));

    return wp_send_json([
        'success' => true,
        'message' => '‚úÖ Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c l∆∞u',
        'post_id' => $post_id,
        'images'  => $uploaded_images
    ], 200, JSON_UNESCAPED_UNICODE);
}

// ‚úÖ 4. Giao di·ªán h·ªôi tho·∫°i admin
add_action('add_meta_boxes', function () {
    add_meta_box(
        'messenger_chat_box',
        'üí¨ H·ªôi tho·∫°i & Tr·∫£ l·ªùi ng∆∞·ªùi d√πng',
        'render_messenger_chat_box',
        'messenger',
        'normal',
        'high'
    );
});

function render_messenger_chat_box($post) {
    $messages = get_post_meta($post->ID, 'messages', true);
    $messages = $messages ? json_decode($messages, true) : [];

    echo "<div style='max-height:350px;overflow-y:auto;padding:10px;background:#f9f9f9;border:1px solid #ccc;margin-bottom:15px'>";
    if ($messages) {
        foreach ($messages as $msg) {
            $align = $msg['role'] === 'admin' ? 'right' : 'left';
            $bg = $msg['role'] === 'admin' ? '#e3f2fd' : '#f1f8e9';
            echo "<div style='text-align:$align;margin-bottom:8px;'>";
            echo "<div style='display:inline-block;background:$bg;padding:8px 12px;border-radius:12px;max-width:80%;word-wrap:break-word;'>";

            echo "<strong>" . esc_html($msg['role']) . ":</strong> " . wp_kses_post($msg['content']);

            if (!empty($msg['images']) && is_array($msg['images'])) {
                echo "<div style='margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;'>";
                foreach ($msg['images'] as $img) {
                    echo "<img src='" . esc_url($img) . "' style='max-width:100px;border-radius:6px;'>";
                }
                echo "</div>";
            }

            echo "<div style='font-size:11px;color:#777;margin-top:3px;'>" . esc_html($msg['timestamp']) . "</div>";
            echo "</div></div>";
        }
    } else {
        echo "<em>üì≠ Ch∆∞a c√≥ tin nh·∫Øn n√†o.</em>";
    }
    echo "</div>";

    wp_nonce_field('admin_reply_nonce_action', 'admin_reply_nonce');
    echo '<textarea name="admin_reply" rows="3" style="width:100%;" placeholder="Nh·∫≠p n·ªôi dung tr·∫£ l·ªùi..."></textarea>';
    echo '<p><input type="file" name="admin_reply_images[]" accept="image/*" multiple></p>';
    echo '<p><button type="submit" class="button button-primary">üì® G·ª≠i tr·∫£ l·ªùi</button></p>';
}

// ‚úÖ 5. L∆∞u tr·∫£ l·ªùi admin
add_action('save_post_messenger', function ($post_id) {
    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
    if (wp_is_post_revision($post_id)) return;
    if (get_post_type($post_id) !== 'messenger') return;
    if (!isset($_POST['admin_reply_nonce']) || !wp_verify_nonce($_POST['admin_reply_nonce'], 'admin_reply_nonce_action')) return;

    $reply = wp_kses_post(wp_unslash($_POST['admin_reply']));
    $uploaded_images = [];

    if (isset($_FILES['admin_reply_images']) && !empty($_FILES['admin_reply_images']['name'][0])) {
        require_once ABSPATH . 'wp-admin/includes/file.php';
        require_once ABSPATH . 'wp-admin/includes/media.php';
        require_once ABSPATH . 'wp-admin/includes/image.php';

        $files = $_FILES['admin_reply_images'];
        foreach ($files['name'] as $index => $name) {
            if ($files['error'][$index] === 0) {
                $file = [
                    'name'     => $files['name'][$index],
                    'type'     => $files['type'][$index],
                    'tmp_name' => $files['tmp_name'][$index],
                    'error'    => $files['error'][$index],
                    'size'     => $files['size'][$index],
                ];
                $_FILES['single_admin_image'] = $file;

                $attachment_id = media_handle_upload('single_admin_image', 0);
                if (!is_wp_error($attachment_id)) {
                    $uploaded_images[] = wp_get_attachment_url($attachment_id);
                }
            }
        }
    }

    if (empty($reply) && empty($uploaded_images)) return;

    $messages = get_post_meta($post_id, 'messages', true);
    $messages = $messages ? json_decode($messages, true) : [];

    $messages[] = [
        'sender'    => 'admin',
        'role'      => 'admin',
        'content'   => $reply,
        'images'    => $uploaded_images,
        'timestamp' => current_time('mysql'),
        'is_read'   => true
    ];

    update_post_meta($post_id, 'messages', wp_json_encode($messages, JSON_UNESCAPED_UNICODE));
});

// ‚úÖ 6. API l·∫•y to√†n b·ªô tin nh·∫Øn (tr·∫£ v·ªÅ ti·∫øng Vi·ªát r√µ r√†ng)
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/get-messages', [
        'methods'             => 'GET',
        'callback'            => 'custom_get_messages_json',
        'permission_callback' => '__return_true',
    ]);
});

function custom_get_messages_json(WP_REST_Request $request) {
    $acf_user_id = sanitize_text_field($request->get_param('user_id'));
    if (empty($acf_user_id)) {
        return wp_send_json(['success' => false, 'message' => 'üö´ Missing user_id'], 400, JSON_UNESCAPED_UNICODE);
    }

    $user_id    = 'guest';
    $user_name  = 'Anonymous';
    $user_image = 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';

    $user_query = new WP_Query([
        'post_type'      => 'user-mobile',
        'meta_query'     => [[ 'key' => 'id', 'value' => $acf_user_id, 'compare' => '=' ]],
        'posts_per_page' => 1
    ]);

    if ($user_query->have_posts()) {
        $user_post       = $user_query->posts[0];
        $user_id         = $acf_user_id;
        $user_name       = get_field('name', $user_post->ID) ?: $acf_user_id;
        $user_image_field = get_field('user_image', $user_post->ID);
        $user_image      = !empty($user_image_field) ? $user_image_field : $user_image;
    }
    wp_reset_postdata();

    $existing = get_posts([
        'post_type'      => 'messenger',
        'meta_key'       => 'user_id',
        'meta_value'     => $acf_user_id,
        'posts_per_page' => 1,
    ]);

    if (!$existing) {
        return wp_send_json([
            'success' => false,
            'message' => 'üì≠ No conversation found',
            'user'    => [ 'id' => $user_id, 'name' => $user_name, 'avatar' => $user_image ]
        ], 200, JSON_UNESCAPED_UNICODE);
    }

    $post_id  = $existing[0]->ID;
    $messages = get_post_meta($post_id, 'messages', true);
    $messages = $messages ? json_decode($messages, true) : [];

    usort($messages, fn($a, $b) => strtotime($a['timestamp']) - strtotime($b['timestamp']));

    return wp_send_json([
        'success'     => true,
        'post_id'     => $post_id,
        'user_id'     => $user_id,
        'user_name'   => $user_name,
        'user_image'  => $user_image,
        'messages'    => $messages,
        'total'       => count($messages)
    ], 200, JSON_UNESCAPED_UNICODE);
}

add_action('post_edit_form_tag', function () {
    echo ' enctype="multipart/form-data"';
});


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/check-user', [
        'methods'             => 'GET',
        'callback'            => 'custom_check_user_exists',
        'permission_callback' => '__return_true',
    ]);
});

function custom_check_user_exists(WP_REST_Request $request) {
    $acf_user_id = sanitize_text_field($request->get_param('user_id'));

    if (empty($acf_user_id)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'üö´ Missing user_id parameter'
        ], 400);
    }

    // ‚úÖ T√¨m user trong post_type "user-mobile"
    $user_query = new WP_Query([
        'post_type'  => 'user-mobile',
        'meta_query' => [[
            'key'     => 'id',
            'value'   => $acf_user_id,
            'compare' => '='
        ]],
        'posts_per_page' => 1
    ]);

    if ($user_query->have_posts()) {
        $user_post = $user_query->posts[0];

        $user_name  = get_field('name', $user_post->ID) ?: $acf_user_id;
        $user_image = get_field('user_image', $user_post->ID) ?: 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';

        return new WP_REST_Response([
            'success'     => true,
            'exists'      => true,
            'user_id'     => $acf_user_id,
            'user_name'   => $user_name,
            'user_image'  => $user_image,
            'post_id'     => $user_post->ID,
            'message'     => '‚úÖ user_id exists in user-mobile'
        ], 200);
    }

    return new WP_REST_Response([
        'success' => true,
        'exists'  => false,
        'message' => 'üì≠ user_id not found in user-mobile'
    ], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/translate', [
        'methods'             => 'GET',
        'callback'            => 'custom_translate_strings_by_user',
        'permission_callback' => '__return_true',
    ]);
});

function custom_translate_strings_by_user(WP_REST_Request $request) {
    $user_id = sanitize_text_field($request->get_param('user_id'));

    if (empty($user_id)) {
        return wp_send_json([
            'success' => false,
            'message' => 'üö´ Missing user_id parameter'
        ], 400, JSON_UNESCAPED_UNICODE);
    }

    // üîç L·∫•y language t·ª´ user-mobile
    $query = new WP_Query([
        'post_type'  => 'user-mobile',
        'meta_query' => [[
            'key'     => 'id',
            'value'   => $user_id,
            'compare' => '='
        ]],
        'posts_per_page' => 1
    ]);

    if (!$query->have_posts()) {
        return wp_send_json([
            'success' => false,
            'message' => 'üö´ User not found'
        ], 404, JSON_UNESCAPED_UNICODE);
    }

    $post      = $query->posts[0];
    $user_lang = get_post_meta($post->ID, 'language', true) ?: 'en'; // ‚úÖ m·∫∑c ƒë·ªãnh ti·∫øng Anh

    // ‚úÖ Chu·ªói g·ªëc (ti·∫øng Anh)
    $strings = [
        'alphaFlame' => 'Game ID not found',
               'alphaFlare' => 'Please download the game before rating.',
        'alphaHawk' => 'No download link',
        'alphaMist' => 'Error while processing data',
        'alphaRay' => 'Connection error',
        'alphaSpin' => 'APK file does not exist',
        'azureBlaze' => 'No content to translate yet',
        'azureFire' => 'Error opening Google Translate',
        'azureFlame' => 'Error when unliking',
        'azureHeart' => 'Error when liking comment',
        'azureShadow' => 'Game Fragment Opened',
        'azureSpark' => 'Please enter content',
        'azureWing' => 'Post ID not found',
        'betaArrow' => 'You can only select up to 5 photos',
        'betaBolt' => 'Cannot read image file',
        'betaClaw' => 'Error reading image file',
        'betaEcho' => 'Review submitted',
        'betaFlame' => 'Error submitting review',
        'betaFlare' => 'Maximum 5 photos!',
        'betaFlash' => 'APK file does not exist. Please download again',
        'betaGhost' => 'Installation file deleted',
        'betaLeaf' => 'Unable to delete file',
        'betaPulse' => 'Unable to open the app',
        'betaRay' => 'Please fill in all required information',
        'betaRider' => 'üëã Hello, ',
        'betaSky' => 'Login failed: ',
        'betaWalker' => 'Wrong account or password',
        'betaWing' => 'Please enter username',
        'blazeArrow' => 'Please enter email',
        'blazeBreeze' => 'Invalid email!',
        'blazeClaw' => 'Please enter verification code',
        'blazeFlare' => 'Incorrect verification code!',
        'blazeFlash' => 'Invalid verification code!',
        'blazeGhost' => 'Email is invalid or not registered!',
        'blazeMist' => 'Connection error!',
        'blazeRain' => 'Username does not exist!',
        'blazeRay' => 'Connection error!',
        'blazeShadow' => 'Please enter the full new password',
        'blazeWalker' => 'Passwords do not match!',
        'blazeWing' => 'Encode error!',
        'charlieArrow' => 'Password changed successfully!',
        'charlieBreeze' => 'Failed to change password!',
        'charlieFire' => 'Connection error!',
        'charlieFlare' => 'Data loading error',
        'charlieFlash' => 'Please enter the correct username and password',
        'charlieGhost' => 'Error: ',
        'charlieHawk' => 'Username or Gmail has been registered',
        'charlieLeaf' => 'Please enter content',
        'charlieLight' => 'Post ID not found',
        'charlieRain' => 'No content to translate',
        'charlieRay' => 'Error opening Google Translate',
        'charlieSpark' => 'Cannot read image file',
        'charlieSpin' => 'Error reading image file',
        'charlieStone' => 'Comment sent',
        'charlieStormy' => 'Failed to send comment: ',
        'charlieWalker' => 'You can only select up to 5 images',
        'cobaltBreeze' => 'No content to translate',
        'cobaltEcho' => 'Error opening Google Translate',
        'cobaltFire' => 'Error unliking',
        'cobaltFlame' => 'Error liking',
        'cobaltFlash' => 'Device does not support voice input',
        'cobaltGlow' => 'User code copied to clipboard',
        'cobaltLight' => 'Device not supported (API 26)',
        'cobaltRay' => 'Data processing error',
        'cobaltShadow' => 'Maximum 5 images!',
        'language_updated' => 'Language updated',
        'back' => 'Back',
        'language' => 'Language',
        'english' => 'English',
        'portuguese' => 'Portuguese',
        'indonesian' => 'Indonesian',
        'spanish' => 'Spanish',
        'cobaltStormy' => 'Featured',
        'cobaltWave' => 'Game',
        'cobaltWing' => 'App',
        'cosmicBolt' => '100% Online',
        'cosmicBreeze' => 'Download',
        'cosmicFang' => 'More',
        'cosmicFire' => 'Popular',
        'cosmicLight' => 'New',
        'cosmicRay' => 'Category',
        'cosmicSteel' => 'More',
        'cosmicStrike' => 'Mini games',
        'cosmicWalker' => 'Install',
        'cosmicWing' => 'Download Manager',
        'crimsonArrow' => 'Downloading',
        'crimsonBreeze' => 'No apps downloaded',
        'crimsonFire' => 'No app downloads',
        'crimsonFlame' => 'No applications installed',
        'crimsonFlare' => 'Version',
        'crimsonGhost' => 'Connect ...',
        'crimsonHeart' => 'Me',
        'crimsonLeaf' => 'Edit',
        'crimsonRay' => 'Management',
        'crimsonRider' => 'Downloaded',
        'crimsonSpark' => 'Not reviewed yet',
        'crimsonWave' => 'Message',
        'darkClaw' => 'Reply',
        'darkFlame' => 'Follow us on Telegram',
        'darkFlare' => 'Official website',
        'darkGhost' => 'Upload',
        'darkHeart' => 'Request',
        'darkIce' => 'Feedback',
        'darkLight' => 'Share',
        'darkRain' => 'Check for updates',
        'darkShadow' => 'Policy and Privacy',
        'darkWalker' => 'Mobile network warning',
        'darkWing' => 'Show message when installing',
        'deltaBlaze' => 'Show message after installation',
        'deltaBreeze' => 'Light mode',
        'deltaEcho' => 'Download folder',
        'deltaFlash' => 'Other',
        'deltaIce' => 'Language',
        'deltaLeaf' => 'User name',
        'deltaRain' => 'Clear cache',
        'deltaRay' => 'memory index',
        'deltaStorm' => 'Flash game',
        'deltaStormy' => 'Logout',
        'echoArrow' => 'English',
        'echoBreeze' => 'Recommended',
        'echoFang' => 'Score',
        'echoFire' => 'Users',
        'echoFlame' => 'Downloads',
        'echoFlare' => 'Download',
        'echoFlash' => 'MOD Info',
        'echoHawk' => 'Description:',
        'echoIce' => 'Rate it',
        'echoLight' => 'Write a review',
        'echoPulse' => 'Rating & review',
        'echoRider' => 'Helpful',
        'echoShadow' => 'View all reviews',
        'echoSpark' => 'ratings',
        'echoStorm' => 'All mod apks are uploaded by users.If there √≠ any infringenent, please send DMCA cmplaint to us.',
        'echoStormy' => 'Details',
        'echoWing' => 'Other information',
        'emberClaw' => 'Comment',
        'emberFlame' => 'Translation',
        'emberGhost' => 'All reviews',
        'emberHawk' => 'Game',
        'emberLight' => 'App',
        'emberMist' => 'Username',
        'emberRain' => 'Enter your username',
        'emberRider' => 'Password',
        'emberShadow' => 'Enter your password',
        'emberWave' => 'Register as a new user',
        'fireArrow' => 'Recover Facebook account',
        'fireBolt' => 'Forgot your password?',
        'fireFlare' => '<u>Terms of service</u>',
        'fireFlash' => '<u>Privacy policy</u>',
        'fireMist' => 'Username (4-50 characters)',
        'fireRay' => 'Password (6-8 characters)',
        'fireShadow' => 'Email (Optional)',
        'fireWing' => 'Phone Number (optional)',
        'flameBreeze' => 'Phone Number',
        'flameClaw' => 'Sign Up',
        'flameEcho' => 'When you forget your password, you will need your Phone Number or Email to retrieve it. We recommend that you complete them.',
        'flameFlare' => 'By registering, you agree to ',
        'flameMist' => 'Only letters a-z, numbers (no spaces or other special characters). 4-50 characters.',
        'flameRain' => 'Only letters A-Z, a-z, numbers (no spaces or other special characters). 6-8 characters.',
        'flameShadow' => 'Reset Password',
        'flameSpark' => 'Enter your account username to reset your password. Are you having trouble resetting your contact.us password',
        'flameStorm' => 'Next',
        'flameStrike' => 'Please enter your email or phone number. Are you having trouble resetting your contact.us password',
        'flameWave' => 'Enter your Gmail',
        'flameWing' => 'Can‚Äôt remember any of them? Please <u>sign up a new account.</u>',
        'foxtrotFire' => 'Code',
        'foxtrotFlare' => 'Enter the code sent to your email',
        'foxtrotFlash' => 'New Password',
        'foxtrotMist' => 'Enter New Password',
        'foxtrotPulse' => 'Please Re-enter New Password',
        'foxtrotRain' => 'Hot Search',
        'foxtrotRay' => 'History',
        'foxtrotSpin' => '‚ñ∂ Video has been verified',
        'foxtrotStone' => 'ü™ü no window',
        'foxtrotWalker' => 'Update Notice',
        'foxtrotWave' => 'Notify when there is a new version of the game',
        'foxtrotWing' => 'New update',
        'frostClaw' => 'New version just released. Update now!',
        'frostEcho' => 'No games available',
        'frostFlash' => 'Recommended app mods',
        'frostGlow' => 'Hot mod',
        'frostLeaf' => 'Today‚Äôs suggestion',
        'setting' => 'Setting',
        'frostLight' => '100% Play game',
        'frostSpin' => 'Translation',
        'frostWave' => 'New version',
        'frostWing' => 'Update now',
        'ghostArrow' => 'Download the app at:',
        'ghostFlare' => 'via',
        'ghostFlash' => 'My reviews',
        'ghostGhost' => 'My replies',
        'ghostGlow' => 'Games Online',
        'ghostIce' => '100% Online',
        'ghostLeaf' => 'APK MOD',
        'ghostLight' => 'Remaining',
        'ghostRay' => 'second',
        'ghostSpark' => 'Download successful! Click to install',
        'ghostSpin' => 'minute',
        'ghostSpil' => 'Tavern',
        'label_select' => 'Select',
        'label_check_in' => 'Check in',
        'label_checked_in' => 'Checked in',
        'status_upcoming' => 'Upcoming',
        'status_past' => 'Past',
        'title_monthly_checkin' => 'Monthly check-in',
        'label_day' => 'day',
        'ghostSteel' => 'No search results',
        'opening' => 'Opening...',
        'opening_in_browser' => 'Opening in browser...',
        'opened_browser_success' => 'Successfully opened browser',
        'error_starting_activity' => 'Error starting activity:',
        'choose_browser' => 'Choose browser',
        'error_opening_link' => 'Error opening link:',
        'no_content_to_translate' => 'No content to translate',
        'no_url_to_open' => 'No URL to open',
        'forum_post_label' => 'Forum post:',
        'forum_render_error' => 'Error rendering forum post:',
        'error_opening_translation' => 'Error opening translation',
        'yes' => 'Yes',
        'game_not_found' => 'Game not found',
        'missing_forum_id' => 'Missing forum_id',
        'api_success_false' => 'API returned success=false',
        'data_error' => 'Data error',
        'failed_to_load_data' => 'Failed to load data',
        'data_display_error' => 'Data display error',
        'error_open_post_link_in_browser' => 'Error in openPostLinkInBrowser:',
        'related_post' => 'related post',
        'error_parse_related_posts' => 'Error parsing related_posts:',
        'error_api_post_detail' => 'API error for post-detail:',
        'say_something' => 'Say something...',
        'confirmDelete' => 'Confirm deletion',
        'areYouSure' => 'Are you sure you want to delete this file?',
        'delete' => 'Delete',
        'cancel' => 'Cancel',
        'terms_of_service' => '<u>Terms of service</u>',
        'terms_of_service_2' => '<u>Privacy policy</u>',
        'terms_of_service_3' => 'Can‚Äôt remember any of them? Please <u>sign up a new account.</u>',
        'publish' => 'Publish',
        'add_catchy_title' => 'Add a catchy title to get more views',
        'write_thoughts_here' => 'Write your thoughts here (try some ready ideas üí°)',
        'pick_a_game' => 'Pick a game',
        'failed_to_load_games' => 'Failed to load games',
        'please_enter_title_content' => 'Please enter title and content',
        'please_select_game_before_publishing' => 'Please select a game before publishing',
        'max_photos_warning' => 'You can only select up to 5 photos',
        'sent_wait_for_approval' => 'Sent! Please wait for admin approval',

        'for_you' => 'For you',
        'congratulations_reward' => 'Congratulations, you will receive:',
        'fill_info_to_receive_reward' => 'Fill in information to receive reward üéä',
        'enter_your_name' => 'Enter your name',
        'enter_gmail_reward' => 'Enter Gmail to receive reward',
        'send' => 'Send',

        'user_id_not_found' => '‚ùå User ID not found. Please log in again.',
        'please_fill_all_fields' => '‚ö†Ô∏è Please fill in all fields',
        'failed_to_connect_server' => '‚ùå Failed to connect to server',
        'cannot_check_payment_status' => '‚ö†Ô∏è Cannot check payment status',

        'type_a_message' => 'Type a message...',
        'sending_failed' => '‚ùå Sending failed:',
        'message_sending_failed' => '‚ùå Message sending failed',
        'hello_admin_will_reply' => 'üëã Hello! Thank you for contacting us. Admin will respond as soon as possible ‚ù§Ô∏è',
        'unable_to_load_message' => 'Unable to load message:',
        'add_catchy_title'    => 'Add a catchy title',
        'write_thoughts_here' => 'Write your thoughts here',
        'notifications' => 'Notifications',
        'payment_info_sent' => 'Payment information sent successfully, please wait for admin to confirm and pay.',
        'please_login_first'           => 'Please login first',
        'game_link_not_available'      => 'Game link not available',
        'pending_approval'             => 'Pending approval...',
        'comment_sent_waiting'         => 'Comment sent! Waiting for approval...',
        'comment_approved_published'   => 'Comment approved and published!',
        'reply_sent_waiting'           => 'Reply sent! Waiting for approval...',
        'reply_approved_published'     => 'Reply approved and published!',
        'copied_to_clipboard'          => 'Copied to clipboard',
        'no_content_to_copy'           => 'No content to copy',
        'deleted'                      => 'Deleted',
        'delete_failed'                => 'Delete failed',
        'language_updated_successfully'=> 'Language updated successfully',
           'user_info_updated_successfully' => 'User info updated!',
    'choose_avatar' => 'Choose Avatar',
        'no_notifications_available' => 'No Notifications Available',
  'save' => 'Save',
  'recipient_information' => 'Recipient information',
'full_name' => 'Full name',
'enter_full_name' => 'Enter your full name',
'nation' => 'Nation',
'currency' => 'Currency',

'receiving_bank_information' => 'Receiving bank information',
'swift_code' => 'Swift code',
'enter_swift_code' => 'Enter swift code',
'branch_number' => 'Branch/Transit Number/Institution Number/Other',
'enter_branch_number' => 'Enter information',

'beneficiary_information' => 'Beneficiary information',
'beneficiary_iban' => 'Account number/Beneficiary IBAN',
'enter_beneficiary_iban' => 'Enter account number/Beneficiary IBAN',
'beneficiary' => 'Beneficiary',
'enter_beneficiary' => 'Enter beneficiary',
'beneficiary_address' => 'Beneficiary address',
'enter_beneficiary_address' => 'Enter address',

'monthly_roll_call' => 'Monthly roll call',
'monthly_roll_call_desc' => 'Complete 30-minute daily online game event missions to receive rewards',
'redeem_reward_points' => 'You can redeem reward points:',

'exchange_rewards' => 'Exchange rewards',
'check_ins' => 'Check-ins',
'days' => 'days',
'click_here_to_join_the_event' => 'Click here to join the event',
'checkin_playtime' => 'Complete the following playtimes to check in and receive rewards:',
'amount_to_receive' => 'Amount to receive',
'enter_amount' => 'Enter amount (whole number)',
'choose_bank' => 'Choose a bank',
'amount_validation' => 'Amount must be a whole number and less than the available balance',

        'chat_with_admin' => 'Chat with admin'
    ];

    // ‚úÖ B·∫£n d·ªãch c√°c ng√¥n ng·ªØ (demo)
    $translations = [
            'vi' => [
            'alphaFlame' => 'Kh√¥ng t√¨m th·∫•y ID tr√≤ ch∆°i',
            'alphaFlare' => 'Vui l√≤ng t·∫£i tr√≤ ch∆°i tr∆∞·ªõc khi ƒë√°nh gi√°.',
            'alphaHawk' => 'Kh√¥ng c√≥ li√™n k·∫øt t·∫£i xu·ªëng',
            'alphaMist' => 'L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu',
            'alphaRay' => 'L·ªói k·∫øt n·ªëi',
            'alphaSpin' => 'T·ªáp APK kh√¥ng t·ªìn t·∫°i',
            'azureBlaze' => 'Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ d·ªãch',
            'azureFire' => 'L·ªói khi m·ªü Google D·ªãch',
            'azureFlame' => 'L·ªói khi b·ªè th√≠ch',
            'azureHeart' => 'L·ªói khi th√≠ch b√¨nh lu·∫≠n',
            'azureShadow' => 'Fragment tr√≤ ch∆°i ƒë√£ m·ªü',
            'azureSpark' => 'Vui l√≤ng nh·∫≠p n·ªôi dung',
            'azureWing' => 'Kh√¥ng t√¨m th·∫•y ID b√†i vi·∫øt',
            'betaArrow' => 'B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa 5 ·∫£nh',
            'betaBolt' => 'Kh√¥ng th·ªÉ ƒë·ªçc t·ªáp h√¨nh ·∫£nh',
            'betaClaw' => 'L·ªói khi ƒë·ªçc t·ªáp h√¨nh ·∫£nh',
            'betaEcho' => 'ƒê√£ g·ª≠i ƒë√°nh gi√°',
            'betaFlame' => 'L·ªói khi g·ª≠i ƒë√°nh gi√°',
            'betaFlare' => 'T·ªëi ƒëa 5 ·∫£nh!',
            'betaFlash' => 'T·ªáp APK kh√¥ng t·ªìn t·∫°i. Vui l√≤ng t·∫£i l·∫°i',
            'betaGhost' => 'T·ªáp c√†i ƒë·∫∑t ƒë√£ b·ªã x√≥a',
            'betaLeaf' => 'Kh√¥ng th·ªÉ x√≥a t·ªáp',
            'betaPulse' => 'Kh√¥ng th·ªÉ m·ªü ·ª©ng d·ª•ng',
            'betaRay' => 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc',
            'betaRider' => 'üëã Xin ch√†o, ',
            'betaSky' => 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ',
            'betaWalker' => 'Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u',
            'betaWing' => 'Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng',
            'blazeArrow' => 'Vui l√≤ng nh·∫≠p email',
            'blazeBreeze' => 'Email kh√¥ng h·ª£p l·ªá!',
            'blazeClaw' => 'Vui l√≤ng nh·∫≠p m√£ x√°c minh',
            'blazeFlare' => 'M√£ x√°c minh kh√¥ng ch√≠nh x√°c!',
            'blazeFlash' => 'M√£ x√°c minh kh√¥ng h·ª£p l·ªá!',
            'blazeGhost' => 'Email kh√¥ng h·ª£p l·ªá ho·∫∑c ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω!',
            'blazeMist' => 'L·ªói k·∫øt n·ªëi!',
            'blazeRain' => 'T√™n ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i!',
            'blazeRay' => 'L·ªói k·∫øt n·ªëi!',
            'blazeShadow' => 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m·∫≠t kh·∫©u m·ªõi',
            'blazeWalker' => 'M·∫≠t kh·∫©u kh√¥ng kh·ªõp!',
            'blazeWing' => 'L·ªói m√£ h√≥a!',
            'charlieArrow' => 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!',
            'charlieBreeze' => 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i!',
            'charlieFire' => 'L·ªói k·∫øt n·ªëi!',
            'charlieFlare' => 'L·ªói t·∫£i d·ªØ li·ªáu',
            'charlieFlash' => 'Vui l√≤ng nh·∫≠p ƒë√∫ng t√™n ng∆∞·ªùi d√πng v√† m·∫≠t kh·∫©u',
            'charlieGhost' => 'L·ªói: ',
            'charlieHawk' => 'T√™n ng∆∞·ªùi d√πng ho·∫∑c Gmail ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω',
            'charlieLeaf' => 'Vui l√≤ng nh·∫≠p n·ªôi dung',
            'charlieLight' => 'Kh√¥ng t√¨m th·∫•y ID b√†i vi·∫øt',
            'charlieRain' => 'Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ d·ªãch',
            'charlieRay' => 'L·ªói khi m·ªü Google D·ªãch',
            'charlieSpark' => 'Kh√¥ng th·ªÉ ƒë·ªçc t·ªáp h√¨nh ·∫£nh',
            'charlieSpin' => 'L·ªói khi ƒë·ªçc t·ªáp h√¨nh ·∫£nh',
            'charlieStone' => 'ƒê√£ g·ª≠i b√¨nh lu·∫≠n',
            'charlieStormy' => 'G·ª≠i b√¨nh lu·∫≠n th·∫•t b·∫°i: ',
            'charlieWalker' => 'B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa 5 ·∫£nh',
            'cobaltBreeze' => 'Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ d·ªãch',
            'cobaltEcho' => 'L·ªói khi m·ªü Google D·ªãch',
            'cobaltFire' => 'L·ªói khi b·ªè th√≠ch',
            'cobaltFlame' => 'L·ªói khi th√≠ch',
            'cobaltFlash' => 'Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ nh·∫≠p gi·ªçng n√≥i',
            'cobaltGlow' => 'M√£ ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c sao ch√©p',
            'cobaltLight' => 'Thi·∫øt b·ªã kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ (API 26)',
            'cobaltRay' => 'L·ªói x·ª≠ l√Ω d·ªØ li·ªáu',
            'cobaltShadow' => 'T·ªëi ƒëa 5 ·∫£nh!',
            'language_updated' => 'ƒê√£ c·∫≠p nh·∫≠t ng√¥n ng·ªØ',
            'back' => 'Quay l·∫°i',
            'language' => 'Ng√¥n ng·ªØ',
            'english' => 'Ti·∫øng Anh',
            'portuguese' => 'Ti·∫øng B·ªì ƒê√†o Nha',
            'indonesian' => 'Ti·∫øng Indonesia',
            'spanish' => 'Ti·∫øng T√¢y Ban Nha',
            'cobaltStormy' => 'N·ªïi b·∫≠t',
            'cobaltWave' => 'Tr√≤ ch∆°i',
            'cobaltWing' => '·ª®ng d·ª•ng',
            'cosmicBolt' => '100% Tr·ª±c tuy·∫øn',
            'cosmicBreeze' => 'T·∫£i xu·ªëng',
            'cosmicFang' => 'Th√™m',
            'cosmicFire' => 'Ph·ªï bi·∫øn',
            'cosmicLight' => 'M·ªõi',
            'cosmicRay' => 'Danh m·ª•c',
            'cosmicSteel' => 'Th√™m',
            'cosmicStrike' => 'Tr√≤ ch∆°i nh·ªè',
            'cosmicWalker' => 'C√†i ƒë·∫∑t',
            'cosmicWing' => 'Tr√¨nh qu·∫£n l√Ω t·∫£i xu·ªëng',
            'crimsonArrow' => 'ƒêang t·∫£i xu·ªëng',
            'crimsonBreeze' => 'Ch∆∞a c√≥ ·ª©ng d·ª•ng n√†o ƒë∆∞·ª£c t·∫£i',
            'crimsonFire' => 'Kh√¥ng c√≥ ·ª©ng d·ª•ng ƒë√£ t·∫£i',
            'crimsonFlame' => 'Ch∆∞a c√≥ ·ª©ng d·ª•ng n√†o ƒë∆∞·ª£c c√†i ƒë·∫∑t',
            'crimsonFlare' => 'Phi√™n b·∫£n',
            'crimsonGhost' => 'K·∫øt n·ªëi...',
            'crimsonHeart' => 'T√¥i',
            'crimsonLeaf' => 'Ch·ªânh s·ª≠a',
            'crimsonRay' => 'Qu·∫£n l√Ω',
            'crimsonRider' => 'ƒê√£ t·∫£i xu·ªëng',
            'crimsonSpark' => 'Ch∆∞a ƒë∆∞·ª£c ƒë√°nh gi√°',
            'crimsonWave' => 'Tin nh·∫Øn',
            'darkClaw' => 'Tr·∫£ l·ªùi',
            'darkFlame' => 'Theo d√µi ch√∫ng t√¥i tr√™n Telegram',
            'darkFlare' => 'Trang web ch√≠nh th·ª©c',
            'darkGhost' => 'T·∫£i l√™n',
            'darkHeart' => 'Y√™u c·∫ßu',
            'darkIce' => 'Ph·∫£n h·ªìi',
            'darkLight' => 'Chia s·∫ª',
            'darkRain' => 'Ki·ªÉm tra c·∫≠p nh·∫≠t',
            'darkShadow' => 'Ch√≠nh s√°ch & B·∫£o m·∫≠t',
            'darkWalker' => 'C·∫£nh b√°o m·∫°ng di ƒë·ªông',
            'darkWing' => 'Hi·ªÉn th·ªã th√¥ng b√°o khi c√†i ƒë·∫∑t',
            'deltaBlaze' => 'Hi·ªÉn th·ªã th√¥ng b√°o sau khi c√†i ƒë·∫∑t',
            'deltaBreeze' => 'Ch·∫ø ƒë·ªô s√°ng',
            'deltaEcho' => 'Th∆∞ m·ª•c t·∫£i xu·ªëng',
            'deltaFlash' => 'Kh√°c',
            'deltaIce' => 'Ng√¥n ng·ªØ',
            'deltaLeaf' => 'T√™n ng∆∞·ªùi d√πng',
            'deltaRain' => 'X√≥a b·ªô nh·ªõ ƒë·ªám',
            'deltaRay' => 'Ch·ªâ s·ªë b·ªô nh·ªõ',
            'deltaStorm' => 'Tr√≤ ch∆°i flash',
            'deltaStormy' => 'ƒêƒÉng xu·∫•t',
            'echoArrow' => 'Ti·∫øng Anh',
            'echoBreeze' => 'ƒê·ªÅ xu·∫•t',
            'echoFang' => 'ƒêi·ªÉm s·ªë',
            'echoFire' => 'Ng∆∞·ªùi d√πng',
            'echoFlame' => 'L∆∞·ª£t t·∫£i',
            'echoFlare' => 'T·∫£i xu·ªëng',
            'echoFlash' => 'Th√¥ng tin MOD',
            'echoHawk' => 'M√¥ t·∫£:',
            'echoIce' => 'ƒê√°nh gi√°',
            'echoLight' => 'Vi·∫øt ƒë√°nh gi√°',
            'echoPulse' => 'X·∫øp h·∫°ng & ƒë√°nh gi√°',
            'echoRider' => 'H·ªØu √≠ch',
            'echoShadow' => 'Xem t·∫•t c·∫£ ƒë√°nh gi√°',
            'echoSpark' => 'l∆∞·ª£t ƒë√°nh gi√°',
            'echoStorm' => 'T·∫•t c·∫£ mod apk ƒë∆∞·ª£c t·∫£i l√™n b·ªüi ng∆∞·ªùi d√πng. N·∫øu c√≥ vi ph·∫°m b·∫£n quy·ªÅn, vui l√≤ng g·ª≠i khi·∫øu n·∫°i DMCA cho ch√∫ng t√¥i.',
            'echoStormy' => 'Chi ti·∫øt',
            'echoWing' => 'Th√¥ng tin kh√°c',
            'emberClaw' => 'B√¨nh lu·∫≠n',
            'emberFlame' => 'D·ªãch thu·∫≠t',
            'emberGhost' => 'T·∫•t c·∫£ ƒë√°nh gi√°',
            'emberHawk' => 'Tr√≤ ch∆°i',
            'emberLight' => '·ª®ng d·ª•ng',
            'emberMist' => 'T√™n ng∆∞·ªùi d√πng',
            'emberRain' => 'Nh·∫≠p t√™n ng∆∞·ªùi d√πng c·ªßa b·∫°n',
            'emberRider' => 'M·∫≠t kh·∫©u',
            'emberShadow' => 'Nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n',
            'emberWave' => 'ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi',
            'fireArrow' => 'Kh√¥i ph·ª•c t√†i kho·∫£n Facebook',
			'fireBolt' => 'Qu√™n m·∫≠t kh·∫©u?',
			'fireFlare' => '<u>ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</u>',
			'fireFlash' => '<u>Ch√≠nh s√°ch b·∫£o m·∫≠t</u>',
			'fireMist' => 'T√™n ng∆∞·ªùi d√πng (4-50 k√Ω t·ª±)',
			'fireRay' => 'M·∫≠t kh·∫©u (6-8 k√Ω t·ª±)',
			'fireShadow' => 'Email (T√πy ch·ªçn)',
			'fireWing' => 'S·ªë ƒëi·ªán tho·∫°i (t√πy ch·ªçn)',
			'flameBreeze' => 'S·ªë ƒëi·ªán tho·∫°i',
			'flameClaw' => 'ƒêƒÉng k√Ω',
			'flameEcho' => 'Khi qu√™n m·∫≠t kh·∫©u, b·∫°n s·∫Ω c·∫ßn S·ªë ƒëi·ªán tho·∫°i ho·∫∑c Email ƒë·ªÉ kh√¥i ph·ª•c. Ch√∫ng t√¥i khuy·∫øn ngh·ªã b·∫°n n√™n ho√†n th√†nh ch√∫ng.',
			'flameFlare' => 'B·∫±ng c√°ch ƒëƒÉng k√Ω, b·∫°n ƒë·ªìng √Ω v·ªõi ',
			'flameMist' => 'Ch·ªâ bao g·ªìm ch·ªØ c√°i a-z, s·ªë (kh√¥ng c√≥ kho·∫£ng tr·∫Øng ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát). 4-50 k√Ω t·ª±.',
			'flameRain' => 'Ch·ªâ bao g·ªìm ch·ªØ c√°i A-Z, a-z, s·ªë (kh√¥ng c√≥ kho·∫£ng tr·∫Øng ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát). 6-8 k√Ω t·ª±.',
			'flameShadow' => 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u',
			'flameSpark' => 'Nh·∫≠p t√™n t√†i kho·∫£n ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u. B·∫°n g·∫∑p s·ª± c·ªë khi ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u contact.us?',
			'flameStorm' => 'Ti·∫øp theo',
			'flameStrike' => 'Vui l√≤ng nh·∫≠p email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i. B·∫°n g·∫∑p s·ª± c·ªë khi ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u contact.us?',
			'flameWave' => 'Nh·∫≠p Gmail c·ªßa b·∫°n',
			'flameWing' => 'Kh√¥ng nh·ªõ b·∫•t k·ª≥ th√¥ng tin n√†o? Vui l√≤ng <u>ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi.</u>',
			'foxtrotFire' => 'M√£',
			'foxtrotFlare' => 'Nh·∫≠p m√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n',
			'foxtrotFlash' => 'M·∫≠t kh·∫©u m·ªõi',
			'foxtrotMist' => 'Nh·∫≠p m·∫≠t kh·∫©u m·ªõi',
			'foxtrotPulse' => 'Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi',
			'foxtrotRain' => 'T√¨m ki·∫øm n·ªïi b·∫≠t',
			'foxtrotRay' => 'L·ªãch s·ª≠',
			'foxtrotSpin' => '‚ñ∂ Video ƒë√£ ƒë∆∞·ª£c x√°c minh',
			'foxtrotStone' => 'ü™ü kh√¥ng c√≥ c·ª≠a s·ªï',
			'foxtrotWalker' => 'Th√¥ng b√°o c·∫≠p nh·∫≠t',
			'foxtrotWave' => 'Th√¥ng b√°o khi c√≥ phi√™n b·∫£n m·ªõi c·ªßa tr√≤ ch∆°i',
			'foxtrotWing' => 'B·∫£n c·∫≠p nh·∫≠t m·ªõi',
			'frostClaw' => 'Phi√™n b·∫£n m·ªõi v·ª´a ƒë∆∞·ª£c ph√°t h√†nh. C·∫≠p nh·∫≠t ngay!',
			'frostEcho' => 'Kh√¥ng c√≥ tr√≤ ch∆°i n√†o',
			'frostFlash' => 'Mod ·ª©ng d·ª•ng ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t',
			'frostGlow' => 'Mod n·ªïi b·∫≠t',
			'frostLeaf' => 'G·ª£i √Ω h√¥m nay',
			'setting' => 'C√†i ƒë·∫∑t',
			'frostLight' => '100% Ch∆°i game',
			'frostSpin' => 'D·ªãch thu·∫≠t',
			'frostWave' => 'Phi√™n b·∫£n m·ªõi',
			'frostWing' => 'C·∫≠p nh·∫≠t ngay',
			'ghostArrow' => 'T·∫£i ·ª©ng d·ª•ng t·∫°i:',
			'ghostFlare' => 'qua',
			'ghostFlash' => 'ƒê√°nh gi√° c·ªßa t√¥i',
			'ghostGhost' => 'Ph·∫£n h·ªìi c·ªßa t√¥i',
			'ghostGlow' => 'Tr√≤ ch∆°i tr·ª±c tuy·∫øn',
			'ghostIce' => '100% Tr·ª±c tuy·∫øn',
			'ghostLeaf' => 'APK MOD',
			'ghostLight' => 'C√≤n l·∫°i',
			'ghostRay' => 'gi√¢y',
			'ghostSpark' => 'T·∫£i xu·ªëng th√†nh c√¥ng! Nh·∫•n ƒë·ªÉ c√†i ƒë·∫∑t',
			'ghostSpin' => 'ph√∫t',
			'ghostSpil' => 'Qu√°n r∆∞·ª£u',
			'label_select' => 'Ch·ªçn',
			'label_check_in' => 'ƒêi·ªÉm danh',
			'label_checked_in' => 'ƒê√£ ƒëi·ªÉm danh',
			'status_upcoming' => 'S·∫Øp di·ªÖn ra',
			'status_past' => 'ƒê√£ qua',
			'title_monthly_checkin' => 'ƒêi·ªÉm danh h√†ng th√°ng',
			'label_day' => 'ng√†y',
			'ghostSteel' => 'Kh√¥ng c√≥ k·∫øt qu·∫£ t√¨m ki·∫øm',
			'opening' => 'ƒêang m·ªü...',
			'opening_in_browser' => 'ƒêang m·ªü trong tr√¨nh duy·ªát...',
			'opened_browser_success' => 'M·ªü tr√¨nh duy·ªát th√†nh c√¥ng',
			'error_starting_activity' => 'L·ªói khi b·∫Øt ƒë·∫ßu ho·∫°t ƒë·ªông:',
			'choose_browser' => 'Ch·ªçn tr√¨nh duy·ªát',
			'error_opening_link' => 'L·ªói khi m·ªü li√™n k·∫øt:',
			'no_content_to_translate' => 'Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ d·ªãch',
			'no_url_to_open' => 'Kh√¥ng c√≥ URL ƒë·ªÉ m·ªü',
			'forum_post_label' => 'B√†i ƒëƒÉng di·ªÖn ƒë√†n:',
			'forum_render_error' => 'L·ªói khi hi·ªÉn th·ªã b√†i ƒëƒÉng di·ªÖn ƒë√†n:',
			'error_opening_translation' => 'L·ªói khi m·ªü b·∫£n d·ªãch',
			'yes' => 'C√≥',
			'game_not_found' => 'Kh√¥ng t√¨m th·∫•y tr√≤ ch∆°i',
			'missing_forum_id' => 'Thi·∫øu forum_id',
			'api_success_false' => 'API tr·∫£ v·ªÅ success=false',
			'data_error' => 'L·ªói d·ªØ li·ªáu',
			'failed_to_load_data' => 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu',
			'data_display_error' => 'L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu',
			'error_open_post_link_in_browser' => 'L·ªói trong openPostLinkInBrowser:',
			'related_post' => 'b√†i vi·∫øt li√™n quan',
			'error_parse_related_posts' => 'L·ªói khi ph√¢n t√≠ch related_posts:',
			'error_api_post_detail' => 'L·ªói API cho post-detail:',
			'say_something' => 'H√£y n√≥i g√¨ ƒë√≥...',
			'confirmDelete' => 'X√°c nh·∫≠n x√≥a',
			'areYouSure' => 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·ªáp n√†y kh√¥ng?',
			'delete' => 'X√≥a',
			'cancel' => 'H·ªßy',
			'terms_of_service' => '<u>ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</u>',
			'terms_of_service_2' => '<u>Ch√≠nh s√°ch b·∫£o m·∫≠t</u>',
			'terms_of_service_3' => 'Kh√¥ng nh·ªõ b·∫•t k·ª≥ th√¥ng tin n√†o? Vui l√≤ng <u>ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi.</u>',
            'publish' => 'Xu·∫•t b·∫£n',

            'add_catchy_title' => 'Th√™m ti√™u ƒë·ªÅ h·∫•p d·∫´n ƒë·ªÉ c√≥ nhi·ªÅu l∆∞·ª£t xem h∆°n',
            'write_thoughts_here' => 'Vi·∫øt suy nghƒ© c·ªßa b·∫°n t·∫°i ƒë√¢y (th·ª≠ v√†i g·ª£i √Ω üí°)',
            'pick_a_game' => 'Ch·ªçn m·ªôt tr√≤ ch∆°i',
            'failed_to_load_games' => 'Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch tr√≤ ch∆°i',
            'please_enter_title_content' => 'Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† n·ªôi dung',
            'please_select_game_before_publishing' => 'Vui l√≤ng ch·ªçn tr√≤ ch∆°i tr∆∞·ªõc khi ƒëƒÉng',
            'max_photos_warning' => 'B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa 5 ·∫£nh',
            'sent_wait_for_approval' => 'ƒê√£ g·ª≠i! Vui l√≤ng ƒë·ª£i qu·∫£n tr·ªã vi√™n ph√™ duy·ªát',
            'for_you' => 'D√†nh cho b·∫°n',
            'congratulations_reward' => 'Ch√∫c m·ª´ng, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c:',
            'fill_info_to_receive_reward' => 'ƒêi·ªÅn th√¥ng tin ƒë·ªÉ nh·∫≠n ph·∫ßn th∆∞·ªüng üéä',
            'enter_your_name' => 'Nh·∫≠p t√™n c·ªßa b·∫°n',
            'enter_gmail_reward' => 'Nh·∫≠p Gmail ƒë·ªÉ nh·∫≠n ph·∫ßn th∆∞·ªüng',
            'send' => 'G·ª≠i',
            'user_id_not_found' => '‚ùå Kh√¥ng t√¨m th·∫•y ID ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.',
            'please_fill_all_fields' => '‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin',
            'failed_to_connect_server' => '‚ùå K·∫øt n·ªëi m√°y ch·ªß th·∫•t b·∫°i',
            'cannot_check_payment_status' => '‚ö†Ô∏è Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i thanh to√°n',
            'type_a_message' => 'Nh·∫≠p tin nh·∫Øn...',
            'sending_failed' => '‚ùå G·ª≠i th·∫•t b·∫°i:',
            'message_sending_failed' => '‚ùå G·ª≠i tin nh·∫Øn th·∫•t b·∫°i',
            'hello_admin_will_reply' => 'üëã Xin ch√†o! C·∫£m ∆°n b·∫°n ƒë√£ li√™n h·ªá. Qu·∫£n tr·ªã vi√™n s·∫Ω ph·∫£n h·ªìi s·ªõm nh·∫•t ‚ù§Ô∏è',
            'unable_to_load_message' => 'Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn:',
            'add_catchy_title'    => 'Th√™m ti√™u ƒë·ªÅ h·∫•p d·∫´n',
            'write_thoughts_here' => 'Vi·∫øt √Ω t∆∞·ªüng c·ªßa b·∫°n t·∫°i ƒë√¢y',
            'notifications' => 'Th√¥ng b√°o',
            'payment_info_sent' => 'G·ª≠i th√¥ng tin thanh to√°n th√†nh c√¥ng, vui l√≤ng ch·ªù qu·∫£n tr·ªã vi√™n x√°c nh·∫≠n v√† thanh to√°n.',
            'please_login_first'            => 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc',
              'game_link_not_available'       => 'Li√™n k·∫øt tr√≤ ch∆°i kh√¥ng kh·∫£ d·ª•ng',
              'pending_approval'              => 'ƒêang ch·ªù ph√™ duy·ªát...',
              'comment_sent_waiting'          => 'B√¨nh lu·∫≠n ƒë√£ g·ª≠i! ƒêang ch·ªù ph√™ duy·ªát...',
              'comment_approved_published'    => 'B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát v√† ƒëƒÉng!',
              'reply_sent_waiting'            => 'Ph·∫£n h·ªìi ƒë√£ g·ª≠i! ƒêang ch·ªù ph√™ duy·ªát...',
              'reply_approved_published'      => 'Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát v√† ƒëƒÉng!',
              'copied_to_clipboard'           => 'ƒê√£ sao ch√©p v√†o khay nh·ªõ t·∫°m',
              'no_content_to_copy'            => 'Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ sao ch√©p',
              'deleted'                       => 'ƒê√£ x√≥a',
              'delete_failed'                 => 'X√≥a th·∫•t b·∫°i',
              'language_updated_successfully' => 'C·∫≠p nh·∫≠t ng√¥n ng·ªØ th√†nh c√¥ng',
              'user_info_updated_successfully' => 'Th√¥ng tin ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!',
    'choose_avatar' => 'Ch·ªçn ·∫£nh ƒë·∫°i di·ªán',
              'no_notifications_available' => 'Kh√¥ng c√≥ th√¥ng b√°o n√†o',
'save' => 'L∆∞u',
'recipient_information' => 'Th√¥ng tin ng∆∞·ªùi nh·∫≠n',
'full_name' => 'H·ªç v√† t√™n',
'enter_full_name' => 'Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n',
'nation' => 'Qu·ªëc gia',
'currency' => 'Ti·ªÅn t·ªá',

'receiving_bank_information' => 'Th√¥ng tin ng√¢n h√†ng nh·∫≠n',
'swift_code' => 'M√£ SWIFT',
'enter_swift_code' => 'Nh·∫≠p m√£ SWIFT',
'branch_number' => 'S·ªë chi nh√°nh/S·ªë transit/M√£ t·ªï ch·ª©c/Kh√°c',
'enter_branch_number' => 'Nh·∫≠p th√¥ng tin',

'beneficiary_information' => 'Th√¥ng tin th·ª• h∆∞·ªüng',
'beneficiary_iban' => 'S·ªë t√†i kho·∫£n/IBAN th·ª• h∆∞·ªüng',
'enter_beneficiary_iban' => 'Nh·∫≠p s·ªë t√†i kho·∫£n ho·∫∑c IBAN',
'beneficiary' => 'T√™n ng∆∞·ªùi th·ª• h∆∞·ªüng',
'enter_beneficiary' => 'Nh·∫≠p t√™n ng∆∞·ªùi th·ª• h∆∞·ªüng',
'beneficiary_address' => 'ƒê·ªãa ch·ªâ ng∆∞·ªùi th·ª• h∆∞·ªüng',
'enter_beneficiary_address' => 'Nh·∫≠p ƒë·ªãa ch·ªâ',

'monthly_roll_call' => 'ƒêi·ªÉm danh h√†ng th√°ng',
'monthly_roll_call_desc' => 'Ho√†n th√†nh nhi·ªám v·ª• s·ª± ki·ªán game online 30 ph√∫t m·ªói ng√†y ƒë·ªÉ nh·∫≠n th∆∞·ªüng',
'redeem_reward_points' => 'B·∫°n c√≥ th·ªÉ ƒë·ªïi ƒëi·ªÉm th∆∞·ªüng:',
'exchange_rewards' => 'Trao ƒë·ªïi ph·∫ßn th∆∞·ªüng',
'check_ins' => 'ƒêi·ªÉm danh',
'days' => 'ng√†y',
'click_here_to_join_the_event' => 'Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ tham gia s·ª± ki·ªán',
'checkin_playtime' => 'Ho√†n th√†nh c√°c m·ªëc th·ªùi gian ch∆°i sau ƒë·ªÉ ƒëi·ªÉm danh v√† nh·∫≠n th∆∞·ªüng:',
'amount_to_receive' => 'S·ªë ti·ªÅn nh·∫≠n',
'enter_amount' => 'Nh·∫≠p s·ªë ti·ªÅn (s·ªë nguy√™n)',
'choose_bank' => 'Ch·ªçn ng√¢n h√†ng',
'amount_validation' => 'S·ªë ti·ªÅn ph·∫£i l√† s·ªë nguy√™n v√† nh·ªè h∆°n s·ªë d∆∞ hi·ªán c√≥',

            'chat_with_admin' => 'Tr√≤ chuy·ªán v·ªõi qu·∫£n tr·ªã vi√™n'
        ],
        'es' => [
            'alphaFlame' => 'ID del juego no encontrado',
            'alphaFlare' => 'Por favor, descarga el juego antes de calificar.',
            'alphaHawk' => 'No hay enlace de descarga',
            'alphaMist' => 'Error al procesar datos',
            'alphaRay' => 'Error de conexi√≥n',
            'alphaSpin' => 'El archivo APK no existe',
            'azureBlaze' => 'A√∫n no hay contenido para traducir',
            'azureFire' => 'Error al abrir Google Translate',
            'azureFlame' => 'Error al quitar el me gusta',
            'azureHeart' => 'Error al dar me gusta al comentario',
            'azureShadow' => 'Fragmento del juego abierto',
            'azureSpark' => 'Por favor ingrese contenido',
            'azureWing' => 'ID de publicaci√≥n no encontrado',
            'betaArrow' => 'Solo puedes seleccionar hasta 5 fotos',
            'betaBolt' => 'No se puede leer el archivo de imagen',
            'betaClaw' => 'Error al leer el archivo de imagen',
            'betaEcho' => 'Rese√±a enviada',
            'betaFlame' => 'Error al enviar la rese√±a',
            'betaFlare' => '¬°M√°ximo 5 fotos!',
            'betaFlash' => 'El archivo APK no existe. Por favor, desc√°rguelo de nuevo',
            'betaGhost' => 'Archivo de instalaci√≥n eliminado',
            'betaLeaf' => 'No se puede eliminar el archivo',
            'betaPulse' => 'No se puede abrir la aplicaci√≥n',
            'betaRay' => 'Por favor, complete toda la informaci√≥n requerida',
            'betaRider' => 'üëã Hola, ',
            'betaSky' => 'Error de inicio de sesi√≥n: ',
            'betaWalker' => 'Cuenta o contrase√±a incorrecta',
            'betaWing' => 'Por favor, ingrese el nombre de usuario',
            'blazeArrow' => 'Por favor, ingrese el correo electr√≥nico',
            'blazeBreeze' => '¬°Correo electr√≥nico no v√°lido!',
            'blazeClaw' => 'Por favor, ingrese el c√≥digo de verificaci√≥n',
            'blazeFlare' => '¬°C√≥digo de verificaci√≥n incorrecto!',
            'blazeFlash' => '¬°C√≥digo de verificaci√≥n no v√°lido!',
            'blazeGhost' => '¬°Correo electr√≥nico no v√°lido o no registrado!',
            'blazeMist' => '¬°Error de conexi√≥n!',
            'blazeRain' => '¬°El nombre de usuario no existe!',
            'blazeRay' => '¬°Error de conexi√≥n!',
            'blazeShadow' => 'Por favor, introduzca la nueva contrase√±a completa',
            'blazeWalker' => '¬°Las contrase√±as no coinciden!',
            'blazeWing' => '¬°Error de codificaci√≥n!',
            'charlieArrow' => '¬°Contrase√±a cambiada con √©xito!',
            'charlieBreeze' => '¬°Error al cambiar la contrase√±a!',
            'charlieFire' => '¬°Error de conexi√≥n!',
            'charlieFlare' => 'Error al cargar los datos',
            'charlieFlash' => 'Por favor, ingrese el nombre de usuario y la contrase√±a correctos',
            'charlieGhost' => 'Error: ',
            'charlieHawk' => 'El nombre de usuario o Gmail ya est√° registrado',
            'charlieLeaf' => 'Por favor, ingrese contenido',
            'charlieLight' => 'ID de publicaci√≥n no encontrado',
            'charlieRain' => 'No hay contenido para traducir',
            'charlieRay' => 'Error al abrir Google Translate',
            'charlieSpark' => 'No se puede leer el archivo de imagen',
            'charlieSpin' => 'Error al leer el archivo de imagen',
            'charlieStone' => 'Comentario enviado',
            'charlieStormy' => 'No se pudo enviar el comentario: ',
            'charlieWalker' => 'Solo puedes seleccionar hasta 5 fotos',
            'cobaltBreeze' => 'No hay contenido para traducir',
            'cobaltEcho' => 'Error al abrir Google Translate',
            'cobaltFire' => 'Error al quitar el me gusta',
            'cobaltFlame' => 'Error al dar me gusta',
            'cobaltFlash' => 'El dispositivo no admite entrada de voz',
            'cobaltGlow' => 'C√≥digo de usuario copiado al portapapeles',
            'cobaltLight' => 'Dispositivo no compatible (API 26)',
            'cobaltRay' => 'Error al procesar datos',
            'cobaltShadow' => '¬°M√°ximo 5 fotos!',
            'language_updated' => 'Idioma actualizado',
            'back' => 'Volver',
            'language' => 'Idioma',
            'english' => 'Ingl√©s',
            'portuguese' => 'Portugu√©s',
            'indonesian' => 'Indonesio',
            'spanish' => 'Espa√±ol',
            'cobaltStormy' => 'Destacado',
            'cobaltWave' => 'Juego',
            'cobaltWing' => 'Aplicaci√≥n',
            'cosmicBolt' => '100% En l√≠nea',
            'cosmicBreeze' => 'Descargar',
            'cosmicFang' => 'M√°s',
            'cosmicFire' => 'Popular',
            'cosmicLight' => 'Nuevo',
            'cosmicRay' => 'Categor√≠a',
            'cosmicSteel' => 'M√°s',
            'cosmicStrike' => 'Minijuegos',
            'cosmicWalker' => 'Instalar',
            'cosmicWing' => 'Gestor de descargas',
            'crimsonArrow' => 'Descargando',
            'crimsonBreeze' => 'No hay aplicaciones descargadas',
            'crimsonFire' => 'Sin descargas de aplicaciones',
            'crimsonFlame' => 'No hay aplicaciones instaladas',
            'crimsonFlare' => 'Versi√≥n',
            'crimsonGhost' => 'Conectando...',
            'crimsonHeart' => 'Yo',
            'crimsonLeaf' => 'Editar',
            'crimsonRay' => 'Gesti√≥n',
            'crimsonRider' => 'Descargado',
            'crimsonSpark' => 'A√∫n no revisado',
            'crimsonWave' => 'Mensaje',
            'darkClaw' => 'Responder',
            'darkFlame' => 'S√≠guenos en Telegram',
            'darkFlare' => 'Sitio web oficial',
            'darkGhost' => 'Subir',
            'darkHeart' => 'Solicitud',
            'darkIce' => 'Comentarios',
            'darkLight' => 'Compartir',
            'darkRain' => 'Buscar actualizaciones',
            'darkShadow' => 'Pol√≠tica y privacidad',
            'darkWalker' => 'Advertencia de red m√≥vil',
            'darkWing' => 'Mostrar mensaje al instalar',
            'deltaBlaze' => 'Mostrar mensaje despu√©s de la instalaci√≥n',
            'deltaBreeze' => 'Modo claro',
            'deltaEcho' => 'Carpeta de descargas',
            'deltaFlash' => 'Otro',
            'deltaIce' => 'Idioma',
            'deltaLeaf' => 'Nombre de usuario',
            'deltaRain' => 'Borrar cach√©',
            'deltaRay' => '√çndice de memoria',
            'deltaStorm' => 'Juego flash',
            'deltaStormy' => 'Cerrar sesi√≥n',
            'echoArrow' => 'Ingl√©s',
            'echoBreeze' => 'Recomendado',
            'echoFang' => 'Puntuaci√≥n',
            'echoFire' => 'Usuarios',
            'echoFlame' => 'Descargas',
            'echoFlare' => 'Descargar',
            'echoFlash' => 'Informaci√≥n MOD',
            'echoHawk' => 'Descripci√≥n:',
            'echoIce' => 'Calificar',
            'echoLight' => 'Escribir una rese√±a',
            'echoPulse' => 'Calificaci√≥n y rese√±a',
            'echoRider' => '√ötil',
            'echoShadow' => 'Ver todas las rese√±as',
            'echoSpark' => 'rese√±as',
            'echoStorm' => 'Todos los mod apk son subidos por los usuarios. Si hay alguna infracci√≥n, por favor env√≠e una queja DMCA.',
            'echoStormy' => 'Detalles',
            'echoWing' => 'Otra informaci√≥n',
            'emberClaw' => 'Comentario',
            'emberFlame' => 'Traducci√≥n',
            'emberGhost' => 'Todas las rese√±as',
            'emberHawk' => 'Juego',
            'emberLight' => 'Aplicaci√≥n',
            'emberMist' => 'Nombre de usuario',
            'emberRain' => 'Ingrese su nombre de usuario',
            'emberRider' => 'Contrase√±a',
            'emberShadow' => 'Ingrese su contrase√±a',
            'emberWave' => 'Registrar una nueva cuenta',
                'fireArrow' => 'Recuperar cuenta de Facebook',
			'fireBolt' => '¬øOlvidaste tu contrase√±a?',
			'fireFlare' => '<u>T√©rminos de servicio</u>',
			'fireFlash' => '<u>Pol√≠tica de privacidad</u>',
			'fireMist' => 'Nombre de usuario (4-50 caracteres)',
			'fireRay' => 'Contrase√±a (6-8 caracteres)',
			'fireShadow' => 'Correo electr√≥nico (Opcional)',
			'fireWing' => 'N√∫mero de tel√©fono (opcional)',
			'flameBreeze' => 'N√∫mero de tel√©fono',
			'flameClaw' => 'Registrarse',
			'flameEcho' => 'Cuando olvides tu contrase√±a, necesitar√°s tu n√∫mero de tel√©fono o correo electr√≥nico para recuperarla. Recomendamos completarlos.',
			'flameFlare' => 'Al registrarte, aceptas ',
			'flameMist' => 'Solo letras a-z, n√∫meros (sin espacios ni caracteres especiales). 4-50 caracteres.',
			'flameRain' => 'Solo letras A-Z, a-z, n√∫meros (sin espacios ni caracteres especiales). 6-8 caracteres.',
			'flameShadow' => 'Restablecer contrase√±a',
			'flameSpark' => 'Ingresa el nombre de usuario de tu cuenta para restablecer tu contrase√±a. ¬øTienes problemas para restablecer la contrase√±a de contact.us?',
			'flameStorm' => 'Siguiente',
			'flameStrike' => 'Por favor, introduce tu correo electr√≥nico o n√∫mero de tel√©fono. ¬øTienes problemas para restablecer la contrase√±a de contact.us?',
			'flameWave' => 'Introduce tu Gmail',
			'flameWing' => '¬øNo recuerdas ninguno? Por favor <u>reg√≠strate con una nueva cuenta.</u>',
			'foxtrotFire' => 'C√≥digo',
			'foxtrotFlare' => 'Introduce el c√≥digo enviado a tu correo electr√≥nico',
			'foxtrotFlash' => 'Nueva contrase√±a',
			'foxtrotMist' => 'Introduce nueva contrase√±a',
			'foxtrotPulse' => 'Por favor, vuelve a introducir la nueva contrase√±a',
			'foxtrotRain' => 'B√∫squeda popular',
			'foxtrotRay' => 'Historial',
			'foxtrotSpin' => '‚ñ∂ El v√≠deo ha sido verificado',
			'foxtrotStone' => 'ü™ü sin ventana',
			'foxtrotWalker' => 'Aviso de actualizaci√≥n',
			'foxtrotWave' => 'Notificar cuando haya una nueva versi√≥n del juego',
			'foxtrotWing' => 'Nueva actualizaci√≥n',
			'frostClaw' => 'Nueva versi√≥n lanzada. ¬°Actualiza ahora!',
			'frostEcho' => 'No hay juegos disponibles',
			'frostFlash' => 'Mods de aplicaciones recomendados',
			'frostGlow' => 'Mod popular',
			'frostLeaf' => 'Sugerencia de hoy',
			'setting' => 'Configuraci√≥n',
			'frostLight' => '100% Jugar juego',
			'frostSpin' => 'Traducci√≥n',
			'frostWave' => 'Nueva versi√≥n',
			'frostWing' => 'Actualizar ahora',
			'ghostArrow' => 'Descargar la aplicaci√≥n en:',
			'ghostFlare' => 'v√≠a',
			'ghostFlash' => 'Mis rese√±as',
			'ghostGhost' => 'Mis respuestas',
			'ghostGlow' => 'Juegos en l√≠nea',
			'ghostIce' => '100% en l√≠nea',
			'ghostLeaf' => 'APK MOD',
			'ghostLight' => 'Restante',
			'ghostRay' => 'segundo',
			'ghostSpark' => '¬°Descarga exitosa! Haz clic para instalar',
			'ghostSpin' => 'minuto',
			'ghostSpil' => 'Taberna',
			'label_select' => 'Seleccionar',
			'label_check_in' => 'Registrarse',
			'label_checked_in' => 'Registrado',
			'status_upcoming' => 'Pr√≥ximamente',
			'status_past' => 'Pasado',
			'title_monthly_checkin' => 'Registro mensual',
			'label_day' => 'd√≠a',
			'ghostSteel' => 'Sin resultados de b√∫squeda',
			'opening' => 'Abriendo...',
			'opening_in_browser' => 'Abriendo en el navegador...',
			'opened_browser_success' => 'Navegador abierto con √©xito',
			'error_starting_activity' => 'Error al iniciar la actividad:',
			'choose_browser' => 'Elegir navegador',
			'error_opening_link' => 'Error al abrir el enlace:',
			'no_content_to_translate' => 'No hay contenido para traducir',
			'no_url_to_open' => 'No hay URL para abrir',
			'forum_post_label' => 'Publicaci√≥n del foro:',
			'forum_render_error' => 'Error al renderizar la publicaci√≥n del foro:',
			'error_opening_translation' => 'Error al abrir la traducci√≥n',
			'yes' => 'S√≠',
			'game_not_found' => 'Juego no encontrado',
			'missing_forum_id' => 'Falta forum_id',
			'api_success_false' => 'La API devolvi√≥ success=false',
			'data_error' => 'Error de datos',
			'failed_to_load_data' => 'No se pudieron cargar los datos',
			'data_display_error' => 'Error al mostrar datos',
			'error_open_post_link_in_browser' => 'Error en openPostLinkInBrowser:',
			'related_post' => 'publicaci√≥n relacionada',
			'error_parse_related_posts' => 'Error al analizar related_posts:',
			'error_api_post_detail' => 'Error de API para post-detail:',
			'say_something' => 'Di algo...',
			
              'confirmDelete' => 'Confirmar eliminaci√≥n',
            'areYouSure' => '¬øEst√°s seguro de que deseas eliminar este archivo?',
            'delete' => 'Eliminar',
            'cancel' => 'Cancelar',
            'terms_of_service' => '<u>T√©rminos de servicio</u>',
            'terms_of_service_2' => '<u>Pol√≠tica de privacidad</u>',
            'terms_of_service_3' => '¬øNo recuerdas ninguno? Por favor, <u>reg√≠strate con una nueva cuenta.</u>',
            'publish' => 'Publicar',
            'add_catchy_title' => 'Agrega un t√≠tulo atractivo para obtener m√°s vistas',
            'write_thoughts_here' => 'Escribe tus pensamientos aqu√≠ (prueba algunas ideas üí°)',
            'pick_a_game' => 'Elige un juego',
            'failed_to_load_games' => 'No se pudieron cargar los juegos',
            'please_enter_title_content' => 'Por favor, ingresa el t√≠tulo y el contenido',
            'please_select_game_before_publishing' => 'Selecciona un juego antes de publicar',
            'max_photos_warning' => 'Solo puedes seleccionar hasta 5 fotos',
            'sent_wait_for_approval' => '¬°Enviado! Espera la aprobaci√≥n del administrador',

            'for_you' => 'Para ti',
            'congratulations_reward' => '¬°Felicidades, recibir√°s:',
            'fill_info_to_receive_reward' => 'Completa la informaci√≥n para recibir la recompensa üéä',
            'enter_your_name' => 'Ingresa tu nombre',
            'enter_gmail_reward' => 'Ingresa tu Gmail para recibir la recompensa',
            'send' => 'Enviar',

            'user_id_not_found' => '‚ùå No se encontr√≥ el ID de usuario. Por favor, inicia sesi√≥n nuevamente.',
            'please_fill_all_fields' => '‚ö†Ô∏è Por favor, completa todos los campos',
            'failed_to_connect_server' => '‚ùå Error al conectar con el servidor',
            'cannot_check_payment_status' => '‚ö†Ô∏è No se puede verificar el estado del pago',

            'type_a_message' => 'Escribe un mensaje...',
            'sending_failed' => '‚ùå Error al enviar:',
            'message_sending_failed' => '‚ùå Fall√≥ el env√≠o del mensaje',
            'hello_admin_will_reply' => 'üëã ¬°Hola! Gracias por contactarnos. El administrador responder√° lo antes posible ‚ù§Ô∏è',
            'unable_to_load_message' => 'No se pudo cargar el mensaje:',
            'add_catchy_title'    => 'Agrega un t√≠tulo llamativo',
            'write_thoughts_here' => 'Escribe tus ideas aqu√≠',
            'notifications' => 'Notificaciones',
            'payment_info_sent' => 'La informaci√≥n de pago se ha enviado con √©xito, por favor espera a que el administrador confirme y realice el pago.',
            'please_login_first'            => 'Por favor, inicia sesi√≥n primero',
            'game_link_not_available'       => 'Enlace del juego no disponible',
            'pending_approval'              => 'Pendiente de aprobaci√≥n...',
            'comment_sent_waiting'          => '¬°Comentario enviado! Esperando aprobaci√≥n...',
            'comment_approved_published'    => '¬°Comentario aprobado y publicado!',
            'reply_sent_waiting'            => '¬°Respuesta enviada! Esperando aprobaci√≥n...',
            'reply_approved_published'      => '¬°Respuesta aprobada y publicada!',
            'copied_to_clipboard'           => 'Copiado al portapapeles',
            'no_content_to_copy'            => 'No hay contenido para copiar',
            'deleted'                       => 'Eliminado',
            'delete_failed'                 => 'Error al eliminar',
            'language_updated_successfully' => 'Idioma actualizado con √©xito',
                'user_info_updated_successfully' => '¬°La informaci√≥n del usuario se ha actualizado!',
    'choose_avatar' => 'Elegir avatar',
            'no_notifications_available' => 'No hay notificaciones disponibles',
'save' => 'Guardar',
'recipient_information' => 'Informaci√≥n del destinatario',
'full_name' => 'Nombre completo',
'enter_full_name' => 'Ingrese su nombre completo',
'nation' => 'Naci√≥n',
'currency' => 'Moneda',

'receiving_bank_information' => 'Informaci√≥n del banco receptor',
'swift_code' => 'C√≥digo SWIFT',
'enter_swift_code' => 'Ingrese el c√≥digo SWIFT',
'branch_number' => 'N√∫mero de sucursal/Tr√°nsito/Instituci√≥n/Otros',
'enter_branch_number' => 'Ingrese la informaci√≥n',

'beneficiary_information' => 'Informaci√≥n del beneficiario',
'beneficiary_iban' => 'N√∫mero de cuenta/IBAN del beneficiario',
'enter_beneficiary_iban' => 'Ingrese el n√∫mero de cuenta o IBAN',
'beneficiary' => 'Beneficiario',
'enter_beneficiary' => 'Ingrese el nombre del beneficiario',
'beneficiary_address' => 'Direcci√≥n del beneficiario',
'enter_beneficiary_address' => 'Ingrese la direcci√≥n',

'monthly_roll_call' => 'Registro mensual',
'monthly_roll_call_desc' => 'Complete misiones diarias de 30 minutos en eventos de juegos en l√≠nea para recibir recompensas',
'redeem_reward_points' => 'Puedes canjear puntos de recompensa:',
'exchange_rewards' => 'Intercambiar recompensas',
'check_ins' => 'Registros diarios',
'days' => 'd√≠as',
'click_here_to_join_the_event' => 'Haz clic aqu√≠ para unirte al evento',
'checkin_playtime' => 'Completa los tiempos de juego siguientes para registrar tu asistencia y recibir recompensas:',
'amount_to_receive' => 'Cantidad a recibir',
'enter_amount' => 'Ingrese la cantidad (n√∫mero entero)',
'choose_bank' => 'Elija un banco',
'amount_validation' => 'La cantidad debe ser un n√∫mero entero y menor que el saldo disponible',

            'chat_with_admin' => 'Chatear con el administrador'
        ],
		'id' => [
			'alphaFlame' => 'ID game tidak ditemukan',
			'alphaFlare' => 'Silakan unduh game sebelum memberi peringkat.',
			'alphaHawk' => 'Tidak ada tautan unduhan',
			'alphaMist' => 'Terjadi kesalahan saat memproses data',
			'alphaRay' => 'Kesalahan koneksi',
			'alphaSpin' => 'File APK tidak ada',
			'azureBlaze' => 'Belum ada konten untuk diterjemahkan',
			'azureFire' => 'Kesalahan saat membuka Google Terjemahan',
			'azureFlame' => 'Kesalahan saat membatalkan suka',
			'azureHeart' => 'Kesalahan saat menyukai komentar',
			'azureShadow' => 'Fragmen game telah dibuka',
			'azureSpark' => 'Silakan masukkan konten',
			'azureWing' => 'ID posting tidak ditemukan',
			'betaArrow' => 'Anda hanya dapat memilih hingga 5 foto',
			'betaBolt' => 'Tidak dapat membaca file gambar',
			'betaClaw' => 'Kesalahan saat membaca file gambar',
			'betaEcho' => 'Ulasan telah dikirim',
			'betaFlame' => 'Kesalahan saat mengirim ulasan',
			'betaFlare' => 'Maksimum 5 foto!',
			'betaFlash' => 'File APK tidak ada. Silakan unduh lagi',
			'betaGhost' => 'File instalasi telah dihapus',
			'betaLeaf' => 'Tidak dapat menghapus file',
			'betaPulse' => 'Tidak dapat membuka aplikasi',
			'betaRay' => 'Silakan isi semua informasi yang diperlukan',
			'betaRider' => 'üëã Halo, ',
			'betaSky' => 'Gagal masuk: ',
			'betaWalker' => 'Akun atau kata sandi salah',
			'betaWing' => 'Silakan masukkan nama pengguna',
			'blazeArrow' => 'Silakan masukkan email',
			'blazeBreeze' => 'Email tidak valid!',
			'blazeClaw' => 'Silakan masukkan kode verifikasi',
			'blazeFlare' => 'Kode verifikasi salah!',
			'blazeFlash' => 'Kode verifikasi tidak valid!',
			'blazeGhost' => 'Email tidak valid atau belum terdaftar!',
			'blazeMist' => 'Kesalahan koneksi!',
			'blazeRain' => 'Nama pengguna tidak ada!',
			'blazeRay' => 'Kesalahan koneksi!',
			'blazeShadow' => 'Silakan masukkan kata sandi baru secara lengkap',
			'blazeWalker' => 'Kata sandi tidak cocok!',
			'blazeWing' => 'Kesalahan pengkodean!',
			'charlieArrow' => 'Kata sandi berhasil diubah!',
			'charlieBreeze' => 'Gagal mengubah kata sandi!',
			'charlieFire' => 'Kesalahan koneksi!',
			'charlieFlare' => 'Kesalahan memuat data',
			'charlieFlash' => 'Silakan masukkan nama pengguna dan kata sandi yang benar',
			'charlieGhost' => 'Kesalahan: ',
			'charlieHawk' => 'Nama pengguna atau Gmail sudah terdaftar',
			'charlieLeaf' => 'Silakan masukkan konten',
			'charlieLight' => 'ID posting tidak ditemukan',
			'charlieRain' => 'Tidak ada konten untuk diterjemahkan',
			'charlieRay' => 'Kesalahan saat membuka Google Terjemahan',
			'charlieSpark' => 'Tidak dapat membaca file gambar',
			'charlieSpin' => 'Kesalahan saat membaca file gambar',
			'charlieStone' => 'Komentar telah dikirim',
			'charlieStormy' => 'Gagal mengirim komentar: ',
			'charlieWalker' => 'Anda hanya dapat memilih hingga 5 foto',
			'cobaltBreeze' => 'Tidak ada konten untuk diterjemahkan',
			'cobaltEcho' => 'Kesalahan saat membuka Google Terjemahan',
			'cobaltFire' => 'Kesalahan saat membatalkan suka',
			'cobaltFlame' => 'Kesalahan saat menyukai',
			'cobaltFlash' => 'Perangkat tidak mendukung input suara',
			'cobaltGlow' => 'Kode pengguna disalin ke papan klip',
			'cobaltLight' => 'Perangkat tidak didukung (API 26)',
			'cobaltRay' => 'Kesalahan pemrosesan data',
			'cobaltShadow' => 'Maksimum 5 foto!',
			'language_updated' => 'Bahasa telah diperbarui',
			'back' => 'Kembali',
			'language' => 'Bahasa',
			'english' => 'Inggris',
			'portuguese' => 'Portugis',
			'indonesian' => 'Indonesia',
			'spanish' => 'Spanyol',
			'cobaltStormy' => 'Unggulan',
			'cobaltWave' => 'Game',
			'cobaltWing' => 'Aplikasi',
			'cosmicBolt' => '100% Online',
			'cosmicBreeze' => 'Unduh',
			'cosmicFang' => 'Lainnya',
			'cosmicFire' => 'Populer',
			'cosmicLight' => 'Baru',
			'cosmicRay' => 'Kategori',
			'cosmicSteel' => 'Lainnya',
			'cosmicStrike' => 'Permainan mini',
			'cosmicWalker' => 'Instal',
			'cosmicWing' => 'Pengelola unduhan',
			'crimsonArrow' => 'Mengunduh',
			'crimsonBreeze' => 'Belum ada aplikasi yang diunduh',
			'crimsonFire' => 'Tidak ada unduhan aplikasi',
			'crimsonFlame' => 'Belum ada aplikasi yang diinstal',
			'crimsonFlare' => 'Versi',
			'crimsonGhost' => 'Menghubungkan...',
			'crimsonHeart' => 'Saya',
			'crimsonLeaf' => 'Edit',
			'crimsonRay' => 'Manajemen',
			'crimsonRider' => 'Telah diunduh',
			'crimsonSpark' => 'Belum ditinjau',
			'crimsonWave' => 'Pesan',
			'darkClaw' => 'Balas',
			'darkFlame' => 'Ikuti kami di Telegram',
			'darkFlare' => 'Situs web resmi',
			'darkGhost' => 'Unggah',
			'darkHeart' => 'Permintaan',
			'darkIce' => 'Masukan',
			'darkLight' => 'Bagikan',
			'darkRain' => 'Periksa pembaruan',
			'darkShadow' => 'Kebijakan & Privasi',
			'darkWalker' => 'Peringatan jaringan seluler',
			'darkWing' => 'Tampilkan pesan saat menginstal',
			'deltaBlaze' => 'Tampilkan pesan setelah instalasi',
			'deltaBreeze' => 'Mode terang',
			'deltaEcho' => 'Folder unduhan',
			'deltaFlash' => 'Lainnya',
			'deltaIce' => 'Bahasa',
			'deltaLeaf' => 'Nama pengguna',
			'deltaRain' => 'Hapus cache',
			'deltaRay' => 'Indeks memori',
			'deltaStorm' => 'Permainan flash',
			'deltaStormy' => 'Keluar',
			'echoArrow' => 'Inggris',
			'echoBreeze' => 'Direkomendasikan',
			'echoFang' => 'Skor',
			'echoFire' => 'Pengguna',
			'echoFlame' => 'Unduhan',
			'echoFlare' => 'Unduh',
			'echoFlash' => 'Info MOD',
			'echoHawk' => 'Deskripsi:',
			'echoIce' => 'Beri peringkat',
			'echoLight' => 'Tulis ulasan',
			'echoPulse' => 'Peringkat & ulasan',
			'echoRider' => 'Bermanfaat',
			'echoShadow' => 'Lihat semua ulasan',
			'echoSpark' => 'ulasan',
			'echoStorm' => 'Semua mod apk diunggah oleh pengguna. Jika ada pelanggaran, harap kirim keluhan DMCA kepada kami.',
			'echoStormy' => 'Detail',
			'echoWing' => 'Informasi lainnya',
			'emberClaw' => 'Komentar',
			'emberFlame' => 'Terjemahan',
			'emberGhost' => 'Semua ulasan',
			'emberHawk' => 'Game',
			'emberLight' => 'Aplikasi',
			'emberMist' => 'Nama pengguna',
			'emberRain' => 'Masukkan nama pengguna Anda',
			'emberRider' => 'Kata sandi',
			'emberShadow' => 'Masukkan kata sandi Anda',
			'emberWave' => 'Daftar sebagai pengguna baru',
				'fireArrow' => 'Pulihkan akun Facebook',
			'fireBolt' => 'Lupa kata sandi?',
			'fireFlare' => '<u>Ketentuan layanan</u>',
			'fireFlash' => '<u>Kebijakan privasi</u>',
			'fireMist' => 'Nama pengguna (4-50 karakter)',
			'fireRay' => 'Kata sandi (6-8 karakter)',
			'fireShadow' => 'Email (Opsional)',
			'fireWing' => 'Nomor telepon (opsional)',
			'flameBreeze' => 'Nomor telepon',
			'flameClaw' => 'Daftar',
			'flameEcho' => 'Saat Anda lupa kata sandi, Anda akan memerlukan Nomor Telepon atau Email untuk memulihkannya. Kami menyarankan Anda untuk melengkapinya.',
			'flameFlare' => 'Dengan mendaftar, Anda setuju dengan ',
			'flameMist' => 'Hanya huruf a-z, angka (tanpa spasi atau karakter khusus). 4-50 karakter.',
			'flameRain' => 'Hanya huruf A-Z, a-z, angka (tanpa spasi atau karakter khusus). 6-8 karakter.',
			'flameShadow' => 'Atur ulang kata sandi',
			'flameSpark' => 'Masukkan nama pengguna akun Anda untuk mengatur ulang kata sandi. Apakah Anda mengalami masalah saat mengatur ulang kata sandi contact.us?',
			'flameStorm' => 'Berikutnya',
			'flameStrike' => 'Silakan masukkan email atau nomor telepon Anda. Apakah Anda mengalami masalah saat mengatur ulang kata sandi contact.us?',
			'flameWave' => 'Masukkan Gmail Anda',
			'flameWing' => 'Tidak ingat salah satunya? Silakan <u>daftar akun baru.</u>',
			'foxtrotFire' => 'Kode',
			'foxtrotFlare' => 'Masukkan kode yang dikirim ke email Anda',
			'foxtrotFlash' => 'Kata sandi baru',
			'foxtrotMist' => 'Masukkan kata sandi baru',
			'foxtrotPulse' => 'Silakan masukkan ulang kata sandi baru',
			'foxtrotRain' => 'Pencarian populer',
			'foxtrotRay' => 'Riwayat',
			'foxtrotSpin' => '‚ñ∂ Video telah diverifikasi',
			'foxtrotStone' => 'ü™ü tidak ada jendela',
			'foxtrotWalker' => 'Pemberitahuan pembaruan',
			'foxtrotWave' => 'Beritahu saat ada versi baru dari game',
			'foxtrotWing' => 'Pembaruan baru',
			'frostClaw' => 'Versi baru baru saja dirilis. Perbarui sekarang!',
			'frostEcho' => 'Tidak ada game yang tersedia',
			'frostFlash' => 'Mod aplikasi yang direkomendasikan',
			'frostGlow' => 'Mod populer',
			'frostLeaf' => 'Saran hari ini',
			'setting' => 'Pengaturan',
			'frostLight' => '100% Main game',
			'frostSpin' => 'Terjemahan',
			'frostWave' => 'Versi baru',
			'frostWing' => 'Perbarui sekarang',
			'ghostArrow' => 'Unduh aplikasi di:',
			'ghostFlare' => 'melalui',
			'ghostFlash' => 'Ulasan saya',
			'ghostGhost' => 'Balasan saya',
			'ghostGlow' => 'Game online',
			'ghostIce' => '100% Online',
			'ghostLeaf' => 'APK MOD',
			'ghostLight' => 'Tersisa',
			'ghostRay' => 'detik',
			'ghostSpark' => 'Unduhan berhasil! Klik untuk menginstal',
			'ghostSpin' => 'menit',
			'ghostSpil' => 'Tavern',
			'label_select' => 'Pilih',
			'label_check_in' => 'Check in',
			'label_checked_in' => 'Sudah check in',
			'status_upcoming' => 'Mendatang',
			'status_past' => 'Lewat',
			'title_monthly_checkin' => 'Check-in bulanan',
			'label_day' => 'hari',
			'ghostSteel' => 'Tidak ada hasil pencarian',
			'opening' => 'Membuka...',
			'opening_in_browser' => 'Membuka di browser...',
			'opened_browser_success' => 'Browser berhasil dibuka',
			'error_starting_activity' => 'Kesalahan saat memulai aktivitas:',
			'choose_browser' => 'Pilih browser',
			'error_opening_link' => 'Kesalahan saat membuka tautan:',
			'no_content_to_translate' => 'Tidak ada konten untuk diterjemahkan',
			'no_url_to_open' => 'Tidak ada URL untuk dibuka',
			'forum_post_label' => 'Postingan forum:',
			'forum_render_error' => 'Kesalahan saat merender postingan forum:',
			'error_opening_translation' => 'Kesalahan saat membuka terjemahan',
			'yes' => 'Ya',
			'game_not_found' => 'Game tidak ditemukan',
			'missing_forum_id' => 'forum_id tidak ditemukan',
			'api_success_false' => 'API mengembalikan success=false',
			'data_error' => 'Kesalahan data',
			'failed_to_load_data' => 'Gagal memuat data',
			'data_display_error' => 'Kesalahan tampilan data',
			'error_open_post_link_in_browser' => 'Kesalahan di openPostLinkInBrowser:',
			'related_post' => 'posting terkait',
			'error_parse_related_posts' => 'Kesalahan saat mem-parsing related_posts:',
			'error_api_post_detail' => 'Kesalahan API untuk post-detail:',
			'say_something' => 'Katakan sesuatu...',


            'confirmDelete' => 'Konfirmasi penghapusan',
            'areYouSure' => 'Apakah Anda yakin ingin menghapus file ini?',
            'delete' => 'Hapus',
            'cancel' => 'Batal',
            'terms_of_service' => '<u>Syarat layanan</u>',
            'terms_of_service_2' => '<u>Kebijakan privasi</u>',
            'terms_of_service_3' => 'Tidak ingat salah satunya? Silakan <u>daftar akun baru.</u>',
            'publish' => 'Terbitkan',
            'add_catchy_title' => 'Tambahkan judul menarik untuk mendapatkan lebih banyak tampilan',
            'write_thoughts_here' => 'Tulis pemikiran Anda di sini (coba beberapa ide üí°)',
            'pick_a_game' => 'Pilih game',
            'failed_to_load_games' => 'Gagal memuat daftar game',
            'please_enter_title_content' => 'Silakan masukkan judul dan konten',
            'please_select_game_before_publishing' => 'Silakan pilih game sebelum mempublikasikan',
            'max_photos_warning' => 'Anda hanya dapat memilih hingga 5 foto',
            'sent_wait_for_approval' => 'Terkirim! Harap tunggu persetujuan admin',

            'for_you' => 'Untuk Anda',
            'congratulations_reward' => 'Selamat, Anda akan menerima:',
            'fill_info_to_receive_reward' => 'Isi informasi untuk menerima hadiah üéä',
            'enter_your_name' => 'Masukkan nama Anda',
            'enter_gmail_reward' => 'Masukkan Gmail untuk menerima hadiah',
            'send' => 'Kirim',

            'user_id_not_found' => '‚ùå ID pengguna tidak ditemukan. Silakan masuk kembali.',
            'please_fill_all_fields' => '‚ö†Ô∏è Harap isi semua kolom',
            'failed_to_connect_server' => '‚ùå Gagal terhubung ke server',
            'cannot_check_payment_status' => '‚ö†Ô∏è Tidak dapat memeriksa status pembayaran',

            'type_a_message' => 'Ketik pesan...',
            'sending_failed' => '‚ùå Gagal mengirim:',
            'message_sending_failed' => '‚ùå Pengiriman pesan gagal',
            'hello_admin_will_reply' => 'üëã Halo! Terima kasih telah menghubungi kami. Admin akan merespons sesegera mungkin ‚ù§Ô∏è',
            'unable_to_load_message' => 'Tidak dapat memuat pesan:',
            'add_catchy_title'    => 'Tambahkan judul yang menarik',
            'write_thoughts_here' => 'Tulis ide Anda di sini',
            'notifications' => 'Notifikasi',
            'payment_info_sent' => 'Informasi pembayaran berhasil dikirim, harap tunggu admin mengonfirmasi dan melakukan pembayaran.',
            'please_login_first'            => 'Silakan login terlebih dahulu',
                'game_link_not_available'       => 'Tautan game tidak tersedia',
                'pending_approval'              => 'Menunggu persetujuan...',
                'comment_sent_waiting'          => 'Komentar terkirim! Menunggu persetujuan...',
                'comment_approved_published'    => 'Komentar disetujui dan dipublikasikan!',
                'reply_sent_waiting'            => 'Balasan terkirim! Menunggu persetujuan...',
                'reply_approved_published'      => 'Balasan disetujui dan dipublikasikan!',
                'copied_to_clipboard'           => 'Disalin ke papan klip',
                'no_content_to_copy'            => 'Tidak ada konten untuk disalin',
                'deleted'                       => 'Dihapus',
                'delete_failed'                 => 'Gagal menghapus',
                'language_updated_successfully' => 'Bahasa berhasil diperbarui',
                 'user_info_updated_successfully' => 'Informasi pengguna berhasil diperbarui!',
    'choose_avatar' => 'Pilih avatar',
'no_notifications_available' => 'Tidak ada notifikasi tersedia',
'save' => 'Simpan',
'recipient_information' => 'Informasi Penerima',
'full_name' => 'Nama lengkap',
'enter_full_name' => 'Masukkan nama lengkap Anda',
'nation' => 'Negara',
'currency' => 'Mata uang',

'receiving_bank_information' => 'Informasi Bank Penerima',
'swift_code' => 'Kode SWIFT',
'enter_swift_code' => 'Masukkan kode SWIFT',
'branch_number' => 'Nomor Cabang/Transit/Institusi/Lainnya',
'enter_branch_number' => 'Masukkan informasi',

'beneficiary_information' => 'Informasi Penerima Dana',
'beneficiary_iban' => 'Nomor rekening/IBAN Penerima',
'enter_beneficiary_iban' => 'Masukkan nomor rekening/IBAN penerima',
'beneficiary' => 'Penerima dana',
'enter_beneficiary' => 'Masukkan nama penerima dana',
'beneficiary_address' => 'Alamat penerima dana',
'enter_beneficiary_address' => 'Masukkan alamat',

'monthly_roll_call' => 'Daftar hadir bulanan',
'monthly_roll_call_desc' => 'Selesaikan misi acara game online harian selama 30 menit untuk mendapatkan hadiah',
'redeem_reward_points' => 'Anda dapat menukar poin hadiah:',
'exchange_rewards' => 'Tukar hadiah',
'check_ins' => 'Check-in harian',
'days' => 'hari',
'click_here_to_join_the_event' => 'Klik di sini untuk bergabung dengan acara',
'checkin_playtime' => 'Selesaikan waktu bermain berikut untuk check-in dan menerima hadiah:',
'amount_to_receive' => 'Jumlah yang diterima',
'enter_amount' => 'Masukkan jumlah (bilangan bulat)',
'choose_bank' => 'Pilih bank',
'amount_validation' => 'Jumlah harus berupa bilangan bulat dan lebih kecil dari saldo yang tersedia',

            'chat_with_admin' => 'Obrolan dengan admin'
		],

		'pt' => [
			'alphaFlame' => 'ID do jogo n√£o encontrado',
			'alphaFlare' => 'Por favor, baixe o jogo antes de avaliar.',
			'alphaHawk' => 'Nenhum link de download',
			'alphaMist' => 'Erro ao processar dados',
			'alphaRay' => 'Erro de conex√£o',
			'alphaSpin' => 'O arquivo APK n√£o existe',
			'azureBlaze' => 'Ainda n√£o h√° conte√∫do para traduzir',
			'azureFire' => 'Erro ao abrir o Google Tradutor',
			'azureFlame' => 'Erro ao remover curtida',
			'azureHeart' => 'Erro ao curtir coment√°rio',
			'azureShadow' => 'Fragmento do jogo aberto',
			'azureSpark' => 'Por favor, insira o conte√∫do',
			'azureWing' => 'ID da postagem n√£o encontrado',
			'betaArrow' => 'Voc√™ s√≥ pode selecionar at√© 5 fotos',
			'betaBolt' => 'N√£o √© poss√≠vel ler o arquivo de imagem',
			'betaClaw' => 'Erro ao ler o arquivo de imagem',
			'betaEcho' => 'Avalia√ß√£o enviada',
			'betaFlame' => 'Erro ao enviar avalia√ß√£o',
			'betaFlare' => 'M√°ximo de 5 fotos!',
			'betaFlash' => 'O arquivo APK n√£o existe. Por favor, baixe novamente',
			'betaGhost' => 'Arquivo de instala√ß√£o exclu√≠do',
			'betaLeaf' => 'N√£o √© poss√≠vel excluir o arquivo',
			'betaPulse' => 'N√£o √© poss√≠vel abrir o aplicativo',
			'betaRay' => 'Por favor, preencha todas as informa√ß√µes obrigat√≥rias',
			'betaRider' => 'üëã Ol√°, ',
			'betaSky' => 'Falha no login: ',
			'betaWalker' => 'Conta ou senha incorretas',
			'betaWing' => 'Por favor, insira o nome de usu√°rio',
			'blazeArrow' => 'Por favor, insira o e-mail',
			'blazeBreeze' => 'E-mail inv√°lido!',
			'blazeClaw' => 'Por favor, insira o c√≥digo de verifica√ß√£o',
			'blazeFlare' => 'C√≥digo de verifica√ß√£o incorreto!',
			'blazeFlash' => 'C√≥digo de verifica√ß√£o inv√°lido!',
			'blazeGhost' => 'E-mail inv√°lido ou n√£o registrado!',
			'blazeMist' => 'Erro de conex√£o!',
			'blazeRain' => 'Nome de usu√°rio n√£o existe!',
			'blazeRay' => 'Erro de conex√£o!',
			'blazeShadow' => 'Por favor, insira a nova senha completa',
			'blazeWalker' => 'As senhas n√£o coincidem!',
			'blazeWing' => 'Erro de codifica√ß√£o!',
			'charlieArrow' => 'Senha alterada com sucesso!',
			'charlieBreeze' => 'Falha ao alterar a senha!',
			'charlieFire' => 'Erro de conex√£o!',
			'charlieFlare' => 'Erro ao carregar dados',
			'charlieFlash' => 'Por favor, insira o nome de usu√°rio e a senha corretos',
			'charlieGhost' => 'Erro: ',
			'charlieHawk' => 'Nome de usu√°rio ou Gmail j√° registrado',
			'charlieLeaf' => 'Por favor, insira o conte√∫do',
			'charlieLight' => 'ID da postagem n√£o encontrado',
			'charlieRain' => 'Nenhum conte√∫do para traduzir',
			'charlieRay' => 'Erro ao abrir o Google Tradutor',
			'charlieSpark' => 'N√£o foi poss√≠vel ler o arquivo de imagem',
			'charlieSpin' => 'Erro ao ler o arquivo de imagem',
			'charlieStone' => 'Coment√°rio enviado',
			'charlieStormy' => 'Falha ao enviar coment√°rio: ',
			'charlieWalker' => 'Voc√™ s√≥ pode selecionar at√© 5 fotos',
			'cobaltBreeze' => 'Nenhum conte√∫do para traduzir',
			'cobaltEcho' => 'Erro ao abrir o Google Tradutor',
			'cobaltFire' => 'Erro ao remover curtida',
			'cobaltFlame' => 'Erro ao curtir',
			'cobaltFlash' => 'O dispositivo n√£o suporta entrada de voz',
			'cobaltGlow' => 'C√≥digo do usu√°rio copiado para a √°rea de transfer√™ncia',
			'cobaltLight' => 'Dispositivo n√£o suportado (API 26)',
			'cobaltRay' => 'Erro ao processar dados',
			'cobaltShadow' => 'M√°ximo de 5 fotos!',
			'language_updated' => 'Idioma atualizado',
			'back' => 'Voltar',
			'language' => 'Idioma',
			'english' => 'Ingl√™s',
			'portuguese' => 'Portugu√™s',
			'indonesian' => 'Indon√©sio',
			'spanish' => 'Espanhol',
			'cobaltStormy' => 'Destaque',
			'cobaltWave' => 'Jogo',
			'cobaltWing' => 'Aplicativo',
			'cosmicBolt' => '100% Online',
			'cosmicBreeze' => 'Baixar',
			'cosmicFang' => 'Mais',
			'cosmicFire' => 'Popular',
			'cosmicLight' => 'Novo',
			'cosmicRay' => 'Categoria',
			'cosmicSteel' => 'Mais',
			'cosmicStrike' => 'Minijogos',
			'cosmicWalker' => 'Instalar',
			'cosmicWing' => 'Gerenciador de downloads',
			'crimsonArrow' => 'Baixando',
			'crimsonBreeze' => 'Nenhum aplicativo baixado',
			'crimsonFire' => 'Nenhum download de aplicativo',
			'crimsonFlame' => 'Nenhum aplicativo instalado',
			'crimsonFlare' => 'Vers√£o',
			'crimsonGhost' => 'Conectando...',
			'crimsonHeart' => 'Eu',
			'crimsonLeaf' => 'Editar',
			'crimsonRay' => 'Gerenciamento',
			'crimsonRider' => 'Baixado',
			'crimsonSpark' => 'Ainda n√£o avaliado',
			'crimsonWave' => 'Mensagem',
			'darkClaw' => 'Responder',
			'darkFlame' => 'Siga-nos no Telegram',
			'darkFlare' => 'Site oficial',
			'darkGhost' => 'Enviar',
			'darkHeart' => 'Solicita√ß√£o',
			'darkIce' => 'Feedback',
			'darkLight' => 'Compartilhar',
			'darkRain' => 'Verificar atualiza√ß√µes',
			'darkShadow' => 'Pol√≠tica e privacidade',
			'darkWalker' => 'Aviso de rede m√≥vel',
			'darkWing' => 'Mostrar mensagem ao instalar',
			'deltaBlaze' => 'Mostrar mensagem ap√≥s a instala√ß√£o',
			'deltaBreeze' => 'Modo claro',
			'deltaEcho' => 'Pasta de downloads',
			'deltaFlash' => 'Outros',
			'deltaIce' => 'Idioma',
			'deltaLeaf' => 'Nome de usu√°rio',
			'deltaRain' => 'Limpar cache',
			'deltaRay' => '√çndice de mem√≥ria',
			'deltaStorm' => 'Jogo flash',
			'deltaStormy' => 'Sair',
			'echoArrow' => 'Ingl√™s',
			'echoBreeze' => 'Recomendado',
			'echoFang' => 'Pontua√ß√£o',
			'echoFire' => 'Usu√°rios',
			'echoFlame' => 'Downloads',
			'echoFlare' => 'Baixar',
			'echoFlash' => 'Informa√ß√µes MOD',
			'echoHawk' => 'Descri√ß√£o:',
			'echoIce' => 'Avaliar',
			'echoLight' => 'Escrever uma avalia√ß√£o',
			'echoPulse' => 'Classifica√ß√£o e avalia√ß√£o',
			'echoRider' => '√ötil',
			'echoShadow' => 'Ver todas as avalia√ß√µes',
			'echoSpark' => 'avalia√ß√µes',
			'echoStorm' => 'Todos os mod apk s√£o enviados pelos usu√°rios. Se houver alguma viola√ß√£o, envie uma reclama√ß√£o DMCA para n√≥s.',
			'echoStormy' => 'Detalhes',
			'echoWing' => 'Outras informa√ß√µes',
			'emberClaw' => 'Coment√°rio',
			'emberFlame' => 'Tradu√ß√£o',
			'emberGhost' => 'Todas as avalia√ß√µes',
			'emberHawk' => 'Jogo',
			'emberLight' => 'Aplicativo',
			'emberMist' => 'Nome de usu√°rio',
			'emberRain' => 'Insira seu nome de usu√°rio',
			'emberRider' => 'Senha',
			'emberShadow' => 'Insira sua senha',
			'emberWave' => 'Registrar uma nova conta',
			'fireArrow' => 'Recuperar conta do Facebook',
			'fireBolt' => 'Esqueceu sua senha?',
			'fireFlare' => '<u>Termos de servi√ßo</u>',
			'fireFlash' => '<u>Pol√≠tica de privacidade</u>',
			'fireMist' => 'Nome de usu√°rio (4-50 caracteres)',
			'fireRay' => 'Senha (6-8 caracteres)',
			'fireShadow' => 'Email (Opcional)',
			'fireWing' => 'N√∫mero de telefone (opcional)',
			'flameBreeze' => 'N√∫mero de telefone',
			'flameClaw' => 'Registrar',
			'flameEcho' => 'Quando voc√™ esquecer sua senha, precisar√° do seu n√∫mero de telefone ou e-mail para recuper√°-la. Recomendamos que voc√™ os complete.',
			'flameFlare' => 'Ao se registrar, voc√™ concorda com ',
			'flameMist' => 'Apenas letras a-z, n√∫meros (sem espa√ßos ou caracteres especiais). 4-50 caracteres.',
			'flameRain' => 'Apenas letras A-Z, a-z, n√∫meros (sem espa√ßos ou caracteres especiais). 6-8 caracteres.',
			'flameShadow' => 'Redefinir senha',
			'flameSpark' => 'Insira o nome de usu√°rio da sua conta para redefinir sua senha. Est√° com problemas para redefinir a senha do contact.us?',
			'flameStorm' => 'Pr√≥ximo',
			'flameStrike' => 'Por favor, insira seu e-mail ou n√∫mero de telefone. Est√° com problemas para redefinir a senha do contact.us?',
			'flameWave' => 'Insira seu Gmail',
			'flameWing' => 'N√£o se lembra de nenhum deles? Por favor, <u>registre uma nova conta.</u>',
			'foxtrotFire' => 'C√≥digo',
			'foxtrotFlare' => 'Insira o c√≥digo enviado para o seu e-mail',
			'foxtrotFlash' => 'Nova senha',
			'foxtrotMist' => 'Insira a nova senha',
			'foxtrotPulse' => 'Por favor, insira novamente a nova senha',
			'foxtrotRain' => 'Pesquisa popular',
			'foxtrotRay' => 'Hist√≥rico',
			'foxtrotSpin' => '‚ñ∂ O v√≠deo foi verificado',
			'foxtrotStone' => 'ü™ü nenhuma janela',
			'foxtrotWalker' => 'Aviso de atualiza√ß√£o',
			'foxtrotWave' => 'Notificar quando houver uma nova vers√£o do jogo',
			'foxtrotWing' => 'Nova atualiza√ß√£o',
			'frostClaw' => 'Nova vers√£o lan√ßada. Atualize agora!',
			'frostEcho' => 'Nenhum jogo dispon√≠vel',
			'frostFlash' => 'Mods de aplicativos recomendados',
			'frostGlow' => 'Mod popular',
			'frostLeaf' => 'Sugest√£o de hoje',
			'setting' => 'Configura√ß√µes',
			'frostLight' => '100% Jogar jogo',
			'frostSpin' => 'Tradu√ß√£o',
			'frostWave' => 'Nova vers√£o',
			'frostWing' => 'Atualizar agora',
			'ghostArrow' => 'Baixe o aplicativo em:',
			'ghostFlare' => 'via',
			'ghostFlash' => 'Minhas avalia√ß√µes',
			'ghostGhost' => 'Minhas respostas',
			'ghostGlow' => 'Jogos online',
			'ghostIce' => '100% Online',
			'ghostLeaf' => 'APK MOD',
			'ghostLight' => 'Restante',
			'ghostRay' => 'segundo',
			'ghostSpark' => 'Download conclu√≠do! Clique para instalar',
			'ghostSpin' => 'minuto',
			'ghostSpil' => 'Taverna',
			'label_select' => 'Selecionar',
			'label_check_in' => 'Check-in',
			'label_checked_in' => 'Check-in conclu√≠do',
			'status_upcoming' => 'Pr√≥ximos',
			'status_past' => 'Passados',
			'title_monthly_checkin' => 'Check-in mensal',
			'label_day' => 'dia',
			'ghostSteel' => 'Nenhum resultado encontrado',
			'opening' => 'Abrindo...',
			'opening_in_browser' => 'Abrindo no navegador...',
			'opened_browser_success' => 'Navegador aberto com sucesso',
			'error_starting_activity' => 'Erro ao iniciar atividade:',
			'choose_browser' => 'Escolher navegador',
			'error_opening_link' => 'Erro ao abrir link:',
			'no_content_to_translate' => 'Sem conte√∫do para traduzir',
			'no_url_to_open' => 'Nenhuma URL para abrir',
			'forum_post_label' => 'Postagem do f√≥rum:',
			'forum_render_error' => 'Erro ao renderizar a postagem do f√≥rum:',
			'error_opening_translation' => 'Erro ao abrir tradu√ß√£o',
			'yes' => 'Sim',
			'game_not_found' => 'Jogo n√£o encontrado',
			'missing_forum_id' => 'Faltando forum_id',
			'api_success_false' => 'A API retornou success=false',
			'data_error' => 'Erro de dados',
			'failed_to_load_data' => 'Falha ao carregar dados',
			'data_display_error' => 'Erro ao exibir dados',
			'error_open_post_link_in_browser' => 'Erro em openPostLinkInBrowser:',
			'related_post' => 'post relacionado',
			'error_parse_related_posts' => 'Erro ao analisar related_posts:',
			'error_api_post_detail' => 'Erro da API para post-detail:',
			'say_something' => 'Diga algo...',
			'confirmDelete' => 'Confirmar exclus√£o',
			'areYouSure' => 'Tem certeza de que deseja excluir este arquivo?',
			'delete' => 'Excluir',
			'cancel' => 'Cancelar',
			'terms_of_service' => '<u>Termos de servi√ßo</u>',
			'terms_of_service_2' => '<u>Pol√≠tica de privacidade</u>',
			'terms_of_service_3' => 'N√£o se lembra de nenhum deles? Por favor, <u>registre uma nova conta.</u>',
            'publish' => 'Publicar',

            'add_catchy_title' => 'Adicione um t√≠tulo chamativo para obter mais visualiza√ß√µes',
            'write_thoughts_here' => 'Escreva seus pensamentos aqui (tente algumas ideias üí°)',
            'pick_a_game' => 'Escolha um jogo',
            'failed_to_load_games' => 'Falha ao carregar jogos',
            'please_enter_title_content' => 'Por favor, insira o t√≠tulo e o conte√∫do',
            'please_select_game_before_publishing' => 'Selecione um jogo antes de publicar',
            'max_photos_warning' => 'Voc√™ s√≥ pode selecionar at√© 5 fotos',
            'sent_wait_for_approval' => 'Enviado! Aguarde a aprova√ß√£o do administrador',

            'for_you' => 'Para voc√™',
            'congratulations_reward' => 'Parab√©ns, voc√™ receber√°:',
            'fill_info_to_receive_reward' => 'Preencha as informa√ß√µes para receber a recompensa üéä',
            'enter_your_name' => 'Digite seu nome',
            'enter_gmail_reward' => 'Digite seu Gmail para receber a recompensa',
            'send' => 'Enviar',

            'user_id_not_found' => '‚ùå ID de usu√°rio n√£o encontrado. Por favor, fa√ßa login novamente.',
            'please_fill_all_fields' => '‚ö†Ô∏è Por favor, preencha todos os campos',
            'failed_to_connect_server' => '‚ùå Falha ao conectar ao servidor',
            'cannot_check_payment_status' => '‚ö†Ô∏è N√£o foi poss√≠vel verificar o status do pagamento',

            'type_a_message' => 'Digite uma mensagem...',
            'sending_failed' => '‚ùå Falha ao enviar:',
            'message_sending_failed' => '‚ùå Falha no envio da mensagem',
            'hello_admin_will_reply' => 'üëã Ol√°! Obrigado por entrar em contato. O administrador responder√° o mais r√°pido poss√≠vel ‚ù§Ô∏è',
            'unable_to_load_message' => 'N√£o foi poss√≠vel carregar a mensagem:',
            'add_catchy_title'    => 'Tambahkan judul yang menarik',
            'write_thoughts_here' => 'Tulis ide Anda di sini',
            'notifications' => 'Notifica√ß√µes',
            'payment_info_sent' => 'As informa√ß√µes de pagamento foram enviadas com sucesso, aguarde o administrador confirmar e efetuar o pagamento.',
           'please_login_first'            => 'Por favor, fa√ßa login primeiro',
          'game_link_not_available'       => 'Link do jogo n√£o dispon√≠vel',
          'pending_approval'              => 'Aguardando aprova√ß√£o...',
          'comment_sent_waiting'          => 'Coment√°rio enviado! Aguardando aprova√ß√£o...',
          'comment_approved_published'    => 'Coment√°rio aprovado e publicado!',
          'reply_sent_waiting'            => 'Resposta enviada! Aguardando aprova√ß√£o...',
          'reply_approved_published'      => 'Resposta aprovada e publicada!',
          'copied_to_clipboard'           => 'Copiado para a √°rea de transfer√™ncia',
          'no_content_to_copy'            => 'Nenhum conte√∫do para copiar',
          'deleted'                       => 'Exclu√≠do',
          'delete_failed'                 => 'Falha ao excluir',
          'language_updated_successfully' => 'Idioma atualizado com sucesso',
            'user_info_updated_successfully' => 'Informa√ß√µes do usu√°rio atualizadas com sucesso!',
    'choose_avatar' => 'Escolher avatar',
'no_notifications_available' => 'Nenhuma notifica√ß√£o dispon√≠vel',
'save' => 'Salvar',
'recipient_information' => 'Informa√ß√µes do destinat√°rio',
'full_name' => 'Nome completo',
'enter_full_name' => 'Digite seu nome completo',
'nation' => 'Na√ß√£o',
'currency' => 'Moeda',

'receiving_bank_information' => 'Informa√ß√µes do banco receptor',
'swift_code' => 'C√≥digo SWIFT',
'enter_swift_code' => 'Digite o c√≥digo SWIFT',
'branch_number' => 'N√∫mero da ag√™ncia/Tr√¢nsito/Institui√ß√£o/Outro',
'enter_branch_number' => 'Digite as informa√ß√µes',

'beneficiary_information' => 'Informa√ß√µes do benefici√°rio',
'beneficiary_iban' => 'N√∫mero da conta/IBAN do benefici√°rio',
'enter_beneficiary_iban' => 'Digite o n√∫mero da conta ou IBAN',
'beneficiary' => 'Benefici√°rio',
'enter_beneficiary' => 'Digite o nome do benefici√°rio',
'beneficiary_address' => 'Endere√ßo do benefici√°rio',
'enter_beneficiary_address' => 'Digite o endere√ßo',

'monthly_roll_call' => 'Chamada mensal',
'monthly_roll_call_desc' => 'Complete miss√µes di√°rias de 30 minutos em eventos de jogos online para receber recompensas',
'redeem_reward_points' => 'Voc√™ pode resgatar pontos de recompensa:',
'exchange_rewards' => 'Trocar recompensas',
'check_ins' => 'Check-ins di√°rios',
'days' => 'dias',
'click_here_to_join_the_event' => 'Clique aqui para participar do evento',
'checkin_playtime' => 'Conclua os tempos de jogo abaixo para fazer check-in e receber recompensas:',
'amount_to_receive' => 'Cantidad a recibir',
'enter_amount' => 'Ingrese la cantidad (n√∫mero entero)',
'choose_bank' => 'Elija un banco',
'amount_validation' => 'La cantidad debe ser un n√∫mero entero y menor que el saldo disponible',

            'chat_with_admin' => 'Conversar com o administrador'
		]

    ];

    // ‚úÖ N·∫øu ng√¥n ng·ªØ t·ªìn t·∫°i ‚Üí d√πng b·∫£n d·ªãch c·ªßa ng√¥n ng·ªØ ƒë√≥
    // ‚úÖ N·∫øu kh√¥ng t·ªìn t·∫°i ‚Üí fallback sang ti·∫øng Anh
    $result = isset($translations[$user_lang]) ? $translations[$user_lang] : $strings;

    return wp_send_json([
        'success'  => true,
        'user_id'  => $user_id,
        'language' => $user_lang,
        'strings'  => $result
    ], 200, JSON_UNESCAPED_UNICODE);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/top-game-online', [
        'methods'  => 'GET',
        'callback' => 'handle_top_game_online',
        'permission_callback' => '__return_true',
    ]);
});

function handle_top_game_online(WP_REST_Request $request) {
    // üì• Nh·∫≠n d·ªØ li·ªáu t·ª´ request
    $user_id   = sanitize_text_field($request->get_param('user_id'));
    $score     = intval($request->get_param('score'));
    $game_id   = sanitize_text_field($request->get_param('game_id'));
    $time      = sanitize_text_field($request->get_param('time'));
    $timestamp = intval($request->get_param('timestamp'));
    $signature = sanitize_text_field($request->get_param('signature'));

    // üõ°Ô∏è Ki·ªÉm tra tham s·ªë b·∫Øt bu·ªôc
    if (empty($user_id) || empty($game_id) || empty($signature) || empty($time)) {
        return new WP_REST_Response([
            'status'  => 'error',
            'message' => 'Missing required parameters'
        ], 400);
    }

    // üîç T√¨m user trong post type user-mobile
    $query = new WP_Query([
        'post_type'  => 'user-mobile',
        'meta_query' => [
            [
                'key'   => 'id',
                'value' => $user_id,
                'compare' => '='
            ]
        ],
        'posts_per_page' => 1
    ]);

    if (!$query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    // üîß L·∫•y ra post ID c·ªßa user-mobile
    $user_post_id = $query->posts[0]->ID;

    // üïê Ch·ªëng replay attack ‚Äì ch·ªØ k√Ω ch·ªâ c√≥ hi·ªáu l·ª±c 5 ph√∫t
    if (abs(time() - $timestamp) > 300) {
        return new WP_REST_Response([
            'status'  => 'error',
            'message' => 'Signature expired'
        ], 403);
    }

    // ‚úÖ T·∫°o ch·ªØ k√Ω ƒë·ªÉ x√°c minh
    $secretKey = 'YOUR_SUPER_SECRET_KEY';
    $rawData   = $user_id . $score . $game_id . $time . $timestamp;
    $expectedSignature = hash_hmac('sha256', $rawData, $secretKey);

    if (!hash_equals($expectedSignature, $signature)) {
        return new WP_REST_Response([
            'status'  => 'error',
            'message' => 'Invalid signature'
        ], 403);
    }

    // üî¢ ==========================
    // üìå TƒÇNG L∆Ø·ª¢T G·ª¨I CHO USER
    // ============================
    $current_count = get_post_meta($user_post_id, 'submit_count', true);
    if (!$current_count) $current_count = 0;

    $current_count++;
    update_post_meta($user_post_id, 'submit_count', $current_count);
    // ============================

    // üìù T·∫°o m·ªõi m·ªôt b·∫£n ghi ƒëi·ªÉm
    $post_id = wp_insert_post([
        'post_type'   => 'top-game-online',
        'post_status' => 'publish',
        'post_title'  => "Score - {$user_id} - {$game_id} - {$score}"
    ]);

    if (!$post_id) {
        return new WP_REST_Response([
            'status'  => 'error',
            'message' => 'Failed to insert score'
        ], 500);
    }

    // üß† L∆∞u d·ªØ li·ªáu v√†o ACF fields
    update_field('user_id', $user_id, $post_id);
    update_field('score', $score, $post_id);
    update_field('game_id', $game_id, $post_id);
    update_field('time', $time, $post_id);

    return new WP_REST_Response([
        'status'  => 'success',
        'message' => 'Score inserted successfully',
        'data'    => [
            'post_id'       => $post_id,
            'user_id'       => $user_id,
            'game_id'       => $game_id,
            'score'         => $score,
            'time'          => $time,
            'submit_count'  => $current_count
        ]
    ], 200);
}


// üí∞ B·∫£ng ti·ªÅn theo TOP
$money_by_top = [];

// T·ª´ top 1 ‚Üí 10: m·ªói ng∆∞·ªùi 100
for ($i = 1; $i <= 10; $i++) {
    $money_by_top[$i] = 100;
}

// T·ª´ top 11 ‚Üí 50: m·ªói ng∆∞·ªùi 50
for ($i = 11; $i <= 50; $i++) {
    $money_by_top[$i] = 50;
}

// T·ª´ top 51 ‚Üí 100: m·ªói ng∆∞·ªùi 20
for ($i = 51; $i <= 100; $i++) {
    $money_by_top[$i] = 20;
}

// Ngo√†i top 100: m·∫∑c ƒë·ªãnh 5
$default_money = 5;
 
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/notifications', [
        'methods'  => 'GET',
        'callback' => 'get_notifications',
        'permission_callback' => '__return_true'
    ]);
});

function get_notifications($request) {
    global $wpdb;
    $table = $wpdb->prefix . 'postmeta';

    $user_id   = sanitize_text_field($request->get_param('user_id') ?? 0);
    $game      = 9613;
    $user_lang = 'en';
    $user_money = 0;

    // üïí Th·ªùi gian tu·∫ßn hi·ªán t·∫°i
    $start_week = date('Y-m-d 00:00:00', strtotime('monday this week'));
    $end_week   = date('Y-m-d 23:59:59', strtotime('sunday this week'));

    $current = current_time('timestamp');
    $month   = date('m', $current);
    $year    = date('Y', $current);

    if ($month == 11 && $year == 2025) {
        // üóìÔ∏è N·∫øu l√† th√°ng 11/2025 ‚Üí t√≠nh c·∫£ th√°ng 10
        $start_of_month = date('Y-m-01 00:00:00', strtotime('-1 month', $current));
        $end_of_month   = date('Y-m-t 23:59:59', $current);
    } else {
        // üóìÔ∏è C√°c th√°ng kh√°c ‚Üí ch·ªâ t√≠nh trong th√°ng hi·ªán t·∫°i
        $start_of_month = date('Y-m-01 00:00:00', $current);
        $end_of_month   = date('Y-m-t 23:59:59', $current);
    }



    // ƒê·ªãnh d·∫°ng hi·ªÉn th·ªã ƒë·∫πp
    $formatted_week_start  = date('d/m/Y', strtotime($start_week));
    $formatted_week_end    = date('d/m/Y', strtotime($end_week));
    $formatted_month_start = date('d/m/Y', strtotime($start_of_month));
    $formatted_month_end   = date('d/m/Y', strtotime($end_of_month));
    $received_money_text = [
        'en' => 'You received',
        'vi' => 'B·∫°n ƒë√£ nh·∫≠n',
        'es' => 'Has recibido',
        'id' => 'Anda menerima',
        'pt' => 'Voc√™ recebeu',
    ];


    // üîç L·∫•y ng√¥n ng·ªØ & ti·ªÅn t·ª´ user-mobile
    if (!empty($user_id)) {
        $query = new WP_Query([
            'post_type'  => 'user-mobile',
            'meta_query' => [[
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]],
            'posts_per_page' => 1
        ]);

     if ($query->have_posts()) {

    $post = $query->posts[0];

    // ‚≠ê L·∫•y l·ªãch s·ª≠ thanh to√°n t·ª´ admin
    $payment_history_raw = get_post_meta($post->ID, 'payment_history', true);
    $payment_history_raw = is_array($payment_history_raw) ? $payment_history_raw : [];

    // ‚≠ê Language
    $lang_meta = get_post_meta($post->ID, 'language', true);
    $user_lang = !empty($lang_meta) ? $lang_meta : 'en';

    // ‚≠ê T·ª∂ GI√Å (GI·ªêNG LOGIC C≈® ‚Äì CH·ªà NH√ÇN)
    $USD_TO_VND = 20000;
    $USD_TO_IDR = 15000;

    // ‚≠ê T·∫°o chu·ªói hi·ªÉn th·ªã
    $reward_lines = [];

    foreach ($payment_history_raw as $item) {
        if (!empty($item['date']) && isset($item['amount'])) {

            // USD g·ªëc
            $amount_usd = is_array($item['amount']) ? 0 : (float) $item['amount'];

            // üîÅ GI·ªÆ LOGIC ‚Äì CH·ªà ƒê·ªîI GI√Å TR·ªä
            if ($user_lang === 'vi') {
                $amount = number_format($amount_usd * $USD_TO_VND, 0, ',', '.');
            } elseif ($user_lang === 'id') {
                $amount = number_format($amount_usd * $USD_TO_IDR, 0, ',', '.');
            } else {
                $amount = number_format($amount_usd, 2);
            }

            $reward_lines[] =
                $received_money_text[$user_lang]
                . ' ' . $amount
                . ' : ' . $item['date'];
        }
    }

    // ‚≠ê Chu·ªói xu·ªëng d√≤ng
    $reward_history_text = implode("\n", $reward_lines);

    // ===== MONEY (GI·ªÆ NGUY√äN LOGIC C≈®) =====
    $money_week       = get_post_meta($post->ID, 'money_week', true);
    $money_month      = 0;
    $money_diem_danh  = get_post_meta($post->ID, 'money_diem_danh', true);
    $payment_confirmed = get_post_meta($post->ID, 'payment_confirmed', true);

    // Chu·∫©n h√≥a
    $user_money_week      = is_array($money_week) ? 0 : ($money_week ?: 0);
    $user_money_month     = $money_month ?: 0;
    $user_money_diem_danh = is_array($money_diem_danh) ? 0 : ($money_diem_danh ?: 0);

    // üî• T·ªîNG TI·ªÄN ‚Äì KH√îNG ƒê·ªîI BI·∫æN
    if ($user_lang === 'vi') {
        $user_money = $user_money_diem_danh * $USD_TO_VND;
    } elseif ($user_lang === 'id') {
        $user_money = $user_money_diem_danh * $USD_TO_IDR;
    } else {
        $user_money = $user_money_diem_danh;
    }
}


        wp_reset_postdata();
    }

    // üß† Ti√™u ƒë·ªÅ ƒëa ng√¥n ng·ªØ
    $title_texts = [
        'en' => 'Notifications',
        'vi' => 'Th√¥ng b√°o',
        'es' => 'Notificaciones',
        'id' => 'Notifikasi',
        'pt' => 'Notifica√ß√µes'
    ];

    // üß† N·ªôi dung th√¥ng b√°o ch√≠nh
    $notifications_text = [
        'en' => ["üèÜ Score Ranking of Month Event ($formatted_month_start ‚Üí $formatted_month_end)"],
        'vi' => ["üèÜ B·∫£ng X·∫øp H·∫°ng ƒêi·ªÉm c·ªßa S·ª± Ki·ªán Th√°ng ($formatted_month_start ‚Üí $formatted_month_end)"],
        'es' => ["üèÜ Clasificaci√≥n de Puntuaci√≥n del Evento Mensual ($formatted_month_start ‚Üí $formatted_month_end)"],
        'id' => ["üèÜ Peringkat Skor Acara Bulan Ini ($formatted_month_start ‚Üí $formatted_month_end)"],
        'pt' => ["üèÜ Classifica√ß√£o de Pontua√ß√£o do Evento do M√™s ($formatted_month_start ‚Üí $formatted_month_end)"],
    ];

    // üìå Ti√™u ƒë·ªÅ t·ª´ng m·ª•c (week v√† month)
    $item_titles = [
        'week' => [
            'en' => "üèÜ Score Ranking of Week Event ($formatted_week_start ‚Üí $formatted_week_end)",
            'vi' => "üèÜ X·∫øp H·∫°ng ƒêi·ªÉm c·ªßa S·ª± Ki·ªán Tu·∫ßn ($formatted_week_start ‚Üí $formatted_week_end)",
            'es' => "üèÜ Clasificaci√≥n de puntuaciones del evento de la semana ($formatted_week_start ‚Üí $formatted_week_end)",
            'id' => "üèÜ Peringkat Skor Acara Minggu Ini ($formatted_week_start ‚Üí $formatted_week_end)",
            'pt' => "üèÜ Classifica√ß√£o de pontua√ß√£o do evento da semana ($formatted_week_start ‚Üí $formatted_week_end)"
        ],
        'month' => [
            'en' => "üèÜ Score Ranking of Month Event ($formatted_month_start ‚Üí $formatted_month_end)",
            'vi' => "üèÜ B·∫£ng X·∫øp H·∫°ng ƒêi·ªÉm c·ªßa S·ª± Ki·ªán Th√°ng ($formatted_month_start ‚Üí $formatted_month_end)",
            'es' => "üèÜ Clasificaci√≥n de puntuaci√≥n del evento mensual ($formatted_month_start ‚Üí $formatted_month_end)",
            'id' => "üèÜ Peringkat Skor Acara Bulan Ini ($formatted_month_start ‚Üí $formatted_month_end)",
            'pt' => "üèÜ Classifica√ß√£o de pontua√ß√£o do evento do m√™s ($formatted_month_start ‚Üí $formatted_month_end)"
        ]
    ];

    // ü™ô "Claim Reward"
    $top_text_text = [
        'en' => 'Claim Reward',
        'vi' => 'Nh·∫≠n th∆∞·ªüng',
        'es' => 'Reclamar recompensa',
        'id' => 'Klaim hadiah',
        'pt' => 'Resgatar recompensa'
    ];

$reward_received_text = [
    'en' => "Reward History\n" . $reward_history_text,
    'vi' => "L·ªãch s·ª≠ nh·∫≠n th∆∞·ªüng\n" . $reward_history_text,
    'es' => "Historial de recompensas\n" . $reward_history_text,
    'id' => "Riwayat hadiah\n" . $reward_history_text,
    'pt' => "Hist√≥rico de recompensas\n" . $reward_history_text
];



    // ‚ùó N·∫øu user ƒë√£ thanh to√°n ‚Üí ghi ƒë√® list_text_all th√†nh ch·ªâ 1 d√≤ng
    if ($payment_confirmed) {
        $list_text_all = [
            'en' => [ $reward_received_text['en'] ],
            'vi' => [ $reward_received_text['vi'] ],
            'es' => [ $reward_received_text['es'] ],
            'id' => [ $reward_received_text['id'] ],
            'pt' => [ $reward_received_text['pt'] ]
        ];
    }

    // L·∫•y list_text theo ng√¥n ng·ªØ
    $list_text = $list_text_all[$user_lang] ?? $list_text_all['en'];

    
    $top_text_label = $top_text_text[$user_lang] ?? $top_text_text['en'];

    // üí∞ N·∫øu c√≥ ti·ªÅn th∆∞·ªüng
        $top_text = null;
   if ($user_money > 0) {

    // ===== FORMAT TOP TEXT THEO LANGUAGE (GI·ªÆ LOGIC) =====
    if ($user_lang === 'vi') {
        $top_text = $top_text_label . ' ' . number_format((float)$user_money, 0, ',', '.') ;
    } elseif ($user_lang === 'id') {
        $top_text = $top_text_label . ' ' . number_format((float)$user_money, 0, ',', '.');
    } else {
        // en
        $top_text = $top_text_label . ' ' . number_format((float)$user_money, 2);
    }

    return [
        'title'      => $title_texts[$user_lang] ?? $title_texts['en'],
        'items'      => [
            [
                'id'    => 1,
                'title' => $item_titles['week'][$user_lang] ?? $item_titles['week']['en'],
                'icon'  => 'https://apkmodjoy.net/wp-content/uploads/2025/04/index-mascot-mobile.webp',
                'type'  => 'hot_week',
                'link'  => '/custom-api/v1/top-game/week'
            ],
            [
                'id'    => 2,
                'title' => $item_titles['month'][$user_lang] ?? $item_titles['month']['en'],
                'icon'  => 'https://apkmodjoy.net/wp-content/uploads/2025/04/index-mascot-mobile.webp',
                'type'  => 'hot_month',
                'link'  => '/custom-api/v1/top-game/month'
            ]
        ],
        'top_text'   => $top_text,
        'money'      => $user_money,
        'user_id'    => $user_id,
        'list_text'  => $list_text,
        'language'   => $user_lang
    ];
}

    else{
            return [
        'title'      => $title_texts[$user_lang] ?? $title_texts['en'],
        'items'      => [
            [
                'id'    => 1,
                'title' => $item_titles['week'][$user_lang] ?? $item_titles['week']['en'],
                'icon'  => 'https://apkmodjoy.net/wp-content/uploads/2025/04/index-mascot-mobile.webp',
                'type'  => 'hot_week',
                'link'  => '/custom-api/v1/top-game/week'
            ],
            [
                'id'    => 2,
                'title' => $item_titles['month'][$user_lang] ?? $item_titles['month']['en'],
                'icon'  => 'https://apkmodjoy.net/wp-content/uploads/2025/04/index-mascot-mobile.webp',
                'type'  => 'hot_month',
                'link'  => '/custom-api/v1/top-game/month'
            ]
        ],

        'money'        => $user_money,
        'user_id'      => $user_id,
                'list_text'      => $list_text,
        'language'     => $user_lang
    ];
    }
}



add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/notifications', [
        'methods'  => 'GET',
        'callback' => 'get_notifications',
    ]);
});
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/app-event-options', [
        'methods'  => 'GET',
        'callback' => 'get_event_options',
        'permission_callback' => '__return_true'
    ]);
});



function get_event_options(WP_REST_Request $request) {
    // üß© L·∫•y user_id t·ª´ request
    $user_id = sanitize_text_field($request->get_param('user_id') ?? '');

    // M·∫∑c ƒë·ªãnh l√† ti·∫øng Anh
    $lang = 'en';

    // =========================================
    // üåç 1Ô∏è‚É£ L·∫§Y NG√îN NG·ªÆ T·ª™ user-mobile (n·∫øu c√≥)
    // =========================================
    if (!empty($user_id)) {
        $user_query = new WP_Query([
            'post_type'      => 'user-mobile',
            'posts_per_page' => 1,
            'meta_query'     => [
                [
                    'key'     => 'id',
                    'value'   => $user_id,
                    'compare' => '='
                ]
            ]
        ]);

        if ($user_query->have_posts()) {
            $user_post = $user_query->posts[0];
            $lang_meta = get_post_meta($user_post->ID, 'lang', true);

            if (!empty($lang_meta)) {
                $lang = strtolower($lang_meta);
            }
        }
    }

    // =========================================
    // üóìÔ∏è 2Ô∏è‚É£ T√çNH NG√ÄY ƒê·∫¶U & CU·ªêI TH√ÅNG
    // =========================================
    $formatted_start = date('d/m/Y', strtotime(date('Y-m-01')));
    $formatted_end_next_month = date('d/m/Y', strtotime('last day of next month'));


    // =========================================
    // üî§ 3Ô∏è‚É£ TEXT THEO NG√îN NG·ªÆ
    // =========================================
    $week_texts = [
        'en' => "üéâ Week Events - Play and Win Gifts",
        'vi' => "üéâ S·ª± Ki·ªán Tu·∫ßn - Ch∆°i Ngay Nh·∫≠n Qu√†",
        'es' => "üéâ Eventos Semanales - Juega y Gana Premios",
        'id' => "üéâ Acara Mingguan - Main dan Menangkan Hadiah",
        'pt' => "üéâ Eventos Semanais - Jogue e Ganhe Pr√™mios",
    ];

    $month_texts = [
        'en' => "üéâ Monthly Events - Play and Win Gifts ($formatted_start ‚Üí $formatted_end)",
        'vi' => "üéâ S·ª± Ki·ªán Th√°ng - Ch∆°i Ngay Nh·∫≠n Qu√† ($formatted_start ‚Üí $formatted_end)",
        'es' => "üéâ Eventos Mensuales - Juega y Gana Premios ($formatted_start ‚Üí $formatted_end)",
        'id' => "üéâ Acara Bulanan - Main dan Menangkan Hadiah ($formatted_start ‚Üí $formatted_end)",
        'pt' => "üéâ Eventos Mensais - Jogue e Ganhe Pr√™mios ($formatted_start ‚Üí $formatted_end)",
    ];

    // =========================================
    // üñºÔ∏è 4Ô∏è‚É£ BANNER
    // =========================================
    $banners = [
        'week' => [
            'img'       => 'https://apkmodjoy.com/wp-content/uploads/2025/10/event-week-banner.webp',
            'url'       => 'https://apkmodjoy.com/game-online/dinosaur-game/',
            'direction' => 'Horizontal',
        ],
        'month' => [
            'img'       => 'https://apkmodjoy.com/wp-content/uploads/2025/10/Dinosaur-Games-page-banners-desktop-1920x700-1.webp',
            'url'       => 'https://apkmodjoy.com/game-online/dinosaur-game/',
            'direction' => 'Horizontal',
        ],
    ];

    // =========================================
    // üéØ 5Ô∏è‚É£ GH√âP D·ªÆ LI·ªÜU TR·∫¢ V·ªÄ
    // =========================================
    $data = [
        'month' => [
            'text'      => $month_texts[$lang] ?? $month_texts['en'],
            'img'       => $banners['month']['img'],
            'url'       => $banners['month']['url'],
            'direction' => $banners['month']['direction'],
        ],
        // B·ªè tu·∫ßn n·∫øu ch∆∞a c·∫ßn
        // 'week' => [
        //     'text'      => $week_texts[$lang] ?? $week_texts['en'],
        //     'img'       => $banners['week']['img'],
        //     'url'       => $banners['week']['url'],
        //     'direction' => $banners['week']['direction'],
        // ],
    ];

    // =========================================
    // ‚úÖ TR·∫¢ K·∫æT QU·∫¢
    // =========================================
    return rest_ensure_response([
        'success'  => true,
        'language' => $lang,
        'data'     => $data,
    ]);
}




// üìå REST API endpoint: /wp-json/custom-api/v1/time
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/time', [
        'methods'  => 'GET',
        'callback' => 'get_utc_time_data',
        'permission_callback' => '__return_true'
    ]);
});

function get_utc_time_data(WP_REST_Request $request) {
    // üåç Gi·ªù chu·∫©n qu·ªëc t·∫ø UTC
    date_default_timezone_set('UTC');

    // üß† L·∫•y tham s·ªë ng√¥n ng·ªØ (m·∫∑c ƒë·ªãnh: en)

// üß† ∆Øu ti√™n l·∫•y lang t·ª´ query ho·∫∑c user_id
$lang = strtolower($request->get_param('lang') ?? '');
$user_id = sanitize_text_field($request->get_param('user_id') ?? '');

// üìå N·∫øu ch∆∞a c√≥ lang ‚Üí th·ª≠ l·∫•y t·ª´ user_id
if (empty($lang) && !empty($user_id)) {
    $user_query = new WP_Query([
        'post_type'      => 'user-mobile',
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]
        ],
        'posts_per_page' => 1
    ]);

    if ($user_query->have_posts()) {
        $user_post = $user_query->posts[0];
        $lang_meta = get_post_meta($user_post->ID, 'language', true);
        if (!empty($lang_meta)) {
            $lang = strtolower($lang_meta);
        }
    }
    wp_reset_postdata();
}

// üì¶ N·∫øu v·∫´n ch∆∞a c√≥ lang ‚Üí m·∫∑c ƒë·ªãnh en
if (empty($lang)) {
    $lang = 'en';
}

// üåç Map timezone theo t·ª´ng ng√¥n ng·ªØ
$timezone_map = [
    'en' => 'UTC',               // üåê Gi·ªù chu·∫©n qu·ªëc t·∫ø
    'vi' => 'Asia/Ho_Chi_Minh',  // üáªüá≥ Vi·ªát Nam (+07:00)
    'id' => 'Asia/Jakarta',      // üáÆüá© Indonesia (+07:00)
    'es' => 'Europe/Madrid',     // üá™üá∏ T√¢y Ban Nha (+01:00)
    'pt' => 'Europe/Lisbon',     // üáµüáπ B·ªì ƒê√†o Nha (+00:00)
];

// üìç ƒê·∫∑t timezone theo ng√¥n ng·ªØ (fallback: UTC)
$timezone = $timezone_map[$lang] ?? 'UTC';
date_default_timezone_set($timezone);

// üß† L·∫•y th·ªùi gian hi·ªán t·∫°i theo timezone n√†y
$now = time();
$current_date = date('Y-m-d', $now);
$current_time = date('H:i:s', $now);


    // üïê T·∫°o danh s√°ch m·ªëc 30 ph√∫t
    $slots = [];
    $start = strtotime('00:00');
    $end = strtotime('23:59');
    for ($time = $start; $time <= $end; $time += 30 * 60) {
        $slots[] = date('H:i', $time);
    }

    // üìÖ T√¨m m·ªëc ti·∫øp theo
    $current_Hi = date('H:i', $now);
    $next_slot = null;
    foreach ($slots as $slot) {
        if (strtotime($slot) > strtotime($current_Hi)) {
            $next_slot = $slot;
            break;
        }
    }
    if (!$next_slot) $next_slot = '00:00';

    // üåê D·ªãch nh√£n v√† timezone ƒëa ng√¥n ng·ªØ
    $translations = [
        'en' => [
            'timezone_label' => 'Timezone',
            'timezone_value' => 'UTC (+00:00)',
            'current_date' => 'Current Date',
            'current_time' => 'Current Time',
            'next_30min_slot' => 'Next 30-Min Slot'
        ],
        'vi' => [
            'timezone_label' => 'M√∫i gi·ªù',
            'timezone_value' => 'UTC (+00:00) - Gi·ªù chu·∫©n qu·ªëc t·∫ø',
            'current_date' => 'Ng√†y hi·ªán t·∫°i',
            'current_time' => 'Gi·ªù hi·ªán t·∫°i',
            'next_30min_slot' => 'M·ªëc 30 ph√∫t ti·∫øp theo'
        ],
        'id' => [
            'timezone_label' => 'Zona waktu',
            'timezone_value' => 'UTC (+00:00) - Waktu Universal Terkoordinasi',
            'current_date' => 'Tanggal saat ini',
            'current_time' => 'Waktu saat ini',
            'next_30min_slot' => 'Slot 30 menit berikutnya'
        ],
        'es' => [
            'timezone_label' => 'Zona horaria',
            'timezone_value' => 'UTC (+00:00) - Tiempo Universal Coordinado',
            'current_date' => 'Fecha actual',
            'current_time' => 'Hora actual',
            'next_30min_slot' => 'Pr√≥ximo intervalo de 30 min'
        ],
        'pt' => [
            'timezone_label' => 'Fuso hor√°rio',
            'timezone_value' => 'UTC (+00:00) - Tempo Universal Coordenado',
            'current_date' => 'Data atual',
            'current_time' => 'Hora atual',
            'next_30min_slot' => 'Pr√≥ximo intervalo de 30 min'
        ]
    ];

    // N·∫øu ng√¥n ng·ªØ kh√¥ng t·ªìn t·∫°i -> fallback v·ªÅ en
    $t = $translations[$lang] ?? $translations['en'];

    // üì§ Tr·∫£ v·ªÅ JSON
    return new WP_REST_Response([
            'timezone_label'    => $t['timezone_value'],
            'current_date'      => $current_date,
            'current_time'      => $current_time,
            'next_30min_slot'   => $next_slot,
        'lang'                  => $lang
    ], 200);
}





function get_top_game_week($request) {
    global $wpdb;
    $table = $wpdb->prefix . 'postmeta';

    $game     = 57004;
    $limit    = 100;
    $user_id  = sanitize_text_field($request->get_param('user_id'));

    // üïí Gi·ªØ timezone ƒë√∫ng theo WordPress
    date_default_timezone_set(wp_timezone_string());

    // üìÖ Th·ªùi gian tu·∫ßn hi·ªán t·∫°i (Th·ª© 2 ‚Üí Ch·ªß nh·∫≠t)
    $start = date('Y-m-d 00:00:00', strtotime('monday this week'));
    $current = current_time('timestamp');
    $minute  = floor(date('i', $current) / 30) * 30;
    $end     = date('Y-m-d H:' . str_pad($minute, 2, '0', STR_PAD_LEFT) . ':00', $current);

    // üöÄ Cache key cho ph·∫ßn data ch√≠nh (kh√¥ng bao g·ªìm user)
    $cache_key = 'top_game_week_' . $game . '_' . date('Y-W', strtotime($start)) . '_' . $minute;
    $cached_data = get_transient($cache_key);

    // üí∞ B·∫£ng th∆∞·ªüng DINO theo Top (1‚Äì100)
    $money_by_top = [
        1=>300, 2=>250, 3=>200, 4=>180, 5=>170, 6=>160, 7=>150, 8=>140, 9=>130, 10=>120,
        11=>110, 12=>100, 13=>95, 14=>90, 15=>85, 16=>80, 17=>75, 18=>70, 19=>65, 20=>60,
        21=>55, 22=>50, 23=>45, 24=>40, 25=>35, 26=>30, 27=>25, 28=>20, 29=>15, 30=>10,
        31=>10, 32=>10, 33=>10, 34=>10, 35=>10, 36=>10, 37=>10, 38=>10, 39=>10, 40=>10,
        41=>10, 42=>10, 43=>10, 44=>10, 45=>10, 46=>10, 47=>10, 48=>10, 49=>10, 50=>5,
        51=>5, 52=>5, 53=>5, 54=>5, 55=>5, 56=>5, 57=>5, 58=>5, 59=>5, 60=>5,
        61=>5, 62=>5, 63=>5, 64=>5, 65=>5, 66=>5, 67=>5, 68=>5, 69=>5, 70=>2,
        71=>2, 72=>2, 73=>2, 74=>2, 75=>2, 76=>2, 77=>2, 78=>2, 79=>2, 80=>2,
        81=>2, 82=>2, 83=>2, 84=>2, 85=>2, 86=>2, 87=>2, 88=>2, 89=>2, 90=>1,
        91=>1, 92=>1, 93=>1, 94=>1, 95=>1, 96=>1, 97=>1, 98=>1, 99=>1, 100=>1
    ];

    $default_money = 0;

    // üß© Helper: L·∫•y th√¥ng tin user theo ACF id
    $get_user_info = function($acf_user_id) {
        $default_image = 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';
        $default_name  = 'Anonymous';
        if (empty($acf_user_id)) return ['name'=>$default_name, 'image'=>$default_image, 'post_id'=>0];

        $user_query = new WP_Query([
            'post_type'  => 'user-mobile',
            'meta_query' => [[
                'key'     => 'id',
                'value'   => $acf_user_id,
                'compare' => '='
            ]],
            'posts_per_page' => 1
        ]);

        $user_name  = $default_name;
        $user_image = $default_image;
        $user_post_id = 0;

        if ($user_query->have_posts()) {
            $user_post = $user_query->posts[0];
            $user_post_id = $user_post->ID;
            $user_name = get_field('name', $user_post->ID) ?: $acf_user_id;
            $img = get_field('user_image', $user_post->ID);
            $user_image = !empty($img) ? $img : $default_image;
            if (empty($img)) update_field('user_image', $default_image, $user_post->ID);
        }
        wp_reset_postdata();
        return ['name'=>$user_name, 'image'=>$user_image, 'post_id'=>$user_post_id];
    };

    // üöÄ Ki·ªÉm tra cache cho ph·∫ßn data ch√≠nh
    if ($cached_data !== false) {
        $week_data = $cached_data['week_data'];
        $game_title = $cached_data['game_title'];
    } else {
        // üìä L·∫•y danh s√°ch top tu·∫ßn (ch·ªâ khi kh√¥ng c√≥ cache)
        $week_data_raw = $wpdb->get_results($wpdb->prepare("
            SELECT 
                MAX(p.ID) AS ID,
                um.meta_value AS user_id,
                MAX(CAST(sm.meta_value AS UNSIGNED)) AS score
            FROM {$wpdb->posts} p
            LEFT JOIN {$table} um ON p.ID = um.post_id AND um.meta_key = 'user_id'
            LEFT JOIN {$table} sm ON p.ID = sm.post_id AND sm.meta_key = 'score'
            LEFT JOIN {$table} gm ON p.ID = gm.post_id AND gm.meta_key = 'game_id'
            WHERE p.post_type = 'top-game-online'
              AND gm.meta_value = %s
              AND p.post_date BETWEEN %s AND %s
            GROUP BY um.meta_value
            ORDER BY score DESC
            LIMIT %d
        ", $game, $start, $end, $limit));

        // üïπÔ∏è T√™n game
        $game_post  = get_post($game);
        $game_title = ($game_post && $game_post->post_type === 'embed_post') ? $game_post->post_title : '';

        // üß† G·∫Øn th√¥ng tin user + ti·ªÅn th∆∞·ªüng
        $week_data = [];
        $rank = 1;
        foreach ($week_data_raw as $row) {
            $acf_user_id = $row->user_id;
            $money = $money_by_top[$rank] ?? $default_money;
            $info = $get_user_info($acf_user_id);


            $week_data[] = [
                'id'        => $row->ID,
                'user_id'   => $acf_user_id,
                'user_name' => $info['name'],
                'money'     => $money,
                'avatar'    => $info['image'],
                'score'     => (int)$row->score,
                'game_name' => $game_title,
                'time'      => get_post_field('post_date', $row->ID),
                'top'       => $rank++
            ];
        }

        // üíæ L∆∞u cache cho 30 ph√∫t
        set_transient($cache_key, [
            'week_data' => $week_data,
            'game_title' => $game_title
        ], 1800);
    }

    // üîç Top ri√™ng cho user c·ª• th·ªÉ (LU√îN L·∫§Y FRESH - KH√îNG CACHE)
    $user_result = [
        'id'        => 0,
        'user_id'   => '',
        'user_name' => 'Anonymous',
        'money'     => $default_money,
        'avatar'    => 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg',
        'score'     => 0,
        'game_name' => $game_title,
        'top'       => null
    ];

    if (!empty($user_id)) {
        $user_row = $wpdb->get_row($wpdb->prepare("
            SELECT ranked.* FROM (
                SELECT 
                    MAX(p.ID) AS ID,
                    um.meta_value AS user_id,
                    MAX(CAST(sm.meta_value AS UNSIGNED)) AS score,
                    RANK() OVER (ORDER BY MAX(CAST(sm.meta_value AS UNSIGNED)) DESC) AS rank_position
                FROM {$wpdb->posts} p
                LEFT JOIN {$table} um ON p.ID = um.post_id AND um.meta_key = 'user_id'
                LEFT JOIN {$table} sm ON p.ID = sm.post_id AND sm.meta_key = 'score'
                LEFT JOIN {$table} gm ON p.ID = gm.post_id AND gm.meta_key = 'game_id'
                WHERE p.post_type = 'top-game-online'
                  AND gm.meta_value = %s
                  AND p.post_date BETWEEN %s AND %s
                GROUP BY um.meta_value
            ) AS ranked
            WHERE ranked.user_id = %s
            LIMIT 1
        ", $game, $start, $end, $user_id));

        $info = $get_user_info($user_id);
        $user_result['user_name'] = $info['name'];
        $user_result['avatar']    = $info['image'];

        if ($user_row) {
            $user_result['id']      = $user_row->ID;
            $user_result['user_id'] = $user_row->user_id;
            $user_result['score']   = (int)$user_row->score;
            $user_result['top']     = (int)$user_row->rank_position;
            $user_result['money']   = $money_by_top[$user_result['top']] ?? $default_money;
        }
    }

    // ‚úÖ K·∫øt qu·∫£
    return [
        'name_games' => $game_title,
        'limit'      => $limit,
        'data'       => $week_data,
        'user'       => $user_result,
    ];
}


function get_top_game_month($request) {
    global $wpdb;
    $table = $wpdb->prefix . 'postmeta';

    $game    = 9613;
    $limit   = 200;
    $user_id = sanitize_text_field($request->get_param('user_id'));

    $current = current_time('timestamp');
    $minute  = floor(date('i', $current) / 30) * 30;

    $month = date('m', $current);
    $year  = date('Y', $current);

    if ($month == 11 && $year == 2025) {
        // üóìÔ∏è N·∫øu l√† th√°ng 11/2025 ‚Üí t√≠nh c·∫£ th√°ng 10 (t·ª©c t·ª´ ƒë·∫ßu th√°ng 10 ƒë·∫øn ƒë·∫ßu th√°ng 12)
        $start = date('Y-m-01 00:00:00', strtotime('-1 month', $current));
        $end   = date('Y-m-01 H:' . str_pad($minute, 2, '0', STR_PAD_LEFT) . ':00', strtotime('+1 month', $current));
    } else {
        // üóìÔ∏è C√°c th√°ng kh√°c ‚Üí ch·ªâ t√≠nh trong th√°ng hi·ªán t·∫°i
        $start = date('Y-m-01 00:00:00', $current);
        $end   = date('Y-m-01 H:' . str_pad($minute, 2, '0', STR_PAD_LEFT) . ':00', strtotime('+1 month', $current));
    }



    // üîë Cache key (theo t·ª´ng n·ª≠a gi·ªù)
    $cache_key = 'top_game_month_' . $game . '_' . date('Y_m', strtotime($start)) . '_' . $minute;
    $cached = get_transient($cache_key);

    if ($cached !== false) {
        $month_data = $cached['month_data'];
        $game_title = $cached['game_title'];
    } else {
        // üí∞ B·∫£ng th∆∞·ªüng
        $money_by_top = [
    1=>1000,2=>900,3=>800,4=>750,5=>700,
    6=>650,7=>600,8=>580,9=>560,10=>540,
    11=>520,12=>500,13=>490,14=>480,15=>470,
    16=>460,17=>450,18=>440,19=>430,20=>420,
    21=>410,22=>400,23=>395,24=>390,25=>385,
    26=>380,27=>375,28=>370,29=>365,30=>360,
    31=>355,32=>350,33=>345,34=>340,35=>335,
    36=>330,37=>325,38=>320,39=>315,40=>310,
    41=>305,42=>300,43=>295,44=>290,45=>285,
    46=>280,47=>275,48=>270,49=>265,50=>260,
    51=>255,52=>250,53=>245,54=>240,55=>235,
    56=>230,57=>225,58=>220,59=>215,60=>210,
    61=>205,62=>200,63=>195,64=>190,65=>185,
    66=>180,67=>175,68=>170,69=>165,70=>160,
    71=>155,72=>150,73=>145,74=>140,75=>135,
    76=>130,77=>125,78=>120,79=>115,80=>110,
    81=>105,82=>100,83=>95,84=>90,85=>85,
    86=>80,87=>75,88=>70,89=>65,90=>60,
    91=>55,92=>50,93=>45,94=>40,95=>35,
    96=>30,97=>25,98=>20,99=>15,100=>10,

    // 101‚Äì149 = 10
    101=>10,102=>10,103=>10,104=>10,105=>10,
    106=>10,107=>10,108=>10,109=>10,110=>10,
    111=>10,112=>10,113=>10,114=>10,115=>10,
    116=>10,117=>10,118=>10,119=>10,120=>10,
    121=>10,122=>10,123=>10,124=>10,125=>10,
    126=>10,127=>10,128=>10,129=>10,130=>10,
    131=>10,132=>10,133=>10,134=>10,135=>10,
    136=>10,137=>10,138=>10,139=>10,140=>10,
    141=>10,142=>10,143=>10,144=>10,145=>10,
    146=>10,147=>10,148=>10,149=>10,

    // 150‚Äì200 = 5
    150=>5,151=>5,152=>5,153=>5,154=>5,
    155=>5,156=>5,157=>5,158=>5,159=>5,
    160=>5,161=>5,162=>5,163=>5,164=>5,
    165=>5,166=>5,167=>5,168=>5,169=>5,
    170=>5,171=>5,172=>5,173=>5,174=>5,
    175=>5,176=>5,177=>5,178=>5,179=>5,
    180=>5,181=>5,182=>5,183=>5,184=>5,
    185=>5,186=>5,187=>5,188=>5,189=>5,
    190=>5,191=>5,192=>5,193=>5,194=>5,
    195=>5,196=>5,197=>5,198=>5,199=>5,
    200=>5,
];


        // üéÆ L·∫•y t√™n game
        $game_post = get_post($game);
        $game_title = ($game_post && $game_post->post_type === 'embed_post') ? $game_post->post_title : '';

        // üìä Query ch√≠nh (ƒë√£ t·ªëi ∆∞u)
        $sql = $wpdb->prepare("
            SELECT 
                uid.meta_value AS user_id,
                MAX(CAST(scr.meta_value AS UNSIGNED)) AS score,
                MAX(p.ID) AS post_id
            FROM {$wpdb->posts} p
            INNER JOIN {$table} gid ON gid.post_id = p.ID 
                AND gid.meta_key = 'game_id' AND gid.meta_value = %s
            INNER JOIN {$table} uid ON uid.post_id = p.ID 
                AND uid.meta_key = 'user_id'
            INNER JOIN {$table} scr ON scr.post_id = p.ID 
                AND scr.meta_key = 'score'
            WHERE p.post_type = 'top-game-online'
              AND p.post_date BETWEEN %s AND %s
            GROUP BY uid.meta_value
            ORDER BY score DESC
            LIMIT %d
        ", $game, $start, $end, $limit);

        $rows = $wpdb->get_results($sql);

        // ‚ö° Cache t·∫°m user info trong v√≤ng l·∫∑p
        static $user_cache = [];
        $month_data = [];
        $rank = 1;

        foreach ($rows as $row) {
            $acf_user_id = $row->user_id;

            if (!isset($user_cache[$acf_user_id])) {
                $user_post = $wpdb->get_row($wpdb->prepare("
                    SELECT p.ID 
                    FROM {$wpdb->posts} p
                    INNER JOIN {$table} m ON m.post_id = p.ID AND m.meta_key = 'id'
                    WHERE p.post_type = 'user-mobile' AND m.meta_value = %s
                    LIMIT 1
                ", $acf_user_id));

                if ($user_post) {
                    $user_name  = get_field('name', $user_post->ID) ?: $acf_user_id;
                    $user_image = get_field('user_image', $user_post->ID) ?: 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';
                    if (empty($user_image)) update_field('user_image', 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg', $user_post->ID);
                    $user_cache[$acf_user_id] = [
                        'id'    => $user_post->ID,
                        'name'  => $user_name,
                        'image' => $user_image,
                    ];
                } else {
                    $user_cache[$acf_user_id] = [
                        'id'    => 0,
                        'name'  => 'Anonymous',
                        'image' => 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg',
                    ];
                }
            }

            $info = $user_cache[$acf_user_id];
            $money = $money_by_top[$rank] ?? 0;

            $month_data[] = [
                'id'        => $row->post_id,
                'user_id'   => $acf_user_id,
                'user_name' => $info['name'],
                'money'     => $money,
                'avatar'    => $info['image'],
                'score'     => (int)$row->score,
                'game_name' => $game_title,
                'time'      => get_post_field('post_date', $row->post_id),
                'top'       => $rank++
            ];
        }

        // üíæ L∆∞u cache 30 ph√∫t
        set_transient($cache_key, [
            'month_data' => $month_data,
            'game_title' => $game_title
        ], 1800);
    }

    // üë§ User c·ª• th·ªÉ (kh√¥ng cache ‚Äî l·∫•y realtime)
    $user_result = [
        'id'        => 0,
        'user_id'   => $user_id,
        'user_name' => 'Anonymous',
        'money'     => 0,
        'avatar'    => 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg',
        'score'     => 0,
        'game_name' => $game_title,
        'top'       => null
    ];

    if ($user_id) {
        $found = null;
        foreach ($month_data as $row) {
            if ($row['user_id'] == $user_id) {
                $found = $row;
                break;
            }
        }

        if ($found) {
            $user_result = $found;
        } else {
            // Kh√¥ng c√≥ trong top ‚Üí l·∫•y ƒëi·ªÉm realtime
            $sql_user = $wpdb->prepare("
                SELECT MAX(CAST(sm.meta_value AS UNSIGNED)) AS score
                FROM {$wpdb->posts} p
                INNER JOIN {$table} gm ON gm.post_id = p.ID 
                    AND gm.meta_key = 'game_id' AND gm.meta_value = %s
                INNER JOIN {$table} um ON um.post_id = p.ID 
                    AND um.meta_key = 'user_id' AND um.meta_value = %s
                INNER JOIN {$table} sm ON sm.post_id = p.ID 
                    AND sm.meta_key = 'score'
                WHERE p.post_type = 'top-game-online'
                  AND p.post_date BETWEEN %s AND %s
                LIMIT 1
            ", $game, $user_id, $start, $end);

            $user_row = $wpdb->get_row($sql_user);
            if ($user_row) {
                $user_result['score'] = (int)$user_row->score;
                $user_result['user_name'] = 'Anonymous';
                $user_result['avatar'] = 'https://apkmodjoy.com/wp-content/uploads/2025/09/20250927-105023.jpg';
            }
        }
    }

    return [
        'name_games' => $game_title,
        'limit'      => $limit,
        'data'       => $month_data,
        'user'       => $user_result
    ];
}




add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/top-game/week', array(
        'methods'  => 'GET',
        'callback' => 'get_top_game_week',
    ));

    register_rest_route('custom-api/v1', '/top-game/month', array(
        'methods'  => 'GET',
        'callback' => 'get_top_game_month',
    ));

});




add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/check-status', [
        'methods' => 'GET',
        'callback' => 'wnc_check_status',
        'permission_callback' => '__return_true', // Cho ph√©p public
    ]);
});

function wnc_check_status($request) {

    $status_week = false; 

    $status_full = true;


        return wp_send_json_success([
            'status_week'   => $status_week,
            'status_full' => $status_full,

        ]);
}



add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/user-mobile/add', array(
        'methods'  => 'GET',
        'callback' => 'create_user_mobile_by_get',
    ));
});

function get_real_ip_address() {
    if (!empty($_SERVER['HTTP_CF_CONNECTING_IP'])) {
        return $_SERVER['HTTP_CF_CONNECTING_IP']; // Cloudflare
    } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        $ips = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);
        return trim($ips[0]);
    } elseif (!empty($_SERVER['HTTP_CLIENT_IP'])) {
        return $_SERVER['HTTP_CLIENT_IP'];
    }
    return $_SERVER['REMOTE_ADDR'] ?? 'unknown';
}

function create_user_mobile_by_get(WP_REST_Request $request) {
    $acf_id   = sanitize_text_field($request->get_param('id'));
    $acf_name = sanitize_text_field($request->get_param('name'));
    $user_ip  = get_real_ip_address(); // üåê L·∫•y IP th·ª±c t·∫ø c·ªßa client

    // ‚ö†Ô∏è Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
    if (empty($acf_id) || empty($acf_name)) {
        return array('status' => 'error', 'message' => 'Missing id or name');
    }

    // ‚úÇÔ∏è Gi·ªõi h·∫°n ƒë·ªô d√†i t√™n t·ªëi ƒëa 50 k√Ω t·ª±
    if (strlen($acf_name) > 50) {
        $acf_name = mb_substr($acf_name, 0, 50);
    }

    // üîé Ki·ªÉm tra xem user ƒë√£ t·ªìn t·∫°i ch∆∞a
    $existing_user = new WP_Query(array(
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => array(array(
            'key'     => 'id',
            'value'   => $acf_id,
            'compare' => '='
        ))
    ));

    if ($existing_user->have_posts()) {
        // ‚úèÔ∏è N·∫øu t·ªìn t·∫°i: update l·∫°i name + IP
        $post_id = $existing_user->posts[0]->ID;
        update_field('name', $acf_name, $post_id);
        update_field('user_ip', $user_ip, $post_id);

        return array(
            'status'  => 'updated',
            'id'      => $acf_id,
            'name'    => $acf_name,
            'ip'      => $user_ip,
            'post_id' => $post_id,
            'message' => '‚úÖ User existed ‚Äî name and IP updated successfully'
        );
    } else {
        // üÜï N·∫øu ch∆∞a t·ªìn t·∫°i: t·∫°o m·ªõi post
        $post_id = wp_insert_post(array(
            'post_title'  => $acf_name,
            'post_type'   => 'user-mobile',
            'post_status' => 'publish',
        ));

        if (is_wp_error($post_id)) {
            return array('status' => 'error', 'message' => '‚ùå Cannot create post');
        }

        update_field('id', $acf_id, $post_id);
        update_field('name', $acf_name, $post_id);
        update_field('user_ip', $user_ip, $post_id);

        return array(
            'status'  => 'created',
            'id'      => $acf_id,
            'name'    => $acf_name,
            'ip'      => $user_ip,
            'post_id' => $post_id,
            'message' => 'üÜï New user-mobile created successfully with IP'
        );
    }
}



add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/list-images', [
        'methods'  => 'GET',
        'callback' => 'get_list_images',
        'permission_callback' => '__return_true',
    ]);
});

function get_list_images(WP_REST_Request $request) {
    // üñºÔ∏è T·ª± ƒëi·ªÅn danh s√°ch ·∫£nh c·ªßa b·∫°n ·ªü ƒë√¢y
$images = [
    'https://apkmodjoy.com/wp-content/uploads/2025/10/guard_square.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/guard_triangle.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/guard_circle.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-153357.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-153354.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-153351.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-153347.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155030.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155033.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155037.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155041.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155044.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155048.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155053.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155056.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155059.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155102.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155105.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155108.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155111.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155115.jpg',
    'https://apkmodjoy.com/wp-content/uploads/2025/10/20251014-155118.jpg',
];



    return new WP_REST_Response([
        'success' => true,
        'mode'    => 'list',
        'total'   => count($images),
        'data'    => $images
    ], 200);
}
// üïí ƒê·ªãnh nghƒ©a l·ªãch 30 gi√¢y
add_filter('cron_schedules', function ($schedules) {
    $schedules['every_30s'] = [
        'interval' => 30, // 30 gi√¢y
        'display'  => __('Every 30 seconds')
    ];
    return $schedules;
});

// üöÄ T·∫°o cron n·∫øu ch∆∞a c√≥
add_action('init', function () {
    if (!wp_next_scheduled('top_game_month_preload_event')) {
        wp_schedule_event(time(), 'every_30s', 'top_game_month_preload_event');
    }
});
// üî• H√†nh ƒë·ªông khi cron ch·∫°y
add_action('top_game_month_preload_event', function () {
    // G·ªçi API th√°ng
    $api_month = home_url('/wp-json/custom-api/v1/top-game/month');
    $response_month = wp_remote_get($api_month, [
        'timeout' => 10,
        'sslverify' => false
    ]);

    if (is_wp_error($response_month)) {
        error_log('[TopGameMonth] ‚ùå API preload (month) failed: ' . $response_month->get_error_message());
    } else {
        error_log('[TopGameMonth] ‚úÖ Month cache refreshed at ' . date('H:i:s'));
    }

    // G·ªçi API tu·∫ßn
    $api_week = home_url('/wp-json/custom-api/v1/top-game/week');
    $response_week = wp_remote_get($api_week, [
        'timeout' => 10,
        'sslverify' => false
    ]);

    if (is_wp_error($response_week)) {
        error_log('[TopGameWeek] ‚ùå API preload (week) failed: ' . $response_week->get_error_message());
    } else {
        error_log('[TopGameWeek] ‚úÖ Week cache refreshed at ' . date('H:i:s'));
    }
});

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/check-user-payment-info', [
        'methods'  => 'GET',
        'callback' => 'check_user_payment_info',
        'permission_callback' => '__return_true',
    ]);
});
function check_user_payment_info(WP_REST_Request $request) {

    $user_id = sanitize_text_field($request->get_param('user_id'));

    if (!$user_id) {
        return new WP_REST_Response([
            'status'  => 'error',
            'message' => 'Missing user_id'
        ], 400);
    }

    // =============================
    // üîπ FIND USER
    // =============================
    $user_query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$user_query->have_posts()) {
        return new WP_REST_Response([
            'status'  => 'error',
            'message' => 'User not found'
        ], 404);
    }

    $post_id = $user_query->posts[0]->ID;

    // =============================
    // üîπ LANGUAGE
    // =============================
    $lang_meta = get_post_meta($post_id, 'language', true);
    $user_lang = !empty($lang_meta) ? $lang_meta : 'en';

    // =============================
    // üîπ MONEY (USD G·ªêC ‚Äì GI·ªÆ LOGIC)
    // =============================
    $money_diem_danh_raw = get_post_meta($post_id, 'money_diem_danh', true);
    $money_diem_danh_usd = is_array($money_diem_danh_raw) ? 0 : (float) ($money_diem_danh_raw ?: 0);

    // total_money v·∫´n = money_diem_danh
    $total_money_usd = $money_diem_danh_usd;

    // =============================
    // üîπ PAYMENT STATUS
    // =============================
    $payment_status = get_post_meta($post_id, 'payment_status', true);
    // expected: pending | paid | ""

    // =============================
    // üîπ T·ª∂ GI√Å (CH·ªà NH√ÇN ‚Äì KH√îNG ƒê·ªîI LOGIC)
    // =============================
    $USD_TO_VND = 20000;
    $USD_TO_IDR = 15000;

    if ($user_lang === 'vi') {
        $money_diem_danh = $money_diem_danh_usd * $USD_TO_VND;
        $total_money     = $total_money_usd * $USD_TO_VND;
    } elseif ($user_lang === 'id') {
        $money_diem_danh = $money_diem_danh_usd * $USD_TO_IDR;
        $total_money     = $total_money_usd * $USD_TO_IDR;
    } else {
        // en ‚Üí gi·ªØ USD
        $money_diem_danh = $money_diem_danh_usd;
        $total_money     = $total_money_usd;
    }

    // =============================
    // üî• LOGIC CU·ªêI (GI·ªÆ NGUY√äN)
    // =============================
    $show_prompt = !($total_money > 0 && $payment_status === 'pending');

    // =============================
    // üîπ RESPONSE
    // =============================
    return new WP_REST_Response([
        'status'          => 'success',
        'user_id'         => $user_id,
        'money_diem_danh' => $money_diem_danh,
        'total_money'     => $total_money,
        'payment_status'  => $payment_status,
        'show_prompt'     => $show_prompt,
        'language'        => $user_lang
    ], 200);
}



/* ===========================================================
   1) POST TYPE user_game_status  (COUNTDOWN theo t·ª´ng game)
=========================================================== */
add_action('init', function () {
    register_post_type('user_game_status', [
        'label' => 'User Game Status',
        'public' => false,
        'show_ui' => true,
        'menu_icon' => 'dashicons-controls-repeat',
        'supports' => ['title'],
    ]);
});

/* ===========================================================
   2) GET / CREATE RECORD COUNTDOWN (user + game)
=========================================================== */
function get_user_game_status($user_id, $game_id) {

    $query = new WP_Query([
        'post_type' => 'user_game_status',
        'posts_per_page' => 1,
        'meta_query' => [
            ['key' => 'user_id', 'value' => $user_id],
            ['key' => 'game_id', 'value' => $game_id]
        ]
    ]);

    if ($query->have_posts()) {
        $query->the_post();
        return get_the_ID();
    }

    // T·∫°o m·ªõi n·∫øu ch∆∞a c√≥
    $post_id = wp_insert_post([
        'post_type' => 'user_game_status',
        'post_title' => "User {$user_id} - Game {$game_id}",
        'post_status' => 'publish'
    ]);

    update_post_meta($post_id, 'user_id', $user_id);
    update_post_meta($post_id, 'game_id', $game_id);
    update_post_meta($post_id, 'count_value', 1800);
    update_post_meta($post_id, 'last_play_date', '');

    return $post_id;
}


/* ===========================================================
   3) GET COUNTDOWN  (kh√¥ng reset)
=========================================================== */
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/countdown', [
        'methods' => 'GET',
        'callback' => 'api_get_countdown',
        'permission_callback' => '__return_true',
    ]);
});

function api_get_countdown(WP_REST_Request $req) {

    $user_id = $req->get_param('user_id');
    $game_id = $req->get_param('game_id');

    if (!$user_id || !$game_id)
        return ['status' => 'error', 'message' => 'Missing parameters'];

    $post_id = get_user_game_status($user_id, $game_id);

    $today     = current_time('Y-m-d');
    $last_play = get_post_meta($post_id, 'last_play_date', true);
    $value     = intval(get_post_meta($post_id, 'count_value', true));

    // ‚≠ê N·∫øu sang ng√†y m·ªõi ‚Üí reset countdown v·ªÅ 1 gi√¢y
    if ($last_play !== $today) {
        $value = 1800; // ho·∫∑c 1800 n·∫øu b·∫°n mu·ªën
        update_post_meta($post_id, 'count_value', $value);
        update_post_meta($post_id, 'last_play_date', $today);
    }

    // ki·ªÉm tra check-in theo user
    $checked = get_post_meta($user_id, 'checkin_date', true);

    return [
        'status'      => 'success',
        'remaining'   => $value,
        'minute'      => floor($value / 60),
        'second'      => $value % 60,
        'can_checkin' => ($value <= 0 && $checked !== $today)
    ];
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/send-count', [
        'methods'  => 'GET',
        'callback' => 'api_send_count',
        'permission_callback' => '__return_true',
    ]);
});
function api_send_count(WP_REST_Request $req) {


    // ‚òÖ reduce_value do client g·ª≠i l√™n, m·∫∑c ƒë·ªãnh = 1800
    $reduce_value = intval($req->get_param('reduce_value'));
    if ($reduce_value <= 0) {
        $reduce_value = 1; 
    }

    $user_id = isset($_GET['user_id']) ? intval($_GET['user_id']) : 0;
    $game_id = isset($_GET['game_id']) ? intval($_GET['game_id']) : 9613;

    if (!$user_id) {
        return [
            'status' => 'error',
            'message' => 'Missing user_id'
        ];
    }

    // L·∫•y ho·∫∑c t·∫°o record
    $post_id = get_user_game_status($user_id, $game_id);

    $today       = current_time('Y-m-d');
    $last_play   = get_post_meta($post_id, 'last_play_date', true);
    $count_value = intval(get_post_meta($post_id, 'count_value', true));

    // RESET m·ªói ng√†y ‚Üí reset v·ªÅ 1800
    if ($last_play !== $today) {
        $count_value = 1800;
    }

    // N·∫øu h·∫øt ‚Üí kh√¥ng gi·∫£m n·ªØa
    if ($count_value <= 0) {

        update_post_meta($post_id, 'last_play_date', $today);

        return [
            'status'      => 'success',
            'remaining'   => 0,
            'can_checkin' => true
        ];
    }

    // gi·∫£m theo reduce_value
    $count_value -= $reduce_value;
    if ($count_value < 0) $count_value = 0;

    // l∆∞u d·ªØ li·ªáu
    update_post_meta($post_id, 'count_value', $count_value);
    update_post_meta($post_id, 'last_play_date', $today);

    return [
        'status'      => 'success',
        'remaining'   => $count_value,
        'reduce_by'   => $reduce_value, 
        'can_checkin' => ($count_value <= 0)
    ];
}



add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/checkin-history', [
        'methods'  => 'GET',
        'callback' => 'api_checkin_history_user_only',
        'permission_callback' => '__return_true',
    ]);
});

function api_checkin_history_user_only(WP_REST_Request $req) {

    $external_id = sanitize_text_field($req->get_param('user_id'));

    if (!$external_id) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing user_id'
        ], 400);
    }

    $query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'   => 'id',
                'value' => $external_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $user_post_id = $query->posts[0]->ID;

    $history = get_post_meta($user_post_id, 'checkin_history', true);
    $history = $history ? json_decode($history, true) : [];
    sort($history);

    return new WP_REST_Response([
        'success'         => true,
        'user_id'         => $external_id,
        'post_id'         => $user_post_id,
        'total_checkins'  => count($history),
        'checkin_history' => $history
    ], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/remove-checkin-today', [
        'methods'  => 'GET',
        'callback' => 'api_remove_checkin_today',
        'permission_callback' => '__return_true',
    ]);
});

function api_remove_checkin_today(WP_REST_Request $req) {

    $external_id = sanitize_text_field($req->get_param('user_id'));

    if (!$external_id) {
        return [
            'status'  => 'error',
            'message' => 'Missing user_id'
        ];
    }

    // 1) T√¨m user-mobile
    $query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $external_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$query->have_posts()) {
        return [
            'status'  => 'error',
            'message' => 'User not found'
        ];
    }

    $user_post_id = $query->posts[0]->ID;

    // H√¥m nay
    $today = current_time('Y-m-d');

    /* ---------------------------------------------------------
        2) L·∫•y l·ªãch s·ª≠ check-in
    --------------------------------------------------------- */
    $history = get_post_meta($user_post_id, 'checkin_history', true);
    $history = $history ? json_decode($history, true) : [];

    // N·∫øu h√¥m nay KH√îNG c√≥ trong l·ªãch s·ª≠ ‚áí Kh√¥ng l√†m g√¨
    if (!in_array($today, $history)) {
        return [
            'status'  => 'error',
            'message' => 'Today not in history, nothing to remove',
            'history' => $history
        ];
    }

    /* ---------------------------------------------------------
        3) X√°c ƒë·ªãnh v·ªã tr√≠ h√¥m nay trong chu k·ª≥ 1‚Äì30
    --------------------------------------------------------- */
    $index = array_search($today, $history);  
    $checkin_number = $index + 1; // +1 v√¨ index = 0 => l·∫ßn 1

    /* ---------------------------------------------------------
        4) T√≠nh s·ªë ti·ªÅn c·∫ßn TR·ª™ theo s·ªë l·∫ßn check-in
    --------------------------------------------------------- */
    if ($checkin_number <= 10) $remove_value = 1;
    elseif ($checkin_number <= 20) $remove_value = 2;
    elseif ($checkin_number <= 25) $remove_value = 3;
    else $remove_value = 5;

    /* ---------------------------------------------------------
        5) X√≥a checkin_date meta n·∫øu tr√πng h√¥m nay
    --------------------------------------------------------- */
    $current = get_post_meta($user_post_id, 'checkin_date', true);
    if ($current === $today) {
        delete_post_meta($user_post_id, 'checkin_date');
    }

    /* ---------------------------------------------------------
        6) X√≥a h√¥m nay kh·ªèi checkin_history
    --------------------------------------------------------- */
    $history = array_filter($history, function($day) use ($today) {
        return $day !== $today;
    });

    $history = array_values($history);
    update_post_meta($user_post_id, 'checkin_history', json_encode($history));

    /* ---------------------------------------------------------
        7) TR·ª™ TI·ªÄN trong money_diem_danh
    --------------------------------------------------------- */
    $current_money = floatval(get_post_meta($user_post_id, 'money_diem_danh', true));

    $new_money = max(0, $current_money - $remove_value);
    update_post_meta($user_post_id, 'money_diem_danh', $new_money);

    /* ---------------------------------------------------------
        8) Tr·∫£ k·∫øt qu·∫£
    --------------------------------------------------------- */
    return [
        'status'         => 'success',
        'message'        => 'Removed today check-in & deducted money',
        'removed_date'   => $today,
        'deduct_value'   => $remove_value,
        'money_after'    => $new_money,
        'total_checkins' => count($history),
        'history'        => $history
    ];
}


/* ===========================================================
   ADMIN COLUMNS for user_game_status (Countdown per game)
=========================================================== */

add_filter('manage_user_game_status_posts_columns', function ($columns) {
    $new = [];

    $new['cb'] = $columns['cb'];
    $new['title'] = __('Record', 'textdomain');

    // C·ªôt c·∫ßn thi·∫øt
    $new['user_id'] = __('User ID', 'textdomain');
    $new['game_id'] = __('Game ID', 'textdomain');
    $new['count_value'] = __('Countdown', 'textdomain');
    $new['last_play'] = __('Last Play Date', 'textdomain');

    return $new;
});

/* Hi·ªÉn th·ªã d·ªØ li·ªáu cho t·ª´ng c·ªôt */
add_action('manage_user_game_status_posts_custom_column', function ($column, $post_id) {

    switch ($column) {

        case 'user_id':
            echo esc_html(get_post_meta($post_id, 'user_id', true));
            break;

        case 'game_id':
            echo esc_html(get_post_meta($post_id, 'game_id', true));
            break;

        case 'count_value':
            $val = intval(get_post_meta($post_id, 'count_value', true));
            echo $val . "s (" . floor($val/60) . "m)";
            break;

        case 'last_play':
            $last = get_post_meta($post_id, 'last_play_date', true);
            echo $last ? $last : "<i>Never</i>";
            break;
    }
}, 10, 2);


/* Cho ph√©p sort b·∫£ng */
add_filter('manage_edit-user_game_status_sortable_columns', function ($columns) {
    $columns['user_id'] = 'user_id';
    $columns['game_id'] = 'game_id';
    $columns['count_value'] = 'count_value';
    return $columns;
});


/* ===========================================================
   ADMIN META BOX (DETAIL VIEW)
=========================================================== */

add_action('add_meta_boxes', function () {
    add_meta_box(
        'user_game_status_box',
        __('User Game Status Details', 'textdomain'),
        'render_user_game_status_box',
        'user_game_status',
        'normal',
        'high'
    );
});

function render_user_game_status_box($post) {

    $user_id = get_post_meta($post->ID, 'user_id', true);
    $game_id = get_post_meta($post->ID, 'game_id', true);
    $count_value = get_post_meta($post->ID, 'count_value', true);
    $last_play = get_post_meta($post->ID, 'last_play_date', true);
    ?>

    <table class="form-table">

        <tr>
            <th>User ID</th>
            <td><input type="text" name="user_id" value="<?= esc_attr($user_id) ?>" class="regular-text"></td>
        </tr>

        <tr>
            <th>Game ID</th>
            <td><input type="text" name="game_id" value="<?= esc_attr($game_id) ?>" class="regular-text"></td>
        </tr>

        <tr>
            <th>Countdown (seconds)</th>
            <td><input type="number" name="count_value" value="<?= esc_attr($count_value) ?>" min="0"></td>
        </tr>

        <tr>
            <th>Last Play Date</th>
            <td><input type="text" name="last_play_date" value="<?= esc_attr($last_play) ?>" placeholder="YYYY-MM-DD"></td>
        </tr>

    </table>

    <?php
}

add_action('save_post_user_game_status', function ($post_id) {

    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;

    if (isset($_POST['user_id']))
        update_post_meta($post_id, 'user_id', sanitize_text_field($_POST['user_id']));

    if (isset($_POST['game_id']))
        update_post_meta($post_id, 'game_id', sanitize_text_field($_POST['game_id']));

    if (isset($_POST['count_value']))
        update_post_meta($post_id, 'count_value', intval($_POST['count_value']));

    if (isset($_POST['last_play_date']))
        update_post_meta($post_id, 'last_play_date', sanitize_text_field($_POST['last_play_date']));

});




add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/update-beneficiary-info', [
        'methods' => 'GET',
        'callback' => 'api_update_beneficiary_full',
        'permission_callback' => '__return_true',
    ]);
});

function api_update_beneficiary_full(WP_REST_Request $request) {

    $user_id = sanitize_text_field($request->get_param('user_id')); 

    if (empty($user_id)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing user_id',
        ], 400);
    }

    // ================================
    // üîç 1. FIND USER BY ACF id
    // ================================
    $user_query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$user_query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $user_post_id = $user_query->posts[0]->ID;

    // ================================
    // üîç 2. GET USER LANGUAGE
    // ================================
    $lang = get_post_meta($user_post_id, 'language', true);
    if (empty($lang)) {
        $lang = get_post_meta($user_post_id, 'lang', true);
    }
    $lang = strtolower(trim($lang)) ?: 'en';

    // ================================
    // üåç 3. MULTI-LANGUAGE MESSAGES
    // ================================
    $msg = [
        'en' => 'Beneficiary information updated successfully',
        'vi' => 'C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi nh·∫≠n tr·ª£ c·∫•p th√†nh c√¥ng',
        'id' => 'Informasi penerima berhasil diperbarui',
        'es' => 'Informaci√≥n del beneficiario actualizada correctamente'
    ];

    $message_text = $msg[$lang] ?? $msg['en'];

    // ================================
    // üî∂ 4. SAVE ALL BENEFICIARY INFO
    // ================================

    // Receiver
    update_post_meta($user_post_id, 'receiver_name', sanitize_text_field($request->get_param('receiver_name')));
    update_post_meta($user_post_id, 'receiver_country', sanitize_text_field($request->get_param('receiver_country')));
    update_post_meta($user_post_id, 'currency', sanitize_text_field($request->get_param('currency')));

    // Bank info (PRIMARY)
    update_post_meta($user_post_id, 'bank_name', sanitize_text_field($request->get_param('bank_name'))); // üî• NEW FIELD
    update_post_meta($user_post_id, 'swift_code', sanitize_text_field($request->get_param('swift_code')));
    update_post_meta($user_post_id, 'bank_branch', sanitize_text_field($request->get_param('bank_branch')));
    update_post_meta($user_post_id, 'bank_code', sanitize_text_field($request->get_param('bank_code')));

    // Beneficiary
    update_post_meta($user_post_id, 'iban', sanitize_text_field($request->get_param('iban')));
    update_post_meta($user_post_id, 'beneficiary_name', sanitize_text_field($request->get_param('beneficiary_name')));
    update_post_meta($user_post_id, 'beneficiary_address', sanitize_textarea_field($request->get_param('beneficiary_address')));

    // ================================
    // ‚≠ê 5. RESPONSE
    // ================================
    return new WP_REST_Response([
        'success' => true,
        'message' => $message_text,
        'lang'    => $lang,
        'user_id' => $user_id
    ], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/bank-list', [
        'methods'  => 'GET',
        'callback' => 'api_list_indonesia_banks',
        'permission_callback' => '__return_true',
    ]);
});



function api_list_indonesia_banks(WP_REST_Request $request) {

    $banks = [
        "Paypal"
    ];

    return new WP_REST_Response([
        'success' => true,
        'banks'   => $banks
    ], 200);
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/currency-list', [
        'methods'  => 'GET',
        'callback' => 'api_list_currency_simple',
        'permission_callback' => '__return_true',
    ]);
});

function api_list_currency_simple(WP_REST_Request $request) {

    $currencies = [
        "USD ‚Äì United States Dollar",
        "EUR ‚Äì Euro",
        "GBP ‚Äì British Pound",
        "AUD ‚Äì Australian Dollar",
        "CAD ‚Äì Canadian Dollar",
        "SGD ‚Äì Singapore Dollar",
        "JPY ‚Äì Japanese Yen",
        "KRW ‚Äì Korean Won",
        "CNY ‚Äì Chinese Yuan",
        "HKD ‚Äì Hong Kong Dollar",
        "IDR ‚Äì Indonesian Rupiah",
        "VND ‚Äì Vietnamese Dong"
    ];

    return new WP_REST_Response([
        'success'    => true,
        'currencies' => $currencies
    ], 200);
}
add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/country-list', [
        'methods'  => 'GET',
        'callback' => 'api_list_countries_with_flags',
        'permission_callback' => '__return_true',
    ]);
});

function api_list_countries_with_flags(WP_REST_Request $request) {

    $countries = [


        "id" => "Indonesia"
     
    ];

    $result = [];

    foreach ($countries as $code => $name) {
        $result[] = [
            "code" => $code,
            "name" => $name,
            "flag" => "https://flagcdn.com/{$code}.svg"
        ];
    }

    return new WP_REST_Response([
        'success' => true,
        'countries' => $result
    ], 200);
}







add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/checkin-board', [
        'methods'  => 'GET',
        'callback' => 'api_checkin_board',
        'permission_callback' => '__return_true',
    ]);
});

function api_checkin_board(WP_REST_Request $req) {

    $external_id = sanitize_text_field($req->get_param('user_id'));

    if (!$external_id) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing user_id'
        ], 400);
    }

    $query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $external_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $user_post_id = $query->posts[0]->ID;

    // üî• L·∫•y l·ªãch s·ª≠ check-in (d·∫°ng JSON string)
    $history = get_post_meta($user_post_id, 'checkin_history', true);
    $history = $history ? json_decode($history, true) : [];

    // Chuy·ªÉn YYYY-MM-DD -> s·ªë ng√†y trong th√°ng
    $checked_days = [];

    foreach ($history as $date_str) {
        if (preg_match('/^\d{4}-\d{2}-\d{2}$/', $date_str)) {
            $day = intval(date('j', strtotime($date_str)));
            $checked_days[] = $day;
        }
    }

    $checked_days = array_values(array_unique($checked_days));
    sort($checked_days);

    $today = intval(date('j'));
    $board = [];

    for ($day = 1; $day <= 30; $day++) {

        $icon = "x0.5";

        if (in_array($day, $checked_days)) {
            $status  = "checked";
            $checked = true;
        } elseif ($day == $today) {
            $status  = "available";
            $checked = false;
        } elseif ($day < $today) {
            $status  = "available";
            $checked = false;
        } else {
            $status  = "locked";
            $checked = false;
        }

        $board[] = [
            "day"     => $day,
            "checked" => $checked,
            "icon"    => $icon,
            "status"  => $status
        ];
    }

    return new WP_REST_Response([
        'success'       => true,
        'user_id'       => $external_id,
        'post_id'       => $user_post_id,
        'raw_history'   => $history,
        'checked_days'  => $checked_days,
        'checkin_board' => $board
    ], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/checkin-list', [
        'methods'  => 'GET',
        'callback' => 'api_checkin_user_list',
        'permission_callback' => '__return_true',
    ]);
});

function api_checkin_user_list(WP_REST_Request $req) {

    $external_id = sanitize_text_field($req->get_param('user_id'));

    if (!$external_id) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing user_id'
        ], 400);
    }

    // =============================
    // üîπ FIND USER
    // =============================
    $query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'   => 'id',
                'value' => $external_id,
            ]
        ]
    ]);

    if (!$query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $user_post_id = $query->posts[0]->ID;

    // =============================
    // üîπ LANGUAGE
    // =============================
    $lang_meta = get_post_meta($user_post_id, 'language', true);
    $user_lang = !empty($lang_meta) ? $lang_meta : 'en';

    /* ---------------------------------------------------------
        1) L·ªäCH S·ª¨ CHECK-IN (GI·ªÆ LOGIC)
    --------------------------------------------------------- */
    $history = get_post_meta($user_post_id, 'checkin_history', true);
    $history = $history ? json_decode($history, true) : [];

    if (count($history) >= 30) {
        $history = [];
        update_post_meta($user_post_id, 'checkin_history', json_encode([]));
    }

    $checkins_count = count($history);

    /* ---------------------------------------------------------
        2) MONEY_DIEM_DANH (USD G·ªêC)
    --------------------------------------------------------- */
    $money_raw = get_post_meta($user_post_id, 'money_diem_danh', true);
    $money_usd = is_array($money_raw) ? 0 : (float) ($money_raw ?: 0);

    /* ---------------------------------------------------------
        3) QUY ƒê·ªîI THEO LANGUAGE (KH√îNG ƒê·ªîI LOGIC)
    --------------------------------------------------------- */
    $USD_TO_VND = 20000;
    $USD_TO_IDR = 15000;

    if ($user_lang === 'vi') {
        $money = $money_usd * $USD_TO_VND;
    } elseif ($user_lang === 'id') {
        $money = $money_usd * $USD_TO_IDR;
    } else {
        // en
        $money = $money_usd;
    }

    /* ---------------------------------------------------------
        4) RESPONSE (GI·ªÆ NGUY√äN C·∫§U TR√öC)
    --------------------------------------------------------- */
    return new WP_REST_Response([
        'success'         => true,
        'cycle_days'      => 30,
        'checked_count'   => $checkins_count,
        'money_diem_danh' => $money,
        'language'        => $user_lang
    ], 200);
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/checkin-ok', [
        'methods'  => 'GET',
        'callback' => 'api_checkin_user_only',
        'permission_callback' => '__return_true',
    ]);
});

function api_checkin_user_only(WP_REST_Request $req) {

    $external_id = sanitize_text_field($req->get_param('user_id'));
    $game_id     = 9613;

    if (!$external_id) {
        return ['status'=>'error','message'=>'Missing user_id'];
    }

    // T√¨m user
    $query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'   => 'id',
                'value' => $external_id
            ]
        ]
    ]);

    if (!$query->have_posts()) {
        return ['status'=>'error','message'=>'User not found'];
    }

    $user_post_id = $query->posts[0]->ID;

    // ‚≠ê Check count_value xem ƒë√£ v·ªÅ 0 ch∆∞a
    $play_status_post = get_user_game_status($external_id, $game_id);
    $count_value = intval(get_post_meta($play_status_post, 'count_value', true));

    if ($count_value > 0) {
        return [
            'status'    => 'error',
            'message'   => 'count_value must be 0 before check-in',
            'remaining' => $count_value
        ];
    }

    // ‚≠ê N·∫øu count_value = 0 ‚Üí cho check-in b√¨nh th∆∞·ªùng
    $today = current_time('Y-m-d');

    // L·ªãch s·ª≠ check-in
    $history = get_post_meta($user_post_id, 'checkin_history', true);
    $history = $history ? json_decode($history, true) : [];

    if (count($history) >= 30) {
        $history = [];
    }

    $current_count = count($history);
    $next_checkin_number = $current_count + 1;

    if     ($next_checkin_number <= 10) $today_value = 1;
    elseif ($next_checkin_number <= 27) $today_value = 2;
    else   $today_value = 5;

    $is_new_checkin = false;

    if (!in_array($today, $history)) {
        $history[] = $today;
        update_post_meta($user_post_id, 'checkin_history', json_encode($history));
        $is_new_checkin = true;

        // C·ªông ti·ªÅn
        $current_money = floatval(get_post_meta($user_post_id, 'money_diem_danh', true));
        $current_money += $today_value;
        update_post_meta($user_post_id, 'money_diem_danh', $current_money);

    } else {
        $current_money = floatval(get_post_meta($user_post_id, 'money_diem_danh', true));
    }

    // ‚≠ê‚≠ê‚≠ê RESET COUNT SAU CHECK-IN TH√ÄNH C√îNG ‚≠ê‚≠ê‚≠ê
    update_post_meta($play_status_post, 'count_value', 1800);
    update_post_meta($play_status_post, 'sent_count', 0);
    update_post_meta($play_status_post, 'last_play_date', $today);

    return [
        'status'          => 'success',
        'message'         => 'Check-in successful',
        'today_added'     => $is_new_checkin,
        'added_value'     => $is_new_checkin ? $today_value : 0,
        'money_diem_danh' => $current_money,
        'total_checkins'  => count($history),
        'cycle_limit'     => 30,
        'reset_to'        => 1800   // g·ª≠i th√¥ng tin debug cho client
    ];
}



add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/update-email', [
        'methods'  => 'GET',
        'callback' => 'custom_update_email_user_device',
        'permission_callback' => '__return_true',
    ]);
});

function custom_update_email_user_device($request) {

    $user_id    = sanitize_text_field($request->get_param('user_id'));   // ACF user_id
    $email_user = sanitize_email($request->get_param('email_user'));     // email m·ªõi

    if (empty($user_id) || empty($email_user)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing user_id or email_user'
        ], 400);
    }

    // üîé T√¨m user-mobile theo meta id
    $query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query' => [
            [
                'key'   => 'id',
                'value' => $user_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $post_id = $query->posts[0]->ID;

    // üìù C·∫≠p nh·∫≠t email_user
    update_post_meta($post_id, 'email_user', $email_user);

    return new WP_REST_Response([
        'success'    => true,
        'message'    => 'Email updated successfully',
        'user_id'    => $user_id,
        'email_user' => $email_user
    ], 200);
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/checkin-reward-list', [
        'methods'  => 'GET',
        'callback' => 'api_checkin_reward_list',
        'permission_callback' => '__return_true',
    ]);
});

function api_checkin_reward_list(WP_REST_Request $req) {

    // =============================
    // üîπ USER_ID
    // =============================
    $user_id = sanitize_text_field($req->get_param('user_id')) ?: '';

    // =============================
    // üîπ DEFAULT LANGUAGE
    // =============================
    $user_lang = 'en';

    // =============================
    // üîπ FIND USER ‚Üí GET LANGUAGE
    // =============================
    if ($user_id) {
        $query = new WP_Query([
            'post_type'      => 'user-mobile',
            'posts_per_page' => 1,
            'post_status'    => 'publish',
            'meta_query'     => [
                [
                    'key'     => 'id',
                    'value'   => $user_id,
                    'compare' => '='
                ]
            ]
        ]);

        if ($query->have_posts()) {
            $post_id  = $query->posts[0]->ID;
            $lang_meta = get_post_meta($post_id, 'language', true);
            if (!empty($lang_meta)) {
                $user_lang = $lang_meta;
            }
        }

        wp_reset_postdata();
    }

    // =============================
    // üîπ T·ª∂ GI√Å (GI·ªêNG C√ÅC API KH√ÅC)
    // =============================
    $USD_TO_VND = 20000;
    $USD_TO_IDR = 15000;

    // =============================
    // üîπ REWARD LIST (GI·ªÆ LOGIC)
    // =============================
    $list = [];

    for ($i = 1; $i <= 30; $i++) {

        // LOGIC G·ªêC
        if ($i <= 10) {
            $value = 1;
        } elseif ($i <= 27) {
            $value = 2;
        } else {
            $value = 5;
        }

        // QUY ƒê·ªîI THEO LANGUAGE
        if ($user_lang === 'vi') {
            $value = $value * $USD_TO_VND;
        } elseif ($user_lang === 'id') {
            $value = $value * $USD_TO_IDR;
        }
        // en ‚Üí gi·ªØ nguy√™n

        $list[] = [
            'day_number' => $i,
            'value'      => $value,
        ];
    }

    // =============================
    // üîπ RESPONSE
    // =============================
    return new WP_REST_Response([
        'success'  => true,
        'user_id'  => $user_id,
        'language' => $user_lang,
        'data'     => $list
    ], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/payment-list', [
        'methods'  => 'GET',
        'callback' => 'api_payment_list',
        'permission_callback' => '__return_true',
    ]);
});



function api_payment_list(WP_REST_Request $request) {

    $user_id = sanitize_text_field($request->get_param('user_id'));

    if (empty($user_id)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing user_id',
        ], 400);
    }

    // ================================
    // üîç FIND USER BY ACF ID
    // ================================
    $user_query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$user_query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $user_post = $user_query->posts[0];

    // ================================
    // üåç GET LANGUAGE
    // ================================
    $lang = get_post_meta($user_post->ID, 'language', true)
         ?: get_post_meta($user_post->ID, 'lang', true)
         ?: 'vi';

    $lang = strtolower($lang);

    // ================================
    // üè¶ BENEFICIARY NAME ONLY
    // ================================
   if ($lang === 'vi') {

    $bank = [
        'Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n',
        'Vietcombank (VCB)',
        'BIDV',
        'VietinBank',
        'Agribank',
        'Techcombank',
        'MB Bank',
        'ACB',
        'VPBank',
        'Sacombank',
        'TPBank',
    ];

    } elseif ($lang === 'id') {

        $bank = [
            'Pilih metode pembayaran',
            'DANA',
            'GoPay',
            'OVO',
            'ShopeePay',
            'PULSA',
        ];

    }else {
        $bank = ['PayPal'];
    }

    // ================================
    // ‚úÖ RESPONSE
    // ================================
    return new WP_REST_Response([
        'success'       => true,
        'language'      => $lang,
        'bank' => $bank,
    ], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/payment-update', [
        'methods'  => 'GET',
        'callback' => 'api_payment_update',
        'permission_callback' => '__return_true',
    ]);
});

function api_payment_update(WP_REST_Request $request) {

    $user_id     = sanitize_text_field($request->get_param('user_id'));
    $amount      = sanitize_text_field($request->get_param('amount'));
    $bank        = sanitize_text_field($request->get_param('bank'));
    $acc_bank    = sanitize_text_field($request->get_param('acc_bank'));
    $number_bank = sanitize_text_field($request->get_param('number_bank'));

    // ================================
    // ‚ùå VALIDATE
    // ================================
    if (!$user_id || !$amount || !$bank || !$acc_bank || !$number_bank) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing required parameters'
        ], 400);
    }

    // ================================
    // üîç FIND USER-MOBILE BY ACF ID
    // ================================
    $query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $user_post_id = $query->posts[0]->ID;

    // ================================
    // üíæ SAVE PAYMENT INFO
    // ================================
    update_post_meta($user_post_id, 'payment_amount', $amount);
    update_post_meta($user_post_id, 'payment_bank', $bank);
    update_post_meta($user_post_id, 'payment_acc_bank', $acc_bank);
    update_post_meta($user_post_id, 'payment_number_bank', $number_bank);
    update_post_meta($user_post_id, 'payment_status', 'pending');
    update_post_meta($user_post_id, 'payment_requested_at', current_time('mysql'));

    // ================================
    // ‚úÖ RESPONSE
    // ================================
    return new WP_REST_Response([
        'success' => true,
        'message' => 'Payment info updated',
        'data' => [
            'amount'      => $amount,
            'bank'        => $bank,
            'acc_bank'    => $acc_bank,
            'number_bank' => $number_bank
        ]
    ], 200);
}


add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/payment-text', [
        'methods'  => 'GET',
        'callback' => 'api_payment_text',
        'permission_callback' => '__return_true',
    ]);
});

function api_payment_text(WP_REST_Request $request) {

    $bank = strtoupper(sanitize_text_field($request->get_param('bank')));

    if (empty($bank)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing bank parameter'
        ], 400);
    }

    $map = [

        'DANA' => [
            ['label' => 'Username',     'key' => 'username'],
            ['label' => 'DANA Number',  'key' => 'number'],
        ],

        'GOPAY' => [
            ['label' => 'Username',     'key' => 'username'],
            ['label' => 'GoPay Number', 'key' => 'number'],
        ],

        'OVO' => [
            ['label' => 'Username',   'key' => 'username'],
            ['label' => 'OVO Number', 'key' => 'number'],
        ],

        'SHOPEEPAY' => [
            ['label' => 'Username',        'key' => 'username'],
            ['label' => 'ShopeePay Number','key' => 'number'],
        ],

        'PULSA' => [
            ['label' => 'User Number',   'key' => 'number'],
            ['label' => 'Provider Name', 'key' => 'provider'],
        ],
    ];

    if (!isset($map[$bank])) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Unsupported bank'
        ], 404);
    }

    return new WP_REST_Response([
        'success' => true,
        'bank'    => $bank,
        'fields'  => $map[$bank],
    ], 200);
}

add_action('rest_api_init', function () {
    register_rest_route('custom-api/v1', '/withdraw-amount', [
        'methods'  => 'GET',
        'callback' => 'api_withdraw_amount',
        'permission_callback' => '__return_true',
    ]);
});

function api_withdraw_amount(WP_REST_Request $request) {

    $user_id = sanitize_text_field($request->get_param('user_id'));

    if (empty($user_id)) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Missing user_id'
        ], 400);
    }

    // ================================
    // üîç FIND USER-MOBILE
    // ================================
    $query = new WP_Query([
        'post_type'      => 'user-mobile',
        'posts_per_page' => 1,
        'meta_query'     => [
            [
                'key'     => 'id',
                'value'   => $user_id,
                'compare' => '='
            ]
        ]
    ]);

    if (!$query->have_posts()) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }

    $post_id = $query->posts[0]->ID;

    // ================================
    // üåç GET USER LANGUAGE
    // ================================
    $lang = get_post_meta($post_id, 'language', true)
         ?: get_post_meta($post_id, 'lang', true)
         ?: 'vi';

    $lang = strtolower($lang);

    // ================================
    // üí∞ LIST S·ªê THEO USER
    // ================================
    if ($lang === 'id') {
        $list_amount = [10000, 20000, 50000, 100000, 200000];
        $currency = 'IDR';
    } else {
        $list_amount = [50000, 100000, 200000, 500000, 1000000];
        $currency = 'VND';
    }

    return new WP_REST_Response([
        'success'  => true,
        'language' => $lang,
        'currency' => $currency,
        'list'     => $list_amount
    ], 200);
}
